<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="hugo-theme" content="Axiom 0.8.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/">
  <link rel="icon" type="image/x-icon" href="/">
  <link rel="apple-touch-icon" href="/">
  <link rel="canonical" href="https://rtichoke.netlify.app/post/assessing_score_reliability/">
<link rel="preload" as="style" href="/bundle.css?v=1641649589" media="all">
<link rel="stylesheet" href="/bundle.css?v=1641649589" media="all">
<style>.cdata pre{background-color:#1f2937;color:#e5e7eb}.cdata :not(pre)>code{background-color:#f3f4f6;color:#7c3aed}.chroma .err{background-color:#991b1b;color:#fecaca}.chroma .hl{background-color:#374151}.chroma .ln{color:#9ca3af}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#60a5fa}.chroma .kt{color:#a78bfa}.chroma .na,.chroma .nb{color:#fbbf24}.chroma .nc{color:#f87171}.chroma .no{color:#34d399}.chroma .nd{color:#f87171}.chroma .ne{color:#f87171}.chroma .nf{color:#fbbf24}.chroma .nt{color:#f87171}.chroma .l{color:#a78bfa}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#34d399}.chroma .se{color:#9ca3af}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#34d399}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#a78bfa}.chroma .o,.chroma .ow{color:#93c5fd}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs,.chroma .p{color:#9ca3af}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}
</style>



<title>Using bootstrapped sampling to assess variability in score predictions  : R&#39;tichoke</title>

<meta property="og:title" content="Using bootstrapped sampling to assess variability in score predictions ">
<meta property="og:site_name" content="R&#39;tichoke">
<meta property="og:url" content="https://rtichoke.netlify.app/post/assessing_score_reliability/">
<link rel="image_src" href="https://rtichoke.netlify.app/">
<meta property="og:image" content="https://rtichoke.netlify.app/">
<meta property="og:image:width" content="">
<meta property="og:image:height" content="">
<meta property="og:type" content="article">
<meta property="og:locale" content="en_us">
<meta property="og:description" content="How to assess reliability of a credit scoring model using bootstrapped sampling">
<meta name="description" content="How to assess reliability of a credit scoring model using bootstrapped sampling">
<meta property="og:updated_time" content="2021-09-30T00:00:00Z">
<meta property="fb:app_id" content="">
<meta name="author" content="Riddhiman">
<meta property="article:author" content="https://linkedin.com/in/riddhimanr">
<meta property="article:published_time" content="2021-09-30T00:00:00Z">
<meta property="article:modified_time" content="2021-09-30T00:00:00Z">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "Using bootstrapped sampling to assess variability in score predictions ",
  "alternativeHeadline": "Credit risk series (Post #3)",
  "url": "https://rtichoke.netlify.app/post/assessing_score_reliability/",
  "image": "https://rtichoke.netlify.app/",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://rtichoke.netlify.app/post/assessing_score_reliability/"
  },
  "description": "How to assess reliability of a credit scoring model using bootstrapped sampling",
  "author": {
    "@type": "Person",
    "name": "Riddhiman"
  },
  "publisher": {
    "@type": "Organization",
    "name": "R'tichoke",
    "logo": {
      "@type": "ImageObject",
      "url": "https://rtichoke.netlify.app/"
    }
  },
  "datePublished": "2021-09-30T00:00:00Z",
  "dateModified": "2021-09-30T00:00:00Z",
  "articleBody": "\u003cp\u003eWhen building risk scorecards, apart from the variety of performance metrics, analysts also assess something known as  \u003ccode\u003erisk-ranking\u003c/code\u003e i.e. whether or not the observed event rates increase (or decrease) monotonically with increasing (or decreasing) scores. Sometimes, models are not able to risk-rank borrowers in the tails (regions of very high or very low scores). While this is expected, it would be nice if we could quantify this effect. One way to do this would be to use bootstrapped samples to assess variability in model predictions.\u003c/p\u003e\n\u003ch2 id=\"basic-idea\"\u003eBasic idea\u003c/h2\u003e\n\u003cp\u003eThe underlying idea is very simple - less available data for estimation equates to lower quality of estimation. As a simple example, we can observe this effect when trying to estimate quantiles of a probability distribution.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Number of samples to be drawn from a probability distribution\u003c/span\u003e\nn_samples \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Number of times, sampling should be repeated\u003c/span\u003e\nrepeats \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Mean and std-dev for a standard normal distribution\u003c/span\u003e\nmu \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e\nstd_dev \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Sample\u003c/span\u003e\nsamples \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_samples \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e repeats, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Fit into a matrix like object with `n_samples\u0026#39; number of rows \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# and `repeats` number of columns\u003c/span\u003e\nsamples \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematrix\u003c/span\u003e(samples, nrow \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_samples, ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e repeats)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Compute mean across each column\u003c/span\u003e\nsample_means \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(samples, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, mean)\n\n\u003cspan style=\"color:#75715e\"\u003e# Similarly, compute 75% and 95% quantile across each column\u003c/span\u003e\nsample_75_quantile \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(samples, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, quantile, p \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.75\u003c/span\u003e)\nsample_95_quantile \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(samples, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, quantile, p \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e)\nsample_99_quantile \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapply\u003c/span\u003e(samples, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, quantile, p \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(sample_means)\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(sample_means)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.01023223\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(sample_75_quantile)\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(sample_75_quantile)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.01258346\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(sample_95_quantile)\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(sample_75_quantile)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.01810062\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecombined_vec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(sample_means, sample_75_quantile, sample_95_quantile, sample_99_quantile)\n\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(sample_means), \n     col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#6F69AC\u0026#34;\u003c/span\u003e, \n     lwd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \n     main \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Estimating the mean vs tail quantiles\u0026#34;\u003c/span\u003e, \n     xlab \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e, \n     xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(combined_vec), \u003cspan style=\"color:#a6e22e\"\u003emax\u003c/span\u003e(combined_vec)))\n\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(sample_75_quantile), col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#95DAC1\u0026#34;\u003c/span\u003e, lwd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(sample_95_quantile), col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FFEBA1\u0026#34;\u003c/span\u003e, lwd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(sample_99_quantile), col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FD6F96\u0026#34;\u003c/span\u003e, lwd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003egrid\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003elegend\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;topright\u0026#34;\u003c/span\u003e, \n       fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#6F69AC\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#95DAC1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FFEBA1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FD6F96\u0026#34;\u003c/span\u003e), \n       legend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Mean\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;75% Quantile\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;95% Quantile\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;99% Quantile\u0026#34;\u003c/span\u003e), \n       cex \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.7\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart1-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eIt is easy to notice that the uncertainty in estimating the sample 99% quantile is much higher than the uncertainty in estimating the sample mean. We will now try to extend this idea to a scorecard model.\u003c/p\u003e\n\u003ch2 id=\"libraries\"\u003eLibraries\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e#install.packages(\u0026#34;pacman\u0026#34;)\u003c/span\u003e\npacman\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ep_load\u003c/span\u003e(dplyr, magrittr, rsample, ggplot2)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"sample-data\"\u003eSample data\u003c/h2\u003e\n\u003cp\u003eAs in previous posts, we\u0026rsquo;ll use a small sample \u003ca href=\"https://github.com/royr2/blog/blob/main/download/credit_sample.csv\"\u003e(download here)\u003c/a\u003e of the \u003cstrong\u003eLending Club\u003c/strong\u003e dataset available on \u003ca href=\"https://www.kaggle.com/wordsforthewise/lending-club\"\u003eKaggle\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esample \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;credit_sample.csv\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"creating-a-target\"\u003eCreating a target\u003c/h2\u003e\n\u003cp\u003eThe next step is to create a target (dependent variable) to model for.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Mark which loan status will be tagged as default\u003c/span\u003e\ncodes \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Charged Off\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Does not meet the credit policy. Status:Charged Off\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Apply above codes and create target\u003c/span\u003e\nsample \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(bad_flag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(loan_status \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e codes, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Replace missing values with a default value\u003c/span\u003e\nsample\u003cspan style=\"color:#a6e22e\"\u003e[is.na\u003c/span\u003e(sample)] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Get summary tally\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003etable\u003c/span\u003e(sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebad_flag)\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    0    1 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 8838 1162\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"sampling\"\u003eSampling\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll use \u003ccode\u003ebootstrapped sampling\u003c/code\u003e to create multiple training sets. We will then repeatedly train a model on each training set and assess the variability in volatile model predictions across score ranges. We\u0026rsquo;ll use the \u003ccode\u003ebootstraps()\u003c/code\u003e function in the \u003ccode\u003ersample\u003c/code\u003e package.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create 100 samples\u003c/span\u003e\nboot_sample \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebootstraps\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sample, times \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(boot_sample, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   splits               id          \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;list\u0026gt;               \u0026lt;chr\u0026gt;       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 \u0026lt;split [10000/3692]\u0026gt; Bootstrap001\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 \u0026lt;split [10000/3712]\u0026gt; Bootstrap002\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 \u0026lt;split [10000/3696]\u0026gt; Bootstrap003\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eboot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits[[1]]\n\u003cspan style=\"color:#75715e\"\u003e## \u0026lt;Analysis/Assess/Total\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u0026lt;10000/3692/10000\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEach row represents a separate bootstrapped sample whereas within each sample, there are two sub-samples namely an \u003ccode\u003eanalysis set\u003c/code\u003e and an \u003ccode\u003eassessment set\u003c/code\u003e. To retrieve a bootstrapped sample as a \u003ccode\u003edata.frame\u003c/code\u003e, the package provides two helper functions -  \u003ccode\u003eanalysis()\u003c/code\u003e and \u003ccode\u003eassessment()\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Show the first 5 rows and 5 columns of the first sample\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eanalysis\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits[[1]]) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e .[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e]\n\u003cspan style=\"color:#75715e\"\u003e##         V1        id member_id loan_amnt funded_amnt\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5428 12946  94135798        -1     28000       28000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4019 24972 110418022        -1     20400       20400\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5729   718 144715469        -1     40000       40000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7927 66593 138895956        -1     10000       10000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 9668 62772 107983553        -1      6300        6300\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ca href=\"https://rsample.tidymodels.org/articles/rsample.html\"\u003egetting started\u003c/a\u003e page of the \u003ccode\u003ersample\u003c/code\u003e package has additional information.\u003c/p\u003e\n\u003ch2 id=\"creating-a-modeling-function\"\u003eCreating a modeling function\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll use a simple \u003ccode\u003eglm()\u003c/code\u003e model for illustrative purposes. First, we\u0026rsquo;ll need to create a function that fits such a model to a given dataset\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eglm_model \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df){\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Fit a simple model with a set specification\u003c/span\u003e\n  mdl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(bad_flag \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\n               loan_amnt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e funded_amnt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e annual_inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e delinq_2yrs \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n               inq_last_6mths \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e mths_since_last_delinq \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e fico_range_low \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n               mths_since_last_record \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e revol_util \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e total_pymnt,\n             family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binomial\u0026#34;\u003c/span\u003e,\n             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Return fitted values\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(mdl))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Test the function\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Retrieve a data frame\u003c/span\u003e\ntrain \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eanalysis\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits[[1]])\n\n\u003cspan style=\"color:#75715e\"\u003e# Predict\u003c/span\u003e\npred \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm_model\u003c/span\u003e(train)\n\n\u003cspan style=\"color:#75715e\"\u003e# Check output\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003erange\u003c/span\u003e(pred)  \u003cspan style=\"color:#75715e\"\u003e# Output is on log odds scale\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] -25.618826   1.699397\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"fitting-the-model-repeatedly\"\u003eFitting the model repeatedly\u003c/h2\u003e\n\u003cp\u003eNow we need to fit the model repeatedly on each of the bootstrapped samples and store the fitted values. And since we are using \u003ccode\u003eR\u003c/code\u003e, for-loops are not allowed ðŸ˜†\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# First apply the glm fitting function to each of the sample\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Note the use of lapply\u003c/span\u003e\noutput \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elapply\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits, \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x){\n  train \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eanalysis\u003c/span\u003e(x)\n  pred \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm_model\u003c/span\u003e(train)\n\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(pred)\n})\n\n\u003cspan style=\"color:#75715e\"\u003e# Collate all predictions into a vector \u003c/span\u003e\nboot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edo.call\u003c/span\u003e(c, output)\n\u003cspan style=\"color:#a6e22e\"\u003erange\u003c/span\u003e(boot_preds)\n\u003cspan style=\"color:#75715e\"\u003e## [1] -145.993853    4.115973\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Get outliers\u003c/span\u003e\nq_high \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(boot_preds, \u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)\nq_low \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(boot_preds, \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Truncate the overall distribution to within the lower 1% and upper 1% quantiles\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Doing this since it creates issues later on when scaling the output\u003c/span\u003e\nboot_preds[boot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e q_high] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e q_high\nboot_preds[boot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e q_low] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e q_low\n\n\u003cspan style=\"color:#a6e22e\"\u003erange\u003c/span\u003e(boot_preds)\n\u003cspan style=\"color:#75715e\"\u003e## [1] -5.060861 -0.225235\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Convert to a data frame\u003c/span\u003e\nboot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(pred \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e boot_preds, \n                         id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits), each \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(sample)))\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(boot_preds)\n\u003cspan style=\"color:#75715e\"\u003e##         pred id\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 -3.1242074  1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 -3.5973415  1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 -0.3822420  1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 -2.6574425  1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 -0.7789107  1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 -1.9527129  1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"scaling-model-predictions\"\u003eScaling model predictions\u003c/h2\u003e\n\u003cp\u003eGiven \u003ccode\u003elog-odds\u003c/code\u003e, we can now scale the output and make it look like a credit score. We\u0026rsquo;ll use the industry standard \u003cstrong\u003epoints to double odds\u003c/strong\u003e methodology.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003escaling_func \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(vec, PDO \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, OddsAtAnchor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, Anchor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e700\u003c/span\u003e){\n  beta \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e PDO \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elog\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  alpha \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Anchor \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e PDO \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e OddsAtAnchor\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Simple linear scaling of the log odds\u003c/span\u003e\n  scr \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e alpha \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e beta \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e vec  \n  \n  \u003cspan style=\"color:#75715e\"\u003e# Round off\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(scr, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eboot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003escaling_func\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epred, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e700\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Chart the distribution of predictions across all the samples\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(boot_preds, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scores, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(id))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_density\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_grey\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Predictions from bootstrapped samples\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Density function\u0026#34;\u003c/span\u003e, \n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Predictions (Log odds)\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Density\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart2-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"assessing-variability\"\u003eAssessing variability\u003c/h2\u003e\n\u003cp\u003eNow that we have model predictions for each bootstrapped sample scaled in the form of a score, we can evaluate the variability in these predictions in a visual manner.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create bins using quantiles\u003c/span\u003e\nbreaks \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, length.out \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e))\nboot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebins \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecut\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores, breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunique\u003c/span\u003e(breaks), include.lowest \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Chart standard deviation of model predictions across each score bin\u003c/span\u003e\nboot_preds \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(bins) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(std_dev \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(scores)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e bins, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e std_dev)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#90AACB\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(angle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e90\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Variability in model predictions across samples\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;(measured using standard deviation)\u0026#34;\u003c/span\u003e, \n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Score Range\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Standard Deviation\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"chart3-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAs expected, the model\u0026rsquo;s predictions are more reliable within a certain range of values (700-800) whereas there is significant variability in the model\u0026rsquo;s predictions in the lowest and highest score buckets.\u003c/p\u003e\n\u003ch2 id=\"parting-notes\"\u003eParting notes\u003c/h2\u003e\n\u003cp\u003eWhile the outcome of this experiment is not unexpected, an interesting question could be - should analysts and model users define an \u003cstrong\u003eoperating range\u003c/strong\u003e for their models? In this example, we could set lower and upper limits at \u003ccode\u003e700\u003c/code\u003e and \u003ccode\u003e800\u003c/code\u003e respectively and any borrower receiving a score beyond these thresholds could be assigned a generic value of \u003ccode\u003e700-\u003c/code\u003e or \u003ccode\u003e800+\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThat said, binning features mitigates this to a certain extent since the model cannot generate predictions beyond a certain range of values.\u003c/p\u003e\n\u003ch2 id=\"an-useful-extension\"\u003eAn useful extension\u003c/h2\u003e\n\u003cp\u003e\u003csmall\u003e\u003cem\u003eSpecial thanks to \u003ca href=\"https://disqus.com/by/richardwarnung/\"\u003eRichard Warnung\u003c/a\u003e for his comments\u003c/em\u003e\u003c/small\u003e\u003c/p\u003e\n\u003cp\u003eIn the above analysis, not only did we fit the model repeatedly on different datasets, but we made predictions on different datasets as well. We can remove the effects of the latter if we make predictions on the same test dataset. Here\u0026rsquo;s some code to do this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Create overall training and testing datasets \u003c/span\u003e\nid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esample\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(sample), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(sample)\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, replace \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e F)\n\ntrain_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e sample[id,]\ntest_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e sample[\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eid,]\n\n\u003cspan style=\"color:#75715e\"\u003e# Bootstrapped samples are now pulled only from the overall training dataset\u003c/span\u003e\nboot_sample \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebootstraps\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e train_data, times \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e80\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Using the same function from before but predicting on the same test dataset\u003c/span\u003e\nglm_model \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(train, test){\n  \n  mdl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(bad_flag \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\n               loan_amnt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e funded_amnt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e annual_inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e delinq_2yrs \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n               inq_last_6mths \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e mths_since_last_delinq \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e fico_range_low \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n               mths_since_last_record \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e revol_util \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e total_pymnt,\n             family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binomial\u0026#34;\u003c/span\u003e,\n             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e train)\n  \n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(mdl, newdata \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e test))\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Train and predict repeatedly\u003c/span\u003e\noutput \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elapply\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits, \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x){\n  train \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eanalysis\u003c/span\u003e(x)\n  pred \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm_model\u003c/span\u003e(train, test_data)\n\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(pred)\n})\n\n\u003cspan style=\"color:#75715e\"\u003e# Collate data into a single data.frame\u003c/span\u003e\nboot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edo.call\u003c/span\u003e(c, output)\nboot_preds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(pred \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e boot_preds, \n                         id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(boot_sample\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003esplits), each \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(sample)))\n\nboot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003escaling_func\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epred, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e700\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Forcing scores to a range\u003c/span\u003e\nboot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esapply\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores, min, \u003cspan style=\"color:#ae81ff\"\u003e900\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Bin the outputs for easier charting \u003c/span\u003e\nbreaks \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, length.out \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e))\nboot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ebins \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecut\u003c/span\u003e(boot_preds\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003escores, breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunique\u003c/span\u003e(breaks), include.lowest \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T, right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e T)\n\n\u003cspan style=\"color:#75715e\"\u003e# Chart\u003c/span\u003e\nboot_preds \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(bins) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(std_dev \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(scores)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e bins, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e std_dev)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#90AACB\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(angle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e90\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Variability in model predictions across samples\u0026#34;\u003c/span\u003e, \n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Prediction set is fixed\u0026#34;\u003c/span\u003e, \n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Score Range\u0026#34;\u003c/span\u003e, \n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Standard Deviation\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cem\u003eThoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!\u003c/em\u003e\u003c/p\u003e"
}
</script>

<link rel="preload" as="script" href="/bundle.js?v=1641649589">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://stats.g.doubleclick.net">
<link rel="preconnect" href="https://www.googleadservices.com">
<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1">
<script src="https://www.googletagmanager.com/gtag/js?id=UA-57026003-1"></script>
<script>
  window.dataLayer=window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());
  gtag('config','UA-57026003-1');
</script>

</head>
<body>

  <header id="nav" class="header">
  <div class="ax-l-i max-w-6xl">
    <div class="ax-logo">
      <a class="block" href="/" title="R&#39;tichoke"><span class="font-semibold text-raven-900">R'tichoke</span></a>
    </div>
    <div class="ax-user">
      <a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target="_blank" rel="noopener nofollow" href="https://www.google.com/search?q=site:https://rtichoke.netlify.app/" title="Search">
        <svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923l-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33 0 0 0 2.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>

      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/post/">
        Posts
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/about/">
        About
      </a>
      <a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href="/rbloggers/">
        R-Bloggers
      </a>
    </div>
  </div>

  
  
</header>


  <main>
<div class="default-single">
  <div class="ax-title ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Using bootstrapped sampling to assess variability in score predictions </h1>
      <p class="post-subtitle font-content-sans font-light text-xl text-raven-500 mt-3">Credit risk series (Post #3)</p>

      <div class="ax-meta flex items-center mt-5">
        <div class="flex-grow min-w-0">
          <div class="flex items-center">
  
  <div class="flex-shrink-0">
    <img
    class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300"
    src="data:image/svg&#43;xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI&#43;PHBhdGggZmlsbD0iI2VjZWZmMSIgZD0iTTAgMGgzMnYzMkgweiIvPjxwYXRoIGZpbGw9IiM0NTVhNjQiIGQ9Ik0yOS4zMDUgMjQuNDA3Yy0uNzk1LS42My0xLjc2NS0xLjA4LTIuODE2LTEuM0wyMS40NzYgMjIuMWExLjEzIDEuMTMgMCAwIDEtLjkwNS0xLjEydi0xLjE1Yy4zMjItLjQ1My42MjYtMS4wNTQuOTQ0LTEuNjgyLjI0Ny0uNDg3LjYyLTEuMjIuODA1LTEuNCAxLjAxNS0xLjAyIDEuOTk1LTIuMTY1IDIuMy0zLjY0LjI4My0xLjM4NS4wMDUtMi4xMTItLjMyMi0yLjY5NyAwLTEuNDYtLjA0Ni0zLjI5LS4zOS00LjYyLS4wNC0xLjgtLjM2OC0yLjgxNC0xLjE5LTMuNy0uNTgtLjYzLTEuNDM1LS43NzUtMi4xMjMtLjg5LS4yNy0uMDQ2LS42NDItLjEtLjc4LS4xODNDMTguNTk0LjM0NyAxNy40LjAyNSAxNS45NTIgMGMtMyAuMTIzLTYuNzEgMi4wNC03Ljk1IDUuNDU0LS4zODQgMS4wNC0uMzQ1IDIuNzQ3LS4zMTMgNC4xMmwtLjAzLjgyNWMtLjI5NS41NzYtLjU4NSAxLjMwNy0uMyAyLjY5Ny4zMDIgMS40OCAxLjI4MiAyLjYyNiAyLjMxNSAzLjY2LjE3LjE3NC41NS45MTQuODAyIDEuNDAzbC45NSAxLjY3NXYxLjE1YzAgLjU0Ni0uMzgyIDEuMDE3LS45IDEuMTJMNS41IDIzLjExYy0xLjA0NS4yMjItMi4wMTQuNjctMi44MDcgMS4yOThhMS4xNSAxLjE1IDAgMCAwLS40MjcuODA1IDEuMTQgMS4xNCAwIDAgMCAuMjkzLjg1OUM1Ljk3NSAyOS44MzggMTAuODczIDMyIDE2IDMyczEwLjAyNy0yLjE2IDEzLjQ0LTUuOTNhMS4xNCAxLjE0IDAgMCAwLS4xMzUtMS42NjR6Ii8&#43;PC9zdmc&#43;Cg=="
    alt="">
	</div>
    
  <div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
    <a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target="_blank" rel="noopener nofollow" title="Riddhiman" href="https://linkedin.com/in/riddhimanr">Riddhiman</a>
    <time class="text-sm text-raven-500" datetime="2021-09-30T00:00:00Z">Sep 30, 2021</time>
  </div>
</div>

        </div>
        <div>
          

<div class="flex items-center">
    <a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Using%20bootstrapped%20sampling%20to%20assess%20variability%20in%20score%20predictions%20%20by%20%40%25%21s%28%3cnil%3e%29%20https%3a%2f%2frtichoke.netlify.app%2fpost%2fassessing_score_reliability%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</a>
    <a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2frtichoke.netlify.app%2fpost%2fassessing_score_reliability%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234 0H1.765C.8.001 0 .79 0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766 0 3.284.13 3.726.2v4.32h-2.543c-2.006 0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21 0 30.234 0z"/></svg>
</a>
  
</div>
        </div>
      </div>
    </div>
  </div><div class="ax-content ax-l-o">
    <div class="ax-l-i max-w-4xl">
      <article class="cdata">
<p>When building risk scorecards, apart from the variety of performance metrics, analysts also assess something known as  <code>risk-ranking</code> i.e. whether or not the observed event rates increase (or decrease) monotonically with increasing (or decreasing) scores. Sometimes, models are not able to risk-rank borrowers in the tails (regions of very high or very low scores). While this is expected, it would be nice if we could quantify this effect. One way to do this would be to use bootstrapped samples to assess variability in model predictions.</p>
<h2 id="basic-idea">Basic idea</h2>
<p>The underlying idea is very simple - less available data for estimation equates to lower quality of estimation. As a simple example, we can observe this effect when trying to estimate quantiles of a probability distribution.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Number of samples to be drawn from a probability distribution</span>
n_samples <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>

<span style="color:#75715e"># Number of times, sampling should be repeated</span>
repeats <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">100</span>

<span style="color:#75715e"># Mean and std-dev for a standard normal distribution</span>
mu <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5</span>
std_dev <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>

<span style="color:#75715e"># Sample</span>
samples <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(n_samples <span style="color:#f92672">*</span> repeats, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># Fit into a matrix like object with `n_samples&#39; number of rows </span>
<span style="color:#75715e"># and `repeats` number of columns</span>
samples <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(samples, nrow <span style="color:#f92672">=</span> n_samples, ncol <span style="color:#f92672">=</span> repeats)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Compute mean across each column</span>
sample_means <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(samples, <span style="color:#ae81ff">1</span>, mean)

<span style="color:#75715e"># Similarly, compute 75% and 95% quantile across each column</span>
sample_75_quantile <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(samples, <span style="color:#ae81ff">1</span>, quantile, p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.75</span>)
sample_95_quantile <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(samples, <span style="color:#ae81ff">1</span>, quantile, p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.95</span>)
sample_99_quantile <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">apply</span>(samples, <span style="color:#ae81ff">1</span>, quantile, p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.99</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">sd</span>(sample_means)<span style="color:#f92672">/</span><span style="color:#a6e22e">mean</span>(sample_means)
<span style="color:#75715e">## [1] 0.01023223</span>
<span style="color:#a6e22e">sd</span>(sample_75_quantile)<span style="color:#f92672">/</span><span style="color:#a6e22e">mean</span>(sample_75_quantile)
<span style="color:#75715e">## [1] 0.01258346</span>
<span style="color:#a6e22e">sd</span>(sample_95_quantile)<span style="color:#f92672">/</span><span style="color:#a6e22e">mean</span>(sample_75_quantile)
<span style="color:#75715e">## [1] 0.01810062</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">combined_vec <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(sample_means, sample_75_quantile, sample_95_quantile, sample_99_quantile)

<span style="color:#a6e22e">plot</span>(<span style="color:#a6e22e">density</span>(sample_means), 
     col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#6F69AC&#34;</span>, 
     lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, 
     main <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Estimating the mean vs tail quantiles&#34;</span>, 
     xlab <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, 
     xlim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(combined_vec), <span style="color:#a6e22e">max</span>(combined_vec)))

<span style="color:#a6e22e">lines</span>(<span style="color:#a6e22e">density</span>(sample_75_quantile), col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#95DAC1&#34;</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)
<span style="color:#a6e22e">lines</span>(<span style="color:#a6e22e">density</span>(sample_95_quantile), col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FFEBA1&#34;</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)
<span style="color:#a6e22e">lines</span>(<span style="color:#a6e22e">density</span>(sample_99_quantile), col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FD6F96&#34;</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)
<span style="color:#a6e22e">grid</span>()

<span style="color:#a6e22e">legend</span>(<span style="color:#e6db74">&#34;topright&#34;</span>, 
       fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;#6F69AC&#34;</span>, <span style="color:#e6db74">&#34;#95DAC1&#34;</span>, <span style="color:#e6db74">&#34;#FFEBA1&#34;</span>, <span style="color:#e6db74">&#34;#FD6F96&#34;</span>), 
       legend <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Mean&#34;</span>, <span style="color:#e6db74">&#34;75% Quantile&#34;</span>, <span style="color:#e6db74">&#34;95% Quantile&#34;</span>, <span style="color:#e6db74">&#34;99% Quantile&#34;</span>), 
       cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>)
</code></pre></div><p><img src="chart1-1.png" alt=""></p>
<p>It is easy to notice that the uncertainty in estimating the sample 99% quantile is much higher than the uncertainty in estimating the sample mean. We will now try to extend this idea to a scorecard model.</p>
<h2 id="libraries">Libraries</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e">#install.packages(&#34;pacman&#34;)</span>
pacman<span style="color:#f92672">::</span><span style="color:#a6e22e">p_load</span>(dplyr, magrittr, rsample, ggplot2)
</code></pre></div><h2 id="sample-data">Sample data</h2>
<p>As in previous posts, we&rsquo;ll use a small sample <a href="https://github.com/royr2/blog/blob/main/download/credit_sample.csv">(download here)</a> of the <strong>Lending Club</strong> dataset available on <a href="https://www.kaggle.com/wordsforthewise/lending-club">Kaggle</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sample <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;credit_sample.csv&#34;</span>)
</code></pre></div><h2 id="creating-a-target">Creating a target</h2>
<p>The next step is to create a target (dependent variable) to model for.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Mark which loan status will be tagged as default</span>
codes <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Charged Off&#34;</span>, <span style="color:#e6db74">&#34;Does not meet the credit policy. Status:Charged Off&#34;</span>)

<span style="color:#75715e"># Apply above codes and create target</span>
sample <span style="color:#f92672">%&lt;&gt;%</span> <span style="color:#a6e22e">mutate</span>(bad_flag <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(loan_status <span style="color:#f92672">%in%</span> codes, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>))

<span style="color:#75715e"># Replace missing values with a default value</span>
sample<span style="color:#a6e22e">[is.na</span>(sample)] <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">-1</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Get summary tally</span>
<span style="color:#a6e22e">table</span>(sample<span style="color:#f92672">$</span>bad_flag)
<span style="color:#75715e">## </span>
<span style="color:#75715e">##    0    1 </span>
<span style="color:#75715e">## 8838 1162</span>
</code></pre></div><h2 id="sampling">Sampling</h2>
<p>We&rsquo;ll use <code>bootstrapped sampling</code> to create multiple training sets. We will then repeatedly train a model on each training set and assess the variability in volatile model predictions across score ranges. We&rsquo;ll use the <code>bootstraps()</code> function in the <code>rsample</code> package.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Create 100 samples</span>
boot_sample <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bootstraps</span>(data <span style="color:#f92672">=</span> sample, times <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">head</span>(boot_sample, <span style="color:#ae81ff">3</span>)
<span style="color:#75715e">## # A tibble: 3 x 2</span>
<span style="color:#75715e">##   splits               id          </span>
<span style="color:#75715e">##   &lt;list&gt;               &lt;chr&gt;       </span>
<span style="color:#75715e">## 1 &lt;split [10000/3692]&gt; Bootstrap001</span>
<span style="color:#75715e">## 2 &lt;split [10000/3712]&gt; Bootstrap002</span>
<span style="color:#75715e">## 3 &lt;split [10000/3696]&gt; Bootstrap003</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">boot_sample<span style="color:#f92672">$</span>splits[[1]]
<span style="color:#75715e">## &lt;Analysis/Assess/Total&gt;</span>
<span style="color:#75715e">## &lt;10000/3692/10000&gt;</span>
</code></pre></div><p>Each row represents a separate bootstrapped sample whereas within each sample, there are two sub-samples namely an <code>analysis set</code> and an <code>assessment set</code>. To retrieve a bootstrapped sample as a <code>data.frame</code>, the package provides two helper functions -  <code>analysis()</code> and <code>assessment()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Show the first 5 rows and 5 columns of the first sample</span>
<span style="color:#a6e22e">analysis</span>(boot_sample<span style="color:#f92672">$</span>splits[[1]]) <span style="color:#f92672">%&gt;%</span> .[1<span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>]
<span style="color:#75715e">##         V1        id member_id loan_amnt funded_amnt</span>
<span style="color:#75715e">## 5428 12946  94135798        -1     28000       28000</span>
<span style="color:#75715e">## 4019 24972 110418022        -1     20400       20400</span>
<span style="color:#75715e">## 5729   718 144715469        -1     40000       40000</span>
<span style="color:#75715e">## 7927 66593 138895956        -1     10000       10000</span>
<span style="color:#75715e">## 9668 62772 107983553        -1      6300        6300</span>
</code></pre></div><p>The <a href="https://rsample.tidymodels.org/articles/rsample.html">getting started</a> page of the <code>rsample</code> package has additional information.</p>
<h2 id="creating-a-modeling-function">Creating a modeling function</h2>
<p>We&rsquo;ll use a simple <code>glm()</code> model for illustrative purposes. First, we&rsquo;ll need to create a function that fits such a model to a given dataset</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_model <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df){
  
  <span style="color:#75715e"># Fit a simple model with a set specification</span>
  mdl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm</span>(bad_flag <span style="color:#f92672">~</span>
               loan_amnt <span style="color:#f92672">+</span> funded_amnt <span style="color:#f92672">+</span> annual_inc <span style="color:#f92672">+</span> delinq_2yrs <span style="color:#f92672">+</span>
               inq_last_6mths <span style="color:#f92672">+</span> mths_since_last_delinq <span style="color:#f92672">+</span> fico_range_low <span style="color:#f92672">+</span>
               mths_since_last_record <span style="color:#f92672">+</span> revol_util <span style="color:#f92672">+</span> total_pymnt,
             family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;binomial&#34;</span>,
             data <span style="color:#f92672">=</span> df)
  
  <span style="color:#75715e"># Return fitted values</span>
  <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">predict</span>(mdl))
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Test the function</span>

<span style="color:#75715e"># Retrieve a data frame</span>
train <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">analysis</span>(boot_sample<span style="color:#f92672">$</span>splits[[1]])

<span style="color:#75715e"># Predict</span>
pred <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm_model</span>(train)

<span style="color:#75715e"># Check output</span>
<span style="color:#a6e22e">range</span>(pred)  <span style="color:#75715e"># Output is on log odds scale</span>
<span style="color:#75715e">## [1] -25.618826   1.699397</span>
</code></pre></div><h2 id="fitting-the-model-repeatedly">Fitting the model repeatedly</h2>
<p>Now we need to fit the model repeatedly on each of the bootstrapped samples and store the fitted values. And since we are using <code>R</code>, for-loops are not allowed ðŸ˜†</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># First apply the glm fitting function to each of the sample</span>
<span style="color:#75715e"># Note the use of lapply</span>
output <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lapply</span>(boot_sample<span style="color:#f92672">$</span>splits, <span style="color:#a6e22e">function</span>(x){
  train <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">analysis</span>(x)
  pred <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm_model</span>(train)

  <span style="color:#a6e22e">return</span>(pred)
})

<span style="color:#75715e"># Collate all predictions into a vector </span>
boot_preds <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">do.call</span>(c, output)
<span style="color:#a6e22e">range</span>(boot_preds)
<span style="color:#75715e">## [1] -145.993853    4.115973</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Get outliers</span>
q_high <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">quantile</span>(boot_preds, <span style="color:#ae81ff">0.99</span>)
q_low <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">quantile</span>(boot_preds, <span style="color:#ae81ff">0.01</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Truncate the overall distribution to within the lower 1% and upper 1% quantiles</span>
<span style="color:#75715e"># Doing this since it creates issues later on when scaling the output</span>
boot_preds[boot_preds <span style="color:#f92672">&gt;</span> q_high] <span style="color:#f92672">&lt;-</span> q_high
boot_preds[boot_preds <span style="color:#f92672">&lt;</span> q_low] <span style="color:#f92672">&lt;-</span> q_low

<span style="color:#a6e22e">range</span>(boot_preds)
<span style="color:#75715e">## [1] -5.060861 -0.225235</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Convert to a data frame</span>
boot_preds <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(pred <span style="color:#f92672">=</span> boot_preds, 
                         id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">length</span>(boot_sample<span style="color:#f92672">$</span>splits), each <span style="color:#f92672">=</span> <span style="color:#a6e22e">nrow</span>(sample)))
<span style="color:#a6e22e">head</span>(boot_preds)
<span style="color:#75715e">##         pred id</span>
<span style="color:#75715e">## 1 -3.1242074  1</span>
<span style="color:#75715e">## 2 -3.5973415  1</span>
<span style="color:#75715e">## 3 -0.3822420  1</span>
<span style="color:#75715e">## 4 -2.6574425  1</span>
<span style="color:#75715e">## 5 -0.7789107  1</span>
<span style="color:#75715e">## 6 -1.9527129  1</span>
</code></pre></div><h2 id="scaling-model-predictions">Scaling model predictions</h2>
<p>Given <code>log-odds</code>, we can now scale the output and make it look like a credit score. We&rsquo;ll use the industry standard <strong>points to double odds</strong> methodology.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">scaling_func <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(vec, PDO <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, OddsAtAnchor <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, Anchor <span style="color:#f92672">=</span> <span style="color:#ae81ff">700</span>){
  beta <span style="color:#f92672">&lt;-</span> PDO <span style="color:#f92672">/</span> <span style="color:#a6e22e">log</span>(<span style="color:#ae81ff">2</span>)
  alpha <span style="color:#f92672">&lt;-</span> Anchor <span style="color:#f92672">-</span> PDO <span style="color:#f92672">*</span> OddsAtAnchor
  
  <span style="color:#75715e"># Simple linear scaling of the log odds</span>
  scr <span style="color:#f92672">&lt;-</span> alpha <span style="color:#f92672">-</span> beta <span style="color:#f92672">*</span> vec  
  
  <span style="color:#75715e"># Round off</span>
  <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">round</span>(scr, <span style="color:#ae81ff">0</span>))
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">boot_preds<span style="color:#f92672">$</span>scores <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">scaling_func</span>(boot_preds<span style="color:#f92672">$</span>pred, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">700</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Chart the distribution of predictions across all the samples</span>
<span style="color:#a6e22e">ggplot</span>(boot_preds, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> scores, color <span style="color:#f92672">=</span> <span style="color:#a6e22e">factor</span>(id))) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_density</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">scale_color_grey</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Predictions from bootstrapped samples&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Density function&#34;</span>, 
       x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Predictions (Log odds)&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Density&#34;</span>)
</code></pre></div><p><img src="chart2-1.png" alt=""></p>
<h2 id="assessing-variability">Assessing variability</h2>
<p>Now that we have model predictions for each bootstrapped sample scaled in the form of a score, we can evaluate the variability in these predictions in a visual manner.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Create bins using quantiles</span>
breaks <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">quantile</span>(boot_preds<span style="color:#f92672">$</span>scores, probs <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, length.out <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>))
boot_preds<span style="color:#f92672">$</span>bins <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(boot_preds<span style="color:#f92672">$</span>scores, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">unique</span>(breaks), include.lowest <span style="color:#f92672">=</span> T, right <span style="color:#f92672">=</span> T)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Chart standard deviation of model predictions across each score bin</span>
boot_preds <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(bins) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarise</span>(std_dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(scores)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> bins, y <span style="color:#f92672">=</span> std_dev)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#90AACB&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(axis.text.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(angle <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Variability in model predictions across samples&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;(measured using standard deviation)&#34;</span>, 
       x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Score Range&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Standard Deviation&#34;</span>)
</code></pre></div><p><img src="chart3-1.png" alt=""></p>
<p>As expected, the model&rsquo;s predictions are more reliable within a certain range of values (700-800) whereas there is significant variability in the model&rsquo;s predictions in the lowest and highest score buckets.</p>
<h2 id="parting-notes">Parting notes</h2>
<p>While the outcome of this experiment is not unexpected, an interesting question could be - should analysts and model users define an <strong>operating range</strong> for their models? In this example, we could set lower and upper limits at <code>700</code> and <code>800</code> respectively and any borrower receiving a score beyond these thresholds could be assigned a generic value of <code>700-</code> or <code>800+</code>.</p>
<p>That said, binning features mitigates this to a certain extent since the model cannot generate predictions beyond a certain range of values.</p>
<h2 id="an-useful-extension">An useful extension</h2>
<p><small><em>Special thanks to <a href="https://disqus.com/by/richardwarnung/">Richard Warnung</a> for his comments</em></small></p>
<p>In the above analysis, not only did we fit the model repeatedly on different datasets, but we made predictions on different datasets as well. We can remove the effects of the latter if we make predictions on the same test dataset. Here&rsquo;s some code to do this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">
<span style="color:#75715e"># Create overall training and testing datasets </span>
id <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sample</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">nrow</span>(sample), size <span style="color:#f92672">=</span> <span style="color:#a6e22e">nrow</span>(sample)<span style="color:#f92672">*</span><span style="color:#ae81ff">0.8</span>, replace <span style="color:#f92672">=</span> F)

train_data <span style="color:#f92672">&lt;-</span> sample[id,]
test_data <span style="color:#f92672">&lt;-</span> sample[<span style="color:#f92672">-</span>id,]

<span style="color:#75715e"># Bootstrapped samples are now pulled only from the overall training dataset</span>
boot_sample <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bootstraps</span>(data <span style="color:#f92672">=</span> train_data, times <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>)

<span style="color:#75715e"># Using the same function from before but predicting on the same test dataset</span>
glm_model <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(train, test){
  
  mdl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm</span>(bad_flag <span style="color:#f92672">~</span>
               loan_amnt <span style="color:#f92672">+</span> funded_amnt <span style="color:#f92672">+</span> annual_inc <span style="color:#f92672">+</span> delinq_2yrs <span style="color:#f92672">+</span>
               inq_last_6mths <span style="color:#f92672">+</span> mths_since_last_delinq <span style="color:#f92672">+</span> fico_range_low <span style="color:#f92672">+</span>
               mths_since_last_record <span style="color:#f92672">+</span> revol_util <span style="color:#f92672">+</span> total_pymnt,
             family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;binomial&#34;</span>,
             data <span style="color:#f92672">=</span> train)
  
  <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">predict</span>(mdl, newdata <span style="color:#f92672">=</span> test))
}

<span style="color:#75715e"># Train and predict repeatedly</span>
output <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lapply</span>(boot_sample<span style="color:#f92672">$</span>splits, <span style="color:#a6e22e">function</span>(x){
  train <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">analysis</span>(x)
  pred <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm_model</span>(train, test_data)

  <span style="color:#a6e22e">return</span>(pred)
})

<span style="color:#75715e"># Collate data into a single data.frame</span>
boot_preds <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">do.call</span>(c, output)
boot_preds <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(pred <span style="color:#f92672">=</span> boot_preds, 
                         id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">length</span>(boot_sample<span style="color:#f92672">$</span>splits), each <span style="color:#f92672">=</span> <span style="color:#a6e22e">nrow</span>(sample)))

boot_preds<span style="color:#f92672">$</span>scores <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">scaling_func</span>(boot_preds<span style="color:#f92672">$</span>pred, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">700</span>)

<span style="color:#75715e"># Forcing scores to a range</span>
boot_preds<span style="color:#f92672">$</span>scores <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sapply</span>(boot_preds<span style="color:#f92672">$</span>scores, min, <span style="color:#ae81ff">900</span>)

<span style="color:#75715e"># Bin the outputs for easier charting </span>
breaks <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">quantile</span>(boot_preds<span style="color:#f92672">$</span>scores, probs <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, length.out <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>))
boot_preds<span style="color:#f92672">$</span>bins <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cut</span>(boot_preds<span style="color:#f92672">$</span>scores, breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">unique</span>(breaks), include.lowest <span style="color:#f92672">=</span> T, right <span style="color:#f92672">=</span> T)

<span style="color:#75715e"># Chart</span>
boot_preds <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(bins) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarise</span>(std_dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(scores)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> bins, y <span style="color:#f92672">=</span> std_dev)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#90AACB&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(axis.text.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(angle <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>)) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Variability in model predictions across samples&#34;</span>, 
       subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction set is fixed&#34;</span>, 
       x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Score Range&#34;</span>, 
       y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Standard Deviation&#34;</span>)
</code></pre></div><p><em>Thoughts? Comments? Helpful? Not helpful? Like to see anything else added in here? Let me know!</em></p>

      </article>
      

      
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
  this.page.url = "https://rtichoke.netlify.app/post/assessing_score_reliability/";
  this.page.identifier = "4eef379e9baa5714d4e66c3592b4cda5";
  this.page.title = "Using bootstrapped sampling to assess variability in score predictions ";
};

(function() {
  window.setTimeout(function() {
    var d = document;
    var s = d.createElement('script');
    s.src = 'https://rtichoke.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    s.setAttribute("defer", "");
    d.body.appendChild(s);
  }, 2500);
})();
</script>

    </div>
  </div>
</div>

  </main>
  <footer class="footer">
  <div class="ax-l-i max-w-6xl">
    <nav class="flex items-center justify-center">
    </nav>
    <div class="footer-social flex items-center justify-center mt-4">
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="Twitter" href="https://twitter.com/r0yr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11 0 0 1-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56 0 0 0-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57 0 0 0 2.914 5.452 6.48 6.48 0 0 1-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42 0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18 0 0 1-8.134 2.798c-.538 0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072 0 18.672-10 18.672-18.668 0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="GitHub" href="https://github.com/royr2"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998 0C7.164 0 0 7.35 0 16.417 0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113 0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344 0 0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98 0 0 1 4.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406 0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836 0 15.998 0z"/></svg></a>
      <a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target="_blank" rel="noopener nofollow" title="LinkedIn" href="https://www.linkedin.com/in/riddhimanr"><svg class="fill-current" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692 0H2.308A2.31 2.31 0 0 0 0 2.308v27.384A2.31 2.31 0 0 0 2.308 32h27.384A2.31 2.31 0 0 0 32 29.692V2.308A2.31 2.31 0 0 0 29.692 0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308 0-2.153-.9-2.153-2.025 0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076 0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564 0 4.486 1.676 4.486 5.276v6.722z"/></svg></a>
    </div>

    <div class="footer-copyright text-sm text-center text-gray-400 mt-4">
      &#169; 2021-2022 R&#39;tichoke
    </div>
    <div class="text-sm sm:text-xs text-center text-gray-400 mt-2">
      Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a>
    </div>
  </div>
</footer>

<script src="/bundle.js?v=1641649589"></script>


</body>
</html>
