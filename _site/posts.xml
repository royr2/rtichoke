<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>R&#39;tichoke</title>
<link>https://rtichoke.netlify.app/posts.html</link>
<atom:link href="https://rtichoke.netlify.app/posts.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.6.42</generator>
<lastBuildDate>Sat, 10 May 2025 18:30:00 GMT</lastBuildDate>
<item>
  <title>Multi-Task Learning with torch in R</title>
  <link>https://rtichoke.netlify.app/posts/multi-task-learning-with-torch.html</link>
  <description><![CDATA[ 




<p>Multi-task learning (MTL) is an approach where a single neural network model is trained to perform multiple related tasks simultaneously. This methodology can improve model generalization, reduce overfitting, and leverage shared information across tasks. This post explores how to implement a multi-task learning model using the <code>torch</code> package in R.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Multi-task learning operates by sharing representations between related tasks, enabling models to generalize more effectively. Instead of training separate models for each task, this approach develops a single model with:</p>
<ul>
<li><strong>Shared layers</strong> that learn common features across tasks</li>
<li><strong>Task-specific layers</strong> that specialize for each individual task<br>
</li>
<li><strong>Multiple loss functions</strong>, one for each task</li>
</ul>
<p>This approach is particularly valuable when dealing with related prediction problems that can benefit from shared feature representations.</p>
</section>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages(c("torch", "tidyverse", "corrplot"))</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(torch)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
</div>
</section>
<section id="creating-a-mtl-model" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-mtl-model">Creating a MTL Model</h2>
<p>The implementation will construct a model that simultaneously performs two related tasks:</p>
<ol type="1">
<li><strong>Regression</strong>: Predicting a continuous value</li>
<li><strong>Classification</strong>: Predicting a binary outcome</li>
</ol>
<section id="sample-data" class="level3">
<h3 class="anchored" data-anchor-id="sample-data">Sample Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set seed for reproducibility</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb2-5">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a dataset with 5 features</span></span>
<span id="cb2-8">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task 1 (Regression): Predict continuous value</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a target that's a function of the input features plus some noise</span></span>
<span id="cb2-12">y_regression <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task 2 (Classification): Predict binary outcome</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a classification target based on a nonlinear combination of features</span></span>
<span id="cb2-16">logits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span></span>
<span id="cb2-17">y_classification <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (logits <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">to</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_float</span>())</span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split into training (70%) and testing (30%) sets</span></span>
<span id="cb2-20">train_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n)</span>
<span id="cb2-21">test_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n</span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training data</span></span>
<span id="cb2-24">x_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[train_idx, ]</span>
<span id="cb2-25">y_reg_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_regression[train_idx]</span>
<span id="cb2-26">y_cls_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_classification[train_idx]</span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Testing data</span></span>
<span id="cb2-29">x_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[test_idx, ]</span>
<span id="cb2-30">y_reg_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_regression[test_idx]</span>
<span id="cb2-31">y_cls_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_classification[test_idx]</span></code></pre></div>
</div>
</section>
<section id="define-the-multi-task-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="define-the-multi-task-neural-network">Define the Multi-Task Neural Network</h3>
<p>The architecture design creates a neural network with shared layers and task-specific branches:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the multi-task neural network</span></span>
<span id="cb3-2">multi_task_net <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_module</span>(</span>
<span id="cb3-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MultiTaskNet"</span>,</span>
<span id="cb3-4">  </span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initialize =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(input_size, </span>
<span id="cb3-6">                        hidden_size, </span>
<span id="cb3-7">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reg_output_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb3-8">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cls_output_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb3-9">    </span>
<span id="cb3-10">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>input_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> input_size</span>
<span id="cb3-11">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hidden_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hidden_size</span>
<span id="cb3-12">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>reg_output_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reg_output_size</span>
<span id="cb3-13">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cls_output_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cls_output_size</span>
<span id="cb3-14">    </span>
<span id="cb3-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shared layers - these learn representations useful for both tasks</span></span>
<span id="cb3-16">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shared_layer1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(input_size, hidden_size)</span>
<span id="cb3-17">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shared_layer2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(hidden_size, hidden_size)</span>
<span id="cb3-18">    </span>
<span id="cb3-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task-specific layers</span></span>
<span id="cb3-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regression branch</span></span>
<span id="cb3-21">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>regression_layer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(hidden_size, reg_output_size)</span>
<span id="cb3-22">    </span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Classification branch</span></span>
<span id="cb3-24">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>classification_layer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(hidden_size, cls_output_size)</span>
<span id="cb3-25">  },</span>
<span id="cb3-26">  </span>
<span id="cb3-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">forward =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb3-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shared feature extraction</span></span>
<span id="cb3-29">    shared_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-30">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">shared_layer1</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-31">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_relu</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-32">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">shared_layer2</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-33">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_relu</span>()</span>
<span id="cb3-34">    </span>
<span id="cb3-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task-specific predictions</span></span>
<span id="cb3-36">    regression_output <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">regression_layer</span>(shared_features)</span>
<span id="cb3-37">    classification_logits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classification_layer</span>(shared_features)</span>
<span id="cb3-38">    </span>
<span id="cb3-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-40">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regression =</span> regression_output,</span>
<span id="cb3-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">classification =</span> classification_logits</span>
<span id="cb3-42">    )</span>
<span id="cb3-43">  }</span>
<span id="cb3-44">)</span>
<span id="cb3-45"></span>
<span id="cb3-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create model instance</span></span>
<span id="cb3-47">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multi_task_net</span>(</span>
<span id="cb3-48">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">input_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb3-49">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hidden_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb3-50">)</span>
<span id="cb3-51"></span>
<span id="cb3-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print model architecture</span></span>
<span id="cb3-53"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 192 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• shared_layer1: &lt;nn_linear&gt; #60 parameters
• shared_layer2: &lt;nn_linear&gt; #110 parameters
• regression_layer: &lt;nn_linear&gt; #11 parameters
• classification_layer: &lt;nn_linear&gt; #11 parameters</code></pre>
</div>
</div>
</section>
<section id="define-loss-functions-and-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="define-loss-functions-and-optimizer">4. Define Loss Functions and Optimizer</h3>
<p>Multi-task learning requires separate loss functions for each task.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loss functions</span></span>
<span id="cb5-2">regression_loss_fn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nnf_mse_loss  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean squared error for regression</span></span>
<span id="cb5-3">classification_loss_fn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nnf_binary_cross_entropy_with_logits  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Binary cross-entropy for classification</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optimizer with weight decay for L2 regularization</span></span>
<span id="cb5-6">optimizer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lr =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task weights - these control the relative importance of each task</span></span>
<span id="cb5-9">task_weights <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regression =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">classification =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation split from training data</span></span>
<span id="cb5-12">val_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(train_idx))</span>
<span id="cb5-13">val_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(train_idx, val_size)</span>
<span id="cb5-14">train_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(train_idx, val_indices)</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create validation sets</span></span>
<span id="cb5-17">x_val <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[val_indices, ]</span>
<span id="cb5-18">y_reg_val <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_regression[val_indices]</span>
<span id="cb5-19">y_cls_val <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_classification[val_indices]</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update training sets</span></span>
<span id="cb5-22">x_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x[train_indices, ]</span>
<span id="cb5-23">y_reg_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_regression[train_indices]</span>
<span id="cb5-24">y_cls_train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_classification[train_indices]</span></code></pre></div>
</div>
</section>
<section id="training-loop" class="level3">
<h3 class="anchored" data-anchor-id="training-loop">Training Loop</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hyperparameters</span></span>
<span id="cb6-2">epochs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Increased epochs since we have early stopping</span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enhanced training history tracking</span></span>
<span id="cb6-5">training_history <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">epoch =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_reg_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_cls_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_total_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_reg_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_cls_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_total_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(),</span>
<span id="cb6-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_accuracy =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>()</span>
<span id="cb6-14">)</span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>epochs) {</span>
<span id="cb6-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training phase</span></span>
<span id="cb6-18">  model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>()</span>
<span id="cb6-19">  optimizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb6-20">  </span>
<span id="cb6-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forward pass on training data</span></span>
<span id="cb6-22">  outputs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_train)</span>
<span id="cb6-23">  </span>
<span id="cb6-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate training loss for each task</span></span>
<span id="cb6-25">  train_reg_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">regression_loss_fn</span>(</span>
<span id="cb6-26">    outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>regression<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>(), </span>
<span id="cb6-27">    y_reg_train</span>
<span id="cb6-28">  )</span>
<span id="cb6-29">  </span>
<span id="cb6-30">  train_cls_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classification_loss_fn</span>(</span>
<span id="cb6-31">    outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>classification<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>(), </span>
<span id="cb6-32">    y_cls_train</span>
<span id="cb6-33">  )</span>
<span id="cb6-34">  </span>
<span id="cb6-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weighted combined training loss</span></span>
<span id="cb6-36">  train_total_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> task_weights[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"regression"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> train_reg_loss <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-37">    task_weights[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> train_cls_loss</span>
<span id="cb6-38">  </span>
<span id="cb6-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Backward pass and optimize</span></span>
<span id="cb6-40">  train_total_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb6-41">  </span>
<span id="cb6-42">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gradient clipping to prevent exploding gradients</span></span>
<span id="cb6-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_utils_clip_grad_norm_</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_norm =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb6-44">  </span>
<span id="cb6-45">  optimizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()</span>
<span id="cb6-46">  </span>
<span id="cb6-47">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation phase</span></span>
<span id="cb6-48">  model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb6-49">  </span>
<span id="cb6-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb6-51">    val_outputs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_val)</span>
<span id="cb6-52">    </span>
<span id="cb6-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate validation losses</span></span>
<span id="cb6-54">    val_reg_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">regression_loss_fn</span>(</span>
<span id="cb6-55">      val_outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>regression<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>(), </span>
<span id="cb6-56">      y_reg_val</span>
<span id="cb6-57">    )</span>
<span id="cb6-58">    </span>
<span id="cb6-59">    val_cls_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classification_loss_fn</span>(</span>
<span id="cb6-60">      val_outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>classification<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>(), </span>
<span id="cb6-61">      y_cls_val</span>
<span id="cb6-62">    )</span>
<span id="cb6-63">    </span>
<span id="cb6-64">    val_total_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> task_weights[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"regression"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> val_reg_loss <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> task_weights[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> val_cls_loss</span>
<span id="cb6-65">    </span>
<span id="cb6-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate validation accuracy</span></span>
<span id="cb6-67">    val_cls_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_sigmoid</span>(val_outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>classification<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb6-68">    val_cls_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (val_cls_probs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">to</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_int</span>())</span>
<span id="cb6-69">    val_accuracy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (val_cls_preds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y_cls_val<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">to</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_int</span>()))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(val_indices)</span>
<span id="cb6-70">  })</span>
<span id="cb6-71">  </span>
<span id="cb6-72">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Record history</span></span>
<span id="cb6-73">  training_history <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(</span>
<span id="cb6-74">    training_history,</span>
<span id="cb6-75">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb6-76">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">epoch =</span> epoch,</span>
<span id="cb6-77">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_reg_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(train_reg_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-78">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_cls_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(train_cls_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-79">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">train_total_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(train_total_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-80">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_reg_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(val_reg_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-81">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_cls_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(val_cls_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-82">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_total_loss =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(val_total_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()),</span>
<span id="cb6-83">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val_accuracy =</span> val_accuracy</span>
<span id="cb6-84">    )</span>
<span id="cb6-85">  )</span>
<span id="cb6-86">  </span>
<span id="cb6-87">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print progress every 25 epochs</span></span>
<span id="cb6-88">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb6-89">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch %d - Train Loss: %.4f, Val Loss: %.4f, Val Acc: %.3f</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, </span>
<span id="cb6-90">                epoch, </span>
<span id="cb6-91">                train_total_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), </span>
<span id="cb6-92">                val_total_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), </span>
<span id="cb6-93">                val_accuracy))</span>
<span id="cb6-94">  }</span>
<span id="cb6-95"></span>
<span id="cb6-96">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1 - Train Loss: 0.7958, Val Loss: 0.7369, Val Acc: 0.493
Epoch 25 - Train Loss: 0.3267, Val Loss: 0.3035, Val Acc: 0.821
Epoch 50 - Train Loss: 0.1548, Val Loss: 0.1350, Val Acc: 0.971
Epoch 75 - Train Loss: 0.0599, Val Loss: 0.0479, Val Acc: 0.993
Epoch 100 - Train Loss: 0.0381, Val Loss: 0.0356, Val Acc: 1.000</code></pre>
</div>
</div>
</section>
<section id="model-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set model to evaluation mode</span></span>
<span id="cb8-2">model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make predictions on test set</span></span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb8-6">  outputs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_test)</span>
<span id="cb8-7">  </span>
<span id="cb8-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regression evaluation</span></span>
<span id="cb8-9">  reg_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>regression<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>()</span>
<span id="cb8-10">  reg_test_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">regression_loss_fn</span>(reg_preds, y_reg_test)</span>
<span id="cb8-11">  </span>
<span id="cb8-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Classification evaluation</span></span>
<span id="cb8-13">  cls_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>classification<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>()</span>
<span id="cb8-14">  cls_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_sigmoid</span>(cls_preds)</span>
<span id="cb8-15">  cls_test_loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classification_loss_fn</span>(cls_preds, y_cls_test)</span>
<span id="cb8-16">  </span>
<span id="cb8-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert predictions to binary (threshold = 0.5)</span></span>
<span id="cb8-18">  cls_pred_labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (cls_probs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">to</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_int</span>())</span>
<span id="cb8-19">  </span>
<span id="cb8-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate accuracy</span></span>
<span id="cb8-21">  accuracy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (cls_pred_labels <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> y_cls_test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">to</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_int</span>()))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(test_idx)</span>
<span id="cb8-22">})</span>
<span id="cb8-23"></span>
<span id="cb8-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate additional metrics</span></span>
<span id="cb8-25">reg_preds_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(reg_preds)</span>
<span id="cb8-26">y_reg_test_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_reg_test)</span>
<span id="cb8-27">cls_probs_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(cls_probs)</span>
<span id="cb8-28">y_cls_test_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_cls_test)</span>
<span id="cb8-29"></span>
<span id="cb8-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regression metrics</span></span>
<span id="cb8-31">rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((reg_preds_r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_reg_test_r)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb8-32">mae <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(reg_preds_r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_reg_test_r))</span>
<span id="cb8-33">r_squared <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(reg_preds_r, y_reg_test_r)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb8-34"></span>
<span id="cb8-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Classification metrics</span></span>
<span id="cb8-36">auc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pROC<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">auc</span>(pROC<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">roc</span>(y_cls_test_r, cls_probs_r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb8-37"></span>
<span id="cb8-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display results</span></span>
<span id="cb8-39">performance_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb8-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Task =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Regression"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Regression"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Regression"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification"</span>),</span>
<span id="cb8-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Metric =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test Loss (MSE)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RMSE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R-squared"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Test Loss (BCE)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AUC"</span>),</span>
<span id="cb8-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb8-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(reg_test_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb8-44">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(rmse, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb8-45">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(r_squared, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb8-46">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(cls_test_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb8-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(accuracy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb8-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(auc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-49">  )</span>
<span id="cb8-50">)</span>
<span id="cb8-51"></span>
<span id="cb8-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(performance_results)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Task          Metric   Value
1     Regression Test Loss (MSE)  0.0533
2     Regression            RMSE  0.2308
3     Regression       R-squared  0.9449
4 Classification Test Loss (BCE)  0.0492
5 Classification        Accuracy 98.0000
6 Classification             AUC 99.9400</code></pre>
</div>
</div>
</section>
<section id="visualization-and-overfitting-analysis" class="level3">
<h3 class="anchored" data-anchor-id="visualization-and-overfitting-analysis">Visualization and Overfitting Analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot enhanced training history with overfitting detection</span></span>
<span id="cb10-2">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> training_history <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(epoch, train_total_loss, val_total_loss) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(train_total_loss, val_total_loss), </span>
<span id="cb10-5">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loss"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-7">    split <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train_total_loss"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training"</span>,</span>
<span id="cb10-8">    split <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"val_total_loss"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Validation"</span></span>
<span id="cb10-9">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> loss, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> split)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>val_total_loss), </span>
<span id="cb10-13">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training vs Validation Loss"</span>,</span>
<span id="cb10-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Red line shows optimal stopping point"</span>,</span>
<span id="cb10-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total Loss"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dataset"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>)</span>
<span id="cb10-19"></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Separate task losses</span></span>
<span id="cb10-21">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> training_history <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(epoch, train_reg_loss, val_reg_loss, train_cls_loss, val_cls_loss) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metric"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loss"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate</span>(metric, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">into =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"task"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loss_type"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(split <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Validation"</span>),</span>
<span id="cb10-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">task =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(task <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Regression"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification"</span>),</span>
<span id="cb10-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(split, task)</span>
<span id="cb10-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> loss, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> metric_name)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>task, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Task-Specific Loss Curves"</span>,</span>
<span id="cb10-34">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monitoring overfitting in individual tasks"</span>,</span>
<span id="cb10-35">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Split &amp; Task"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>)</span>
<span id="cb10-38"></span>
<span id="cb10-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation accuracy progression</span></span>
<span id="cb10-40">p3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(training_history, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> val_accuracy)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2c3e50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>val_accuracy), </span>
<span id="cb10-43">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Validation Accuracy Progression"</span>,</span>
<span id="cb10-45">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Peak accuracy:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>val_accuracy), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)),</span>
<span id="cb10-46">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Validation Accuracy"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb10-48"></span>
<span id="cb10-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Overfitting analysis</span></span>
<span id="cb10-50">training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>overfitting_gap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>train_total_loss <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> training_history<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>val_total_loss</span>
<span id="cb10-51"></span>
<span id="cb10-52">p4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(training_history, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> overfitting_gap)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overfitting Gap Analysis"</span>,</span>
<span id="cb10-56">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Difference between training and validation loss"</span>,</span>
<span id="cb10-57">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training Loss - Validation Loss"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb10-59"></span>
<span id="cb10-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regression predictions vs actual values</span></span>
<span id="cb10-61">regression_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb10-62">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Actual =</span> y_reg_test_r,</span>
<span id="cb10-63">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Predicted =</span> reg_preds_r</span>
<span id="cb10-64">)</span>
<span id="cb10-65"></span>
<span id="cb10-66">p5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(regression_results, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Actual, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Predicted)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-67">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2c3e50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3498db"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-70">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Regression Task: Actual vs Predicted Values"</span>,</span>
<span id="cb10-71">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R² ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(r_squared, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", RMSE ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(rmse, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)),</span>
<span id="cb10-72">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual Values"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Values"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb10-74"></span>
<span id="cb10-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Classification probability distribution</span></span>
<span id="cb10-76">cls_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb10-77">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Probability =</span> cls_probs_r,</span>
<span id="cb10-78">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Actual_Class =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(y_cls_test_r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Class 0"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Class 1"</span>))</span>
<span id="cb10-79">)</span>
<span id="cb10-80"></span>
<span id="cb10-81">p6 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(cls_results, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Probability, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> Actual_Class)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-82">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-83">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Classification Task: Predicted Probabilities"</span>,</span>
<span id="cb10-85">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(accuracy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>),</span>
<span id="cb10-86">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Probability"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual Class"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-87">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-88">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>)</span>
<span id="cb10-89"></span>
<span id="cb10-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine plots</span></span>
<span id="cb10-91"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb10-92">(p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p3) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (p2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (p4) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (p5 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> p6)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/multi-task-learning-with-torch_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ol type="1">
<li><strong>Architecture Design</strong>: The shared-private paradigm enables models to learn both common and task-specific representations</li>
<li><strong>Loss Combination</strong>: Properly weighting multiple loss functions proves crucial for balanced learning across tasks</li>
<li><strong>Evaluation Strategy</strong>: Each task requires appropriate metrics, and overall model success depends on performance across all tasks</li>
<li><strong>Parameter Efficiency</strong>: Multi-task models can achieve comparable performance with fewer total parameters when properly regularized</li>
<li><strong>Knowledge Transfer</strong>: Related tasks can benefit from shared feature learning, especially when data is limited</li>
</ol>


</section>

 ]]></description>
  <category>R</category>
  <category>Deep Learning</category>
  <category>torch</category>
  <category>Multi-Task Learning</category>
  <guid>https://rtichoke.netlify.app/posts/multi-task-learning-with-torch.html</guid>
  <pubDate>Sat, 10 May 2025 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/torch.png" medium="image" type="image/png" height="166" width="144"/>
</item>
<item>
  <title>Building a Simple Neural Network in R with torch</title>
  <link>https://rtichoke.netlify.app/posts/simple-neural-net-with-torch.html</link>
  <description><![CDATA[ 




<p>The <code>torch</code> package brings deep learning to R by providing bindings to the popular PyTorch library. This comprehensive tutorial demonstrates how to build and train a simple neural network using <code>torch</code> in R.</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install.packages("torch")</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(torch)</span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># torch::install_torch()</span></span></code></pre></div>
</div>
</section>
<section id="a-simple-neural-network" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-neural-network">A Simple Neural Network</h2>
<p>This section focuses on the creation of a neural network to perform a simple regression task.</p>
<section id="sample-data" class="level3">
<h3 class="anchored" data-anchor-id="sample-data">1. Sample Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set seed for reproducibility</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate training data: y = 3x + 2 + noise</span></span>
<span id="cb2-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-6">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the first few data points</span></span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(</span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb2-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>()),</span>
<span id="cb2-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb2-13">  ))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            x         y
1 -0.02329975  1.861628
2  1.92341769  7.555232
3  0.11041667  2.613283
4 -2.55959392 -5.931758
5  0.36482519  3.099005
6  0.97125226  4.551073</code></pre>
</div>
</div>
</section>
<section id="neural-network-module" class="level3">
<h3 class="anchored" data-anchor-id="neural-network-module">2. Neural Network Module</h3>
<p>The next step involves defining the neural network architecture using <code>torch</code>’s module system:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a simple feedforward neural network</span></span>
<span id="cb4-2">nnet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_module</span>(</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initialize =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>() {</span>
<span id="cb4-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define layers</span></span>
<span id="cb4-5">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input layer to hidden layer (1 -&gt; 8 neurons)</span></span>
<span id="cb4-6">    self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hidden layer to output layer (8 -&gt; 1 neuron)</span></span>
<span id="cb4-7">  },</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">forward =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb4-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define forward pass</span></span>
<span id="cb4-10">    x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-11">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">layer1</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First linear transformation</span></span>
<span id="cb4-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_relu</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ReLU activation function</span></span>
<span id="cb4-13">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">layer2</span>()         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Second linear transformation</span></span>
<span id="cb4-14">  }</span>
<span id="cb4-15">)</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Instantiate the model</span></span>
<span id="cb4-18">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnet</span>()</span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display model structure</span></span>
<span id="cb4-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An `nn_module` containing 25 parameters.

── Modules ─────────────────────────────────────────────────────────────────────
• layer1: &lt;nn_linear&gt; #16 parameters
• layer2: &lt;nn_linear&gt; #9 parameters</code></pre>
</div>
</div>
</section>
<section id="set-up-the-optimizer-and-loss-function" class="level3">
<h3 class="anchored" data-anchor-id="set-up-the-optimizer-and-loss-function">3. Set Up the Optimizer and Loss Function</h3>
<p>The training process requires defining how the model will learn from the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up optimizer (Adam optimizer with learning rate 0.02)</span></span>
<span id="cb6-2">optimizer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lr =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define loss function (Mean Squared Error for regression)</span></span>
<span id="cb6-5">loss_fn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nnf_mse_loss</span></code></pre></div>
</div>
</section>
<section id="training-loop" class="level3">
<h3 class="anchored" data-anchor-id="training-loop">4. Training Loop</h3>
<p>The neural network training process proceeds as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store loss values for plotting</span></span>
<span id="cb7-2">loss_history <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training loop</span></span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>) {</span>
<span id="cb7-6">  </span>
<span id="cb7-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set model to training mode</span></span>
<span id="cb7-8">  model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>()</span>
<span id="cb7-9">  </span>
<span id="cb7-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reset gradients</span></span>
<span id="cb7-11">  optimizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb7-12">  </span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forward pass</span></span>
<span id="cb7-14">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x)</span>
<span id="cb7-15">  </span>
<span id="cb7-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate loss</span></span>
<span id="cb7-17">  loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss_fn</span>(y_pred, y)</span>
<span id="cb7-18">  </span>
<span id="cb7-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Backward pass</span></span>
<span id="cb7-20">  loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb7-21">  </span>
<span id="cb7-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update parameters</span></span>
<span id="cb7-23">  optimizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()</span>
<span id="cb7-24">  </span>
<span id="cb7-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store loss for plotting</span></span>
<span id="cb7-26">  loss_history[epoch] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>()</span>
<span id="cb7-27">}</span></code></pre></div>
</div>
</section>
<section id="visualize-the-training-progress" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-training-progress">5. Visualize the Training Progress</h3>
<p>The following visualization demonstrates how the loss decreased during training:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a data frame for plotting</span></span>
<span id="cb8-2">training_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">epoch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,</span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss =</span> loss_history</span>
<span id="cb8-5">)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot training loss</span></span>
<span id="cb8-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(training_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> epoch, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> loss)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2c3e50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb8-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training Loss Over Time"</span>,</span>
<span id="cb8-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural Network Learning Progress"</span>,</span>
<span id="cb8-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch"</span>,</span>
<span id="cb8-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean Squared Error Loss"</span></span>
<span id="cb8-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb8-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb8-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray60"</span>)</span>
<span id="cb8-20">  )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/simple-neural-net-with-torch_files/figure-html/training-progress-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualize-the-results" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-results">6. Visualize the Results</h3>
<p>The following analysis demonstrates how well the trained model performs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set model to evaluation mode</span></span>
<span id="cb9-2">model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictions</span></span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb9-6">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x)</span>
<span id="cb9-7">})</span>
<span id="cb9-8"></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to R vectors for plotting</span></span>
<span id="cb9-10">x_np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb9-11">y_np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb9-12">y_pred_np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_pred<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create data frame for ggplot</span></span>
<span id="cb9-15">plot_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb9-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_np,</span>
<span id="cb9-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_actual =</span> y_np,</span>
<span id="cb9-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_predicted =</span> y_pred_np</span>
<span id="cb9-19">)</span>
<span id="cb9-20"></span>
<span id="cb9-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the plot</span></span>
<span id="cb9-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_actual, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_predicted, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_predicted), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loess"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb9-26">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb9-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural Network Regression Results"</span>,</span>
<span id="cb9-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparing actual vs predicted values"</span>,</span>
<span id="cb9-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input (x)"</span>,</span>
<span id="cb9-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output (y)"</span>,</span>
<span id="cb9-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data Type"</span></span>
<span id="cb9-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Actual"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3498db"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb9-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb9-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray60"</span>),</span>
<span id="cb9-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span></span>
<span id="cb9-40">  )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/simple-neural-net-with-torch_files/figure-html/visualize-results-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-performance-analysis" class="level3">
<h3 class="anchored" data-anchor-id="model-performance-analysis">7. Model Performance Analysis</h3>
<p>The following analysis examines how well the model learned the underlying pattern:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate performance metrics</span></span>
<span id="cb10-2">mse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((y_pred_np <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_np)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-3">rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(mse)</span>
<span id="cb10-4">mae <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(y_pred_np <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_np))</span>
<span id="cb10-5">r_squared <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(y_pred_np, y_np)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create performance summary</span></span>
<span id="cb10-8">performance_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb10-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Metric =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean Squared Error"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Root Mean Squared Error"</span>, </span>
<span id="cb10-10">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean Absolute Error"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R-squared"</span>),</span>
<span id="cb10-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(mse, rmse, mae, r_squared)</span>
<span id="cb10-12">)</span>
<span id="cb10-13"></span>
<span id="cb10-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(performance_summary)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   Metric      Value
1      Mean Squared Error 0.09061213
2 Root Mean Squared Error 0.30101848
3     Mean Absolute Error 0.23722124
4               R-squared 0.99000990</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare with true relationship (y = 3x + 2)</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictions on a grid for comparison</span></span>
<span id="cb12-3">x_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_linspace</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unsqueeze</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb12-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb12-5">  y_grid_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_grid)</span>
<span id="cb12-6">})</span>
<span id="cb12-7"></span>
<span id="cb12-8">x_grid_np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(x_grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb12-9">y_grid_pred_np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_grid_pred<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>())</span>
<span id="cb12-10">y_grid_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x_grid_np <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot comparison</span></span>
<span id="cb12-13">comparison_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb12-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_grid_np,</span>
<span id="cb12-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_true =</span> y_grid_true,</span>
<span id="cb12-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_predicted =</span> y_grid_pred_np</span>
<span id="cb12-17">)</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(comparison_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Function"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_predicted, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural Network"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> plot_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_actual), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb12-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural Network vs True Function"</span>,</span>
<span id="cb12-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model learning assessment against the underlying pattern"</span>,</span>
<span id="cb12-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input (x)"</span>,</span>
<span id="cb12-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output (y)"</span>,</span>
<span id="cb12-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Function Type"</span></span>
<span id="cb12-28">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Function"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2c3e50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural Network"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#e74c3c"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb12-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb12-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray60"</span>),</span>
<span id="cb12-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span></span>
<span id="cb12-35">  )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/simple-neural-net-with-torch_files/figure-html/performance-analysis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="understanding-the-neural-network" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-neural-network">Understanding the Neural Network</h2>
<p>The following examination reveals what the network learned by analyzing its parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract learned parameters</span></span>
<span id="cb13-2">layer1_weight <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detach</span>())</span>
<span id="cb13-3">layer1_bias <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bias<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detach</span>())</span>
<span id="cb13-4">layer2_weight <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detach</span>())</span>
<span id="cb13-5">layer2_bias <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layer1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bias<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detach</span>())</span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"First layer (fc1) parameters:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>First layer (fc1) parameters:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight matrix shape:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(layer1_weight), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weight matrix shape: 8 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bias vector length:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(layer1_bias), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bias vector length: 8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Second layer (fc2) parameters:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Second layer (fc2) parameters:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight matrix shape:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(layer2_weight), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Weight matrix shape: 1 8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bias value:"</span>, layer2_bias, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bias value: 0.701076 -0.8832566 -1.28852 0.4193589 0.8179439 -0.4608558 0.6640872 0.2222885 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display first layer weights and biases</span></span>
<span id="cb25-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"First layer weights:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>First layer weights:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(layer1_weight, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]
[1,]  1.2292
[2,] -2.0338
[3,]  0.3231
[4,]  1.4845
[5,]  1.2861
[6,] -0.0174
[7,]  0.1889
[8,] -0.5916</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">First layer biases:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
First layer biases:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(layer2_bias, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  0.7011 -0.8833 -1.2885  0.4194  0.8179 -0.4609  0.6641  0.2223</code></pre>
</div>
</div>
</section>
<section id="experimenting-with-different-architectures" class="level2">
<h2 class="anchored" data-anchor-id="experimenting-with-different-architectures">Experimenting with Different Architectures</h2>
<p>The following section analyzes the simple network against different architectures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define different network architectures</span></span>
<span id="cb33-2">create_network <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(hidden_sizes) {</span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_module</span>(</span>
<span id="cb33-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initialize =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(hidden_sizes) {</span>
<span id="cb33-5">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_module_list</span>()</span>
<span id="cb33-6">      </span>
<span id="cb33-7">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input layer</span></span>
<span id="cb33-8">      prev_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb33-9">      </span>
<span id="cb33-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(hidden_sizes)) {</span>
<span id="cb33-11">        self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(prev_size, hidden_sizes[i]))</span>
<span id="cb33-12">        prev_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hidden_sizes[i]</span>
<span id="cb33-13">      }</span>
<span id="cb33-14">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output layer</span></span>
<span id="cb33-15">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(prev_size, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb33-16">    },</span>
<span id="cb33-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">forward =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb33-18">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) {</span>
<span id="cb33-19">        x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_relu</span>(self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers[[i]](x))</span>
<span id="cb33-20">      }</span>
<span id="cb33-21">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No activation on output layer</span></span>
<span id="cb33-22">      self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers[[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>layers)]](x)</span>
<span id="cb33-23">    }</span>
<span id="cb33-24">  )</span>
<span id="cb33-25">}</span>
<span id="cb33-26"></span>
<span id="cb33-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train different architectures</span></span>
<span id="cb33-28">architectures <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb33-29">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simple (8)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb33-30">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deep (16-8)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb33-31">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Wide (32)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>),</span>
<span id="cb33-32">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Very Deep (16-16-8)"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb33-33">)</span>
<span id="cb33-34"></span>
<span id="cb33-35">results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb33-36"></span>
<span id="cb33-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(arch_name <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(architectures)) {</span>
<span id="cb33-38"></span>
<span id="cb33-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create and train model</span></span>
<span id="cb33-40">  net_class <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_network</span>(architectures[[arch_name]])</span>
<span id="cb33-41">  model_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net_class</span>(architectures[[arch_name]])</span>
<span id="cb33-42">  optimizer_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(model_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lr =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb33-43">  </span>
<span id="cb33-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick training (fewer epochs for comparison)</span></span>
<span id="cb33-45">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb33-46">    model_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train</span>()</span>
<span id="cb33-47">    optimizer_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb33-48">    y_pred_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_temp</span>(x)</span>
<span id="cb33-49">    loss_temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss_fn</span>(y_pred_temp, y)</span>
<span id="cb33-50">    loss_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb33-51">    optimizer_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()</span>
<span id="cb33-52">  }</span>
<span id="cb33-53">  </span>
<span id="cb33-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictions</span></span>
<span id="cb33-55">  model_temp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb33-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb33-57">    y_pred_arch <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model_temp</span>(x_grid)</span>
<span id="cb33-58">  })</span>
<span id="cb33-59">  </span>
<span id="cb33-60">  results[[arch_name]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb33-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x_grid_np,</span>
<span id="cb33-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_pred_arch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">squeeze</span>()),</span>
<span id="cb33-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">architecture =</span> arch_name</span>
<span id="cb33-64">  )</span>
<span id="cb33-65">}</span>
<span id="cb33-66"></span>
<span id="cb33-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine results</span></span>
<span id="cb33-68">all_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(rbind, results)</span>
<span id="cb33-69"></span>
<span id="cb33-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot comparison</span></span>
<span id="cb33-71"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(all_results, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> architecture)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-72">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> comparison_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Function"</span>), </span>
<span id="cb33-74">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-75">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> plot_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_actual), </span>
<span id="cb33-76">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit.aes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb33-77">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of Different Neural Network Architectures"</span>,</span>
<span id="cb33-78">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Effects of network depth and width on learning performance"</span>,</span>
<span id="cb33-79">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input (x)"</span>,</span>
<span id="cb33-80">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output (y)"</span>,</span>
<span id="cb33-81">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Architecture"</span></span>
<span id="cb33-82">             ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-83">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb33-85">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>),</span>
<span id="cb33-86">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray60"</span>),</span>
<span id="cb33-87">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span></span>
<span id="cb33-88">  )</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/simple-neural-net-with-torch_files/figure-html/architecture-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ol type="1">
<li><strong>Simple Architecture</strong>: Even a simple 2-layer network can learn complex patterns effectively</li>
<li><strong>Training Process</strong>: The importance of proper training loops with gradient computation</li>
<li><strong>Visualization</strong>: Effective methods for visualizing both training progress and results</li>
<li><strong>Model Evaluation</strong>: Understanding model performance through multiple metrics</li>
<li><strong>Architecture Comparison</strong>: How different network structures affect learning capabilities</li>
</ol>
<p>The <code>torch</code> package provides a straightforward approach to building and experimenting with neural networks in R, bringing the power of deep learning to the R ecosystem. This approach can be extended to more complex datasets and deeper architectures as needed.</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Deep Learning</category>
  <category>torch</category>
  <guid>https://rtichoke.netlify.app/posts/simple-neural-net-with-torch.html</guid>
  <pubDate>Wed, 04 Dec 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/nn.png" medium="image" type="image/png" height="173" width="144"/>
</item>
<item>
  <title>Tutorial: Assessing Credit Score Prediction Reliability Using Bootstrap Resampling</title>
  <link>https://rtichoke.netlify.app/posts/assessing-score-reliability.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Credit scoring models demonstrate optimal performance within the central regions of the score distribution, yet exhibit diminished reliability at the distribution extremes where data becomes sparse. This tutorial provides a comprehensive methodology for employing bootstrap resampling techniques to quantify prediction variability across different score ranges, thereby enabling practitioners to identify regions where their models demonstrate the highest degree of dependability.</p>
</section>
<section id="theoretical-foundation-understanding-estimation-variance" class="level2">
<h2 class="anchored" data-anchor-id="theoretical-foundation-understanding-estimation-variance">Theoretical Foundation: Understanding Estimation Variance</h2>
<p>Reduced sample sizes inherently result in increased variance in statistical estimates, particularly for extreme values within a distribution. While central tendency measures such as means demonstrate relative stability when estimated from limited data, tail percentiles (95th, 99th) exhibit substantially greater volatility. This phenomenon is of critical importance in credit scoring applications, where extremely high and low scores correspond to these unstable tail regions of the distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples to be drawn from a probability distribution</span></span>
<span id="cb1-2">n_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of times, sampling should be repeated</span></span>
<span id="cb1-5">repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean and std-dev for a standard normal distribution</span></span>
<span id="cb1-8">mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb1-9">std_dev <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample</span></span>
<span id="cb1-12">samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n_samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> repeats, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit into a matrix like object with `n_samples' number of rows </span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and `repeats' number of columns</span></span>
<span id="cb1-16">samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(samples, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> n_samples, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> repeats)</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute mean across each column</span></span>
<span id="cb1-19">sample_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, mean)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Similarly, compute 75% and 95% quantile across each column</span></span>
<span id="cb1-22">sample_75_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)</span>
<span id="cb1-23">sample_95_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb1-24">sample_99_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare coefficient of variation</span></span>
<span id="cb1-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(sample_means)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(sample_means)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0100664</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(sample_75_quantile)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(sample_75_quantile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01270263</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(sample_95_quantile)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(sample_75_quantile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01888391</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the distributions</span></span>
<span id="cb7-2">combined_vec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sample_means, sample_75_quantile, sample_95_quantile, sample_99_quantile)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(sample_means), </span>
<span id="cb7-5">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6F69AC"</span>, </span>
<span id="cb7-6">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, </span>
<span id="cb7-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimating the mean vs tail quantiles"</span>, </span>
<span id="cb7-8">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, </span>
<span id="cb7-9">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(combined_vec), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(combined_vec)))</span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(sample_75_quantile), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#95DAC1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(sample_95_quantile), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFEBA1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(sample_99_quantile), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FD6F96"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid</span>()</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, </span>
<span id="cb7-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6F69AC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#95DAC1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFEBA1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FD6F96"</span>), </span>
<span id="cb7-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"75% Quantile"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"95% Quantile"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"99% Quantile"</span>), </span>
<span id="cb7-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/assessing-score-reliability_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The visualization demonstrates the substantial increase in uncertainty when estimating extreme values compared to central tendencies. The distribution corresponding to the mean (purple) exhibits considerably narrower dispersion than that of the 99th percentile (pink). This statistical principle directly applies to credit scoring applications, where scores at the extremes of the distribution inherently possess greater uncertainty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magrittr)</span>
<span id="cb8-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rsample)</span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span></code></pre></div>
</div>
</section>
<section id="data-acquisition-and-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-acquisition-and-preprocessing">Data Acquisition and Preprocessing</h2>
<p>In this tutorial, we will utilize a sample from the Lending Club dataset. Loans classified as “Charged Off” will be designated as defaults. The observed class imbalance represents a typical characteristic of credit portfolios and contributes significantly to prediction challenges at distribution extremes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load sample data (sample of the lending club data)</span></span>
<span id="cb9-2">sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://bit.ly/42ypcnJ"</span>)</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mark which loan status will be tagged as default</span></span>
<span id="cb9-5">codes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charged Off"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Does not meet the credit policy. Status:Charged Off"</span>)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply above codes and create target</span></span>
<span id="cb9-8">sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bad_flag =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> codes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace missing values with a default value</span></span>
<span id="cb9-11">sample[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(sample)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get summary tally</span></span>
<span id="cb9-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bad_flag)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
8838 1162 </code></pre>
</div>
</div>
</section>
<section id="implementing-bootstrap-resampling-strategy" class="level2">
<h2 class="anchored" data-anchor-id="implementing-bootstrap-resampling-strategy">Implementing Bootstrap Resampling Strategy</h2>
<p>This section demonstrates the creation of 100 bootstrap samples to quantify the variation in model predictions across different score ranges. Bootstrap resampling is a statistical technique that generates multiple simulated datasets to measure prediction uncertainty without requiring additional data collection.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create 100 samples</span></span>
<span id="cb11-2">boot_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bootstraps</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> sample, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(boot_sample, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  splits               id          
  &lt;list&gt;               &lt;chr&gt;       
1 &lt;split [10000/3700]&gt; Bootstrap001
2 &lt;split [10000/3630]&gt; Bootstrap002
3 &lt;split [10000/3639]&gt; Bootstrap003</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each row represents a separate bootstrapped sample with an analysis set and assessment set</span></span>
<span id="cb13-2">boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Analysis/Assess/Total&gt;
&lt;10000/3700/10000&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the first 5 rows and 5 columns of the first sample</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analysis</span>(boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> .[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     V1        id member_id loan_amnt funded_amnt
1 70066 143521620        -1     18000       18000
2 74725 143608122        -1     15000       15000
3 64235 122327224        -1     10000       10000
4 26743  70312012        -1     35000       35000
5 80520  68407752        -1     11000       11000</code></pre>
</div>
</div>
<p>Each bootstrap sample consists of random draws with replacement from the original dataset, creating controlled variations that effectively reveal model sensitivity to different data compositions.</p>
</section>
<section id="developing-the-predictive-model-framework" class="level2">
<h2 class="anchored" data-anchor-id="developing-the-predictive-model-framework">Developing the Predictive Model Framework</h2>
<p>This tutorial employs logistic regression as the predictive modeling technique. Logistic regression represents the industry standard for credit risk modeling due to its interpretability and regulatory acceptance. The model specification incorporates typical credit variables including loan amount, income, and credit history metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">glm_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df){</span>
<span id="cb17-2">  </span>
<span id="cb17-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit a simple model with a set specification</span></span>
<span id="cb17-4">  mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb17-5">               loan_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> funded_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> annual_inc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delinq_2yrs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-6">               inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_last_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fico_range_low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb17-7">               mths_since_last_record <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> total_pymnt,</span>
<span id="cb17-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binomial"</span>,</span>
<span id="cb17-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df)</span>
<span id="cb17-10">  </span>
<span id="cb17-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return fitted values</span></span>
<span id="cb17-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl))</span>
<span id="cb17-13">}</span>
<span id="cb17-14"></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test the function</span></span>
<span id="cb17-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retrieve a data frame</span></span>
<span id="cb17-17">train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analysis</span>(boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb17-18"></span>
<span id="cb17-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predict</span></span>
<span id="cb17-20">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm_model</span>(train)</span>
<span id="cb17-21"></span>
<span id="cb17-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check output</span></span>
<span id="cb17-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(pred)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output is on log odds scale</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -30.25449   1.57891</code></pre>
</div>
</div>
<p>The function returns predictions in log-odds format, which will subsequently be transformed to a more intuitive credit score scale in later steps.</p>
</section>
<section id="iterative-model-training-and-prediction-collection" class="level2">
<h2 class="anchored" data-anchor-id="iterative-model-training-and-prediction-collection">Iterative Model Training and Prediction Collection</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First apply the glm fitting function to each of the sample</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note the use of lapply</span></span>
<span id="cb19-3">output <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x){</span>
<span id="cb19-4">  train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analysis</span>(x)</span>
<span id="cb19-5">  pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm_model</span>(train)</span>
<span id="cb19-6"></span>
<span id="cb19-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(pred)</span>
<span id="cb19-8">})</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collate all predictions into a vector </span></span>
<span id="cb19-11">boot_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(c, output)</span>
<span id="cb19-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(boot_preds)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -130.406408    4.125475</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get outliers</span></span>
<span id="cb21-2">q_high <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(boot_preds, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb21-3">q_low <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(boot_preds, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb21-4"></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Truncate the overall distribution to within the lower 1% and upper 1% quantiles</span></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Doing this since it creates issues later on when scaling the output</span></span>
<span id="cb21-7">boot_preds[boot_preds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> q_high] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> q_high</span>
<span id="cb21-8">boot_preds[boot_preds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> q_low] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> q_low</span>
<span id="cb21-9"></span>
<span id="cb21-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(boot_preds)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -5.0603991 -0.2283903</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to a data frame</span></span>
<span id="cb23-2">boot_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred =</span> boot_preds, </span>
<span id="cb23-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sample)))</span>
<span id="cb23-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(boot_preds)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       pred id
1 -1.460522  1
2 -1.644074  1
3 -3.123883  1
4 -4.236837  1
5 -3.197778  1
6 -3.123942  1</code></pre>
</div>
</div>
<p>In this step, we apply the logistic regression model to each bootstrap sample and systematically collect the resulting predictions. Subsequently, we truncate extreme values (beyond the 1st and 99th percentiles) to remove outliers—a procedure analogous to capping techniques commonly employed in production credit models.</p>
</section>
<section id="transforming-predictions-to-credit-score-scale" class="level2">
<h2 class="anchored" data-anchor-id="transforming-predictions-to-credit-score-scale">Transforming Predictions to Credit Score Scale</h2>
<p>This section demonstrates the conversion of log-odds predictions to a recognizable credit score format using the industry-standard Points to Double Odds (PDO) methodology. By employing parameters consistent with real-world credit systems (PDO=30, Anchor=700), we transform the model predictions into intuitive scores where higher numerical values indicate lower credit risk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">scaling_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(vec, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">PDO =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">OddsAtAnchor =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Anchor =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>){</span>
<span id="cb25-2">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> PDO <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb25-3">  alpha <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Anchor <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> PDO <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> OddsAtAnchor</span>
<span id="cb25-4">  </span>
<span id="cb25-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple linear scaling of the log odds</span></span>
<span id="cb25-6">  scr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> vec  </span>
<span id="cb25-7">  </span>
<span id="cb25-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Round off</span></span>
<span id="cb25-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(scr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb25-10">}</span>
<span id="cb25-11"></span>
<span id="cb25-12">boot_preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaling_func</span>(boot_preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>)</span>
<span id="cb25-13"></span>
<span id="cb25-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chart the distribution of predictions across all the samples</span></span>
<span id="cb25-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(boot_preds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> scores, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(id))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_grey</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predictions from bootstrapped samples"</span>, </span>
<span id="cb25-21">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density function"</span>, </span>
<span id="cb25-22">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predictions (Log odds)"</span>, </span>
<span id="cb25-23">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/assessing-score-reliability_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="quantifying-prediction-uncertainty-across-score-ranges" class="level2">
<h2 class="anchored" data-anchor-id="quantifying-prediction-uncertainty-across-score-ranges">Quantifying Prediction Uncertainty Across Score Ranges</h2>
<p>This section provides a methodology to directly measure prediction reliability variation across different score ranges through the calculation of standard deviation within each score bin. This approach enables precise quantification of uncertainty at different score levels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create bins using quantiles</span></span>
<span id="cb26-2">breaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(boot_preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))</span>
<span id="cb26-3">boot_preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(boot_preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scores, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(breaks), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.lowest =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> T)</span>
<span id="cb26-4"></span>
<span id="cb26-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chart standard deviation of model predictions across each score bin</span></span>
<span id="cb26-6">boot_preds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(bins) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">std_dev =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(scores)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> bins, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> std_dev)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#90AACB"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb26-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb26-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb26-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb26-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Variability in model predictions across samples"</span>, </span>
<span id="cb26-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(measured using standard deviation)"</span>, </span>
<span id="cb26-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Score Range"</span>, </span>
<span id="cb26-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Standard Deviation"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/assessing-score-reliability_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As anticipated, the model’s predictions demonstrate enhanced reliability within a specific range of values (700-800), while exhibiting significant variability in the lowest and highest score buckets.</p>
<p>The visualization reveals a characteristic “U-shaped” pattern of prediction variability—a well-documented phenomenon in credit risk modeling. The highest uncertainty manifests in the extreme score ranges (very high and very low scores), while predictions in the middle range demonstrate greater stability. The analysis confirms the initial hypothesis: variability reaches its maximum at score extremes and achieves its minimum in the middle range (600-800). This finding provides direct guidance for credit policy development—scores in the middle range demonstrate the highest reliability, while decisions at the extremes should incorporate additional caution due to elevated uncertainty.</p>
<section id="practical-business-applications" class="level3">
<h3 class="anchored" data-anchor-id="practical-business-applications">Practical Business Applications</h3>
<p>These findings yield direct business applications:</p>
<ol type="1">
<li><strong>High Score Management</strong>: For extremely high scores, implement additional verification steps before automated approval</li>
<li><strong>Low Score Management</strong>: For very low scores, consider manual review procedures rather than automatic rejection</li>
</ol>
</section>
</section>
<section id="advanced-methodology-isolating-training-data-effects" class="level2">
<h2 class="anchored" data-anchor-id="advanced-methodology-isolating-training-data-effects">Advanced Methodology: Isolating Training Data Effects</h2>
<p><em>Credit: Richard Warnung</em></p>
<p>For enhanced analytical control, this section presents an alternative approach where models are trained on bootstrap samples while being evaluated on a consistent validation set. This methodology effectively isolates the impact of training data variation on model predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">Vs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(boot_split){</span>
<span id="cb27-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train model on the bootstrapped data</span></span>
<span id="cb27-3">  train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analysis</span>(boot_split)</span>
<span id="cb27-4">  </span>
<span id="cb27-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit model</span></span>
<span id="cb27-6">  mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb27-7">               loan_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> funded_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> annual_inc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delinq_2yrs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-8">               inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_last_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fico_range_low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-9">               mths_since_last_record <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> total_pymnt,</span>
<span id="cb27-10">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binomial"</span>,</span>
<span id="cb27-11">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train)</span>
<span id="cb27-12">  </span>
<span id="cb27-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply to a common validation set</span></span>
<span id="cb27-14">  validate_preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> validate_set)</span>
<span id="cb27-15">  </span>
<span id="cb27-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return predictions</span></span>
<span id="cb27-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(validate_preds)</span>
<span id="cb27-18">}</span></code></pre></div>
</div>
<p>This methodology provides enhanced insight into how variations in training data composition affect model predictions, which proves valuable when evaluating model updates in production environments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create overall training and testing datasets </span></span>
<span id="cb28-2">id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sample), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sample)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> F)</span>
<span id="cb28-3"></span>
<span id="cb28-4">train_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sample[id,]</span>
<span id="cb28-5">test_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sample[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>id,]</span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bootstrapped samples are now pulled only from the overall training dataset</span></span>
<span id="cb28-8">boot_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bootstraps</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>)</span>
<span id="cb28-9"></span>
<span id="cb28-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using the same function from before but predicting on the same test dataset</span></span>
<span id="cb28-11">glm_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(train, test){</span>
<span id="cb28-12">  </span>
<span id="cb28-13">  mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span></span>
<span id="cb28-14">               loan_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> funded_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> annual_inc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delinq_2yrs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-15">               inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_last_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fico_range_low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb28-16">               mths_since_last_record <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> total_pymnt,</span>
<span id="cb28-17">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binomial"</span>,</span>
<span id="cb28-18">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train)</span>
<span id="cb28-19">  </span>
<span id="cb28-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return fitted values on the test dataset</span></span>
<span id="cb28-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> test))</span>
<span id="cb28-22">}</span>
<span id="cb28-23"></span>
<span id="cb28-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the glm fitting function to each of the sample</span></span>
<span id="cb28-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># But predict on the same test dataset</span></span>
<span id="cb28-26">output <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(boot_sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>splits, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x){</span>
<span id="cb28-27">  train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">analysis</span>(x)</span>
<span id="cb28-28">  pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm_model</span>(train, test_data)</span>
<span id="cb28-29"></span>
<span id="cb28-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(pred)</span>
<span id="cb28-31">})</span></code></pre></div>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>Prediction reliability varies significantly across score ranges</strong>, with highest uncertainty at distribution extremes</li>
<li><strong>Bootstrap methodology provides a practical framework</strong> for measuring model uncertainty without additional data requirements<br>
</li>
<li><strong>Risk management strategies should be adjusted</strong> based on score reliability, with enhanced verification for extreme scores</li>
<li><strong>The PDO transformation enables intuitive score interpretation</strong> while preserving the underlying risk relationships</li>
</ul>
<p>These techniques can be applied beyond credit scoring to any prediction problem where understanding model uncertainty is critical for decision-making.</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Credit Risk Analytics</category>
  <category>Bootstrapping</category>
  <guid>https://rtichoke.netlify.app/posts/assessing-score-reliability.html</guid>
  <pubDate>Thu, 14 Nov 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/score_reliability.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>Building Models in R with tidymodels</title>
  <link>https://rtichoke.netlify.app/posts/modeling-with-tidymodels.html</link>
  <description><![CDATA[ 




<p>The tidymodels framework provides a cohesive set of packages for modeling and machine learning in R, following tidyverse principles. In this post, we’ll build a realistic credit scoring model using tidymodels.</p>
<p>Credit scoring models are used by financial institutions to assess the creditworthiness of borrowers. These models predict the probability of default (failure to repay a loan) based on borrower characteristics and loan attributes. A good credit scoring model should effectively discriminate between high-risk and low-risk borrowers, be well-calibrated, and provide interpretable insights.</p>
<section id="required-packages" class="level2">
<h2 class="anchored" data-anchor-id="required-packages">Required Packages</h2>
<p>First, let’s load all the required packages for our analysis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidymodels)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xgboost)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(vip)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For variable importance</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(stringr)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For string manipulation functions</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(probably)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For calibration plots</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ROSE)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For imbalanced data visualization</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(corrplot)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For correlation visualization</span></span></code></pre></div>
</div>
</section>
<section id="synthetic-data-generation" class="level2">
<h2 class="anchored" data-anchor-id="synthetic-data-generation">Synthetic Data Generation</h2>
<p>This tutorial uses a simulated credit dataset incorporating realistic variable distributions commonly encountered in credit scoring applications. The synthetic data includes demographic information, loan characteristics, and credit history variables with appropriate statistical relationships.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb2-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Larger sample size for more realistic modeling</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create base features with realistic distributions</span></span>
<span id="cb2-5">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">customer_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CUS"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formatC</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flag =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0"</span>)),</span>
<span id="cb2-7">  </span>
<span id="cb2-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demographics - with realistic age distribution for credit applicants</span></span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>)))),</span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">income =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12000</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52000</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>))),</span>
<span id="cb2-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">employment_length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exponential distribution for job tenure</span></span>
<span id="cb2-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_ownership =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RENT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MORTGAGE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OWN"</span>), n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.40</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>)),</span>
<span id="cb2-13">  </span>
<span id="cb2-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loan characteristics - with more realistic correlations</span></span>
<span id="cb2-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loan_amount =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15000</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log-normal for loan amounts</span></span>
<span id="cb2-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loan_term =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>), n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)),</span>
<span id="cb2-17">  </span>
<span id="cb2-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Credit history - with more realistic distributions</span></span>
<span id="cb2-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">credit_score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">850</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">700</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>)))),</span>
<span id="cb2-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dti_ratio =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>))),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Debt-to-income ratio</span></span>
<span id="cb2-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delinq_2yrs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(n, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of delinquencies in past 2 years</span></span>
<span id="cb2-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inq_last_6mths =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(n, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of inquiries in last 6 months</span></span>
<span id="cb2-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">open_acc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of open accounts</span></span>
<span id="cb2-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pub_rec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of public records</span></span>
<span id="cb2-25">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">revol_util =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>))),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revolving utilization</span></span>
<span id="cb2-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_acc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(open_acc, open_acc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Total accounts</span></span>
<span id="cb2-27">)</span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add realistic correlations between variables</span></span>
<span id="cb2-30">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interest rate depends on credit score and loan term</span></span>
<span id="cb2-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interest_rate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (credit_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">550</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-34">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-35">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>),</span>
<span id="cb2-36">    </span>
<span id="cb2-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loan purpose with realistic probabilities</span></span>
<span id="cb2-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loan_purpose =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb2-39">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"debt_consolidation"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credit_card"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"home_improvement"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"major_purchase"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"medical"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other"</span>), </span>
<span id="cb2-40">      n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb2-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.07</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span>
<span id="cb2-42">    ),</span>
<span id="cb2-43">    </span>
<span id="cb2-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add some derived features that have predictive power</span></span>
<span id="cb2-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">payment_amount =</span> (loan_amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (interest_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> interest_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>loan_term) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> </span>
<span id="cb2-46">      ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> interest_rate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">payment_to_income_ratio =</span> (payment_amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> income</span>
<span id="cb2-48">  )</span>
<span id="cb2-49"></span>
<span id="cb2-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a more realistic default probability model with non-linear effects</span></span>
<span id="cb2-51">logit_default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(data, {</span>
<span id="cb2-52">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Base intercept for ~10% default rate</span></span>
<span id="cb2-53">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Age effect (stronger for younger borrowers)</span></span>
<span id="cb2-54">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(income<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log-transformed income effect</span></span>
<span id="cb2-55">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.08</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> employment_length <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Employment length effect</span></span>
<span id="cb2-56">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(home_ownership <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OWN"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(home_ownership <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MORTGAGE"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Home ownership</span></span>
<span id="cb2-57">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(loan_amount<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log-transformed loan amount</span></span>
<span id="cb2-58">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loan term</span></span>
<span id="cb2-59">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> interest_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interest rate effect</span></span>
<span id="cb2-60">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_purpose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"debt_consolidation"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, </span>
<span id="cb2-61">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_purpose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credit_card"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, </span>
<span id="cb2-62">                  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_purpose <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"medical"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loan purpose</span></span>
<span id="cb2-63">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (credit_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Credit score (stronger effect at lower scores)</span></span>
<span id="cb2-64">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dti_ratio <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DTI ratio effect</span></span>
<span id="cb2-65">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> delinq_2yrs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Delinquencies effect (stronger effect for first delinquency)</span></span>
<span id="cb2-66">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inquiries effect</span></span>
<span id="cb2-67">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(open_acc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Open accounts (log-transformed)</span></span>
<span id="cb2-68">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pub_rec <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Public records (strong effect)</span></span>
<span id="cb2-69">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Revolving utilization</span></span>
<span id="cb2-70">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> payment_to_income_ratio <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Payment to income ratio (strong effect)</span></span>
<span id="cb2-71">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add some noise for realistic variation</span></span>
<span id="cb2-72">})</span>
<span id="cb2-73"></span>
<span id="cb2-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate default flag with realistic default rate</span></span>
<span id="cb2-75">prob_default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(logit_default)</span>
<span id="cb2-76">data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, prob_default), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>))</span>
<span id="cb2-77"></span>
<span id="cb2-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check class distribution</span></span>
<span id="cb2-79"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  no  yes 
9425  575 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    no    yes 
0.9425 0.0575 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize the default rate</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> default)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_bar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> ..prop.., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Class Distribution in Credit Dataset"</span>,</span>
<span id="cb6-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize the relationship between key variables and default rate</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> credit_score, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(default) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loess"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default Rate by Credit Score"</span>, </span>
<span id="cb7-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Credit Score"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default Probability"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Examine correlation between numeric predictors</span></span>
<span id="cb8-2">credit_cors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(age, income, employment_length, loan_amount, interest_rate, </span>
<span id="cb8-4">         credit_score, dti_ratio, delinq_2yrs, revol_util, payment_to_income_ratio) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>()</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">corrplot</span>(credit_cors, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circle"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upper"</span>, </span>
<span id="cb8-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tl.col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tl.srt =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tl.cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="stratified-partitioning" class="level2">
<h2 class="anchored" data-anchor-id="stratified-partitioning">Stratified Partitioning</h2>
<p>Credit default datasets typically exhibit class imbalance, with default events representing the minority class. We implement stratified sampling to preserve the class distribution across training, validation, and test partitions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create initial train/test split (80/20)</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">456</span>)</span>
<span id="cb9-3">initial_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span>(data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> default)</span>
<span id="cb9-4">train_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(initial_split)</span>
<span id="cb9-5">test_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(initial_split)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create validation set from training data (75% train, 25% validation)</span></span>
<span id="cb9-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">789</span>)</span>
<span id="cb9-9">validation_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span>(train_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> default)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check class imbalance in training data</span></span>
<span id="cb9-12">train_class_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default)</span>
<span id="cb9-13">train_class_props <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.table</span>(train_class_counts)</span>
<span id="cb9-14"></span>
<span id="cb9-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training data class distribution:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training data class distribution:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(train_class_counts)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  no  yes 
5661  339 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Percentage:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Percentage:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(train_class_props <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   no   yes 
94.35  5.65 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize class imbalance</span></span>
<span id="cb17-2">ROSE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">roc.curve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>, </span>
<span id="cb17-3">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>credit_score,</span>
<span id="cb17-4">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ROC Curve for Credit Score Alone"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Area under the curve (AUC): 0.753</code></pre>
</div>
</div>
</section>
<section id="feature-engineering-and-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering-and-preprocessing">Feature Engineering and Preprocessing</h2>
<p>The following section develops a preprocessing recipe incorporating domain-specific feature engineering techniques relevant to credit risk modeling, including class imbalance handling strategies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Examine the distributions of key variables</span></span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb19-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>credit_score, </span>
<span id="cb19-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Credit Score Distribution"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Credit Score"</span>)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dti_ratio, </span>
<span id="cb19-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DTI Ratio Distribution"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DTI Ratio"</span>)</span>
<span id="cb19-8"></span>
<span id="cb19-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>payment_to_income_ratio, </span>
<span id="cb19-10">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Payment to Income Ratio"</span>, </span>
<span id="cb19-11">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Payment to Income Ratio"</span>)</span>
<span id="cb19-12"></span>
<span id="cb19-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>income), </span>
<span id="cb19-14">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log Income Distribution"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log Income"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mfrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a recipe</span></span>
<span id="cb21-2">credit_recipe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(default <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove ID column</span></span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_rm</span>(customer_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-5">  </span>
<span id="cb21-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert categorical variables to factors</span></span>
<span id="cb21-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_string2factor</span>(home_ownership, loan_purpose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-8">  </span>
<span id="cb21-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create additional domain-specific features</span></span>
<span id="cb21-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_mutate</span>(</span>
<span id="cb21-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We already have payment_to_income_ratio from data generation</span></span>
<span id="cb21-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add more credit risk indicators</span></span>
<span id="cb21-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">credit_utilization =</span> revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb21-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">acc_to_age_ratio =</span> total_acc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> age,</span>
<span id="cb21-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delinq_per_acc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(total_acc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, delinq_2yrs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_acc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb21-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inq_rate =</span> inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (open_acc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inquiry rate relative to open accounts</span></span>
<span id="cb21-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">term_factor =</span> loan_term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Term in years</span></span>
<span id="cb21-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log_income =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(income),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log transform income</span></span>
<span id="cb21-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log_loan =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(loan_amount),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Log transform loan amount</span></span>
<span id="cb21-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">payment_ratio =</span> payment_amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (income <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Monthly payment to monthly income</span></span>
<span id="cb21-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">util_to_income =</span> (revol_util <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (dti_ratio <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interaction term</span></span>
<span id="cb21-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-23">  </span>
<span id="cb21-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Handle categorical variables</span></span>
<span id="cb21-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_dummy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal_predictors</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-26">  </span>
<span id="cb21-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Impute missing values (if any)</span></span>
<span id="cb21-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_impute_median</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-29">  </span>
<span id="cb21-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transform highly skewed variables</span></span>
<span id="cb21-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_YeoJohnson</span>(income, loan_amount, payment_amount) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-32">  </span>
<span id="cb21-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove highly correlated predictors</span></span>
<span id="cb21-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_corr</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threshold =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-35">  </span>
<span id="cb21-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize numeric predictors</span></span>
<span id="cb21-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb21-38">  </span>
<span id="cb21-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove zero-variance predictors</span></span>
<span id="cb21-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_zv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_predictors</span>())</span>
<span id="cb21-41"></span>
<span id="cb21-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prep the recipe to examine the steps</span></span>
<span id="cb21-43">prepped_recipe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span>(credit_recipe)</span>
<span id="cb21-44">prepped_recipe</span>
<span id="cb21-45"></span>
<span id="cb21-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the transformed data</span></span>
<span id="cb21-47">recipe_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span>(prepped_recipe, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new_data =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb21-48"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(recipe_data)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 6,000
Columns: 27
$ age                             &lt;dbl&gt; -0.58938716, 1.60129128, 0.05970275, 0…
$ employment_length               &lt;dbl&gt; 1.01545119, 0.17764322, 2.35594395, -0…
$ loan_amount                     &lt;dbl&gt; -0.30772032, -1.64018559, 0.01897785, …
$ credit_score                    &lt;dbl&gt; -1.66355858, -1.60583467, 0.02197934, …
$ dti_ratio                       &lt;dbl&gt; -1.10745919, -0.21368748, -1.26746777,…
$ delinq_2yrs                     &lt;dbl&gt; -0.6423758, -0.6423758, -0.6423758, -0…
$ inq_last_6mths                  &lt;dbl&gt; -0.8324634, 1.5511111, -0.8324634, -0.…
$ open_acc                        &lt;dbl&gt; -0.516984456, -1.282635289, -1.2826352…
$ pub_rec                         &lt;dbl&gt; -0.3429372, -0.3429372, 2.7652549, -0.…
$ total_acc                       &lt;dbl&gt; 0.39969129, 0.54625046, -0.47966374, 0…
$ interest_rate                   &lt;dbl&gt; 1.47394527, 1.51546694, -0.11980960, 0…
$ default                         &lt;fct&gt; no, no, no, no, no, no, no, no, yes, n…
$ credit_utilization              &lt;dbl&gt; -1.841097091, 2.786415973, -1.09378697…
$ acc_to_age_ratio                &lt;dbl&gt; 0.50174733, -0.54849606, -0.52980631, …
$ delinq_per_acc                  &lt;dbl&gt; -0.44991964, -0.44991964, -0.44991964,…
$ inq_rate                        &lt;dbl&gt; -0.520358012, 1.759991048, -0.52035801…
$ term_factor                     &lt;dbl&gt; 0.3219163, -0.6274559, 0.3219163, -0.6…
$ log_income                      &lt;dbl&gt; 2.44464243, 0.95097048, -0.59583257, 0…
$ payment_ratio                   &lt;dbl&gt; -0.70055763, -0.66316187, -0.18762635,…
$ util_to_income                  &lt;dbl&gt; -1.4271447, 1.7533431, -1.1717989, -1.…
$ home_ownership_OWN              &lt;dbl&gt; -0.4238857, -0.4238857, -0.4238857, -0…
$ home_ownership_RENT             &lt;dbl&gt; -0.8977787, -0.8977787, 1.1136746, 1.1…
$ loan_purpose_debt_consolidation &lt;dbl&gt; 1.1204596, -0.8923421, -0.8923421, -0.…
$ loan_purpose_home_improvement   &lt;dbl&gt; -0.3277222, -0.3277222, 3.0508567, -0.…
$ loan_purpose_major_purchase     &lt;dbl&gt; -0.2968579, -0.2968579, -0.2968579, -0…
$ loan_purpose_medical            &lt;dbl&gt; -0.299178, -0.299178, -0.299178, -0.29…
$ loan_purpose_other              &lt;dbl&gt; -0.2208157, -0.2208157, -0.2208157, -0…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify</span></span>
<span id="cb23-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table</span>(recipe_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>default)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  no  yes 
5661  339 </code></pre>
</div>
</div>
</section>
<section id="model-architecture-and-hyperparameter-optimization" class="level2">
<h2 class="anchored" data-anchor-id="model-architecture-and-hyperparameter-optimization">Model Architecture and Hyperparameter Optimization</h2>
<p>This section implements both traditional (logistic regression) and modern (XGBoost) algorithms. Logistic regression provides interpretability required for regulatory compliance, while XGBoost offers superior predictive performance. Both models undergo systematic hyperparameter tuning using cross-validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the logistic regression model</span></span>
<span id="cb25-2">log_reg_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logistic_reg</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">penalty =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mixture =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"glmnet"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span>)</span>
<span id="cb25-5"></span>
<span id="cb25-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a logistic regression workflow</span></span>
<span id="cb25-7">log_reg_workflow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span>(credit_recipe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span>(log_reg_spec)</span>
<span id="cb25-10"></span>
<span id="cb25-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the tuning grid for logistic regression</span></span>
<span id="cb25-12">log_reg_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_regular</span>(</span>
<span id="cb25-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">penalty</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trans =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10_trans</span>()),</span>
<span id="cb25-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mixture</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb25-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb25-16">)</span>
<span id="cb25-17"></span>
<span id="cb25-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the XGBoost model with tunable parameters</span></span>
<span id="cb25-19">xgb_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boost_tree</span>(</span>
<span id="cb25-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trees =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb25-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tree_depth =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb25-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb25-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_reduction =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb25-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mtry =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb25-25">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learn_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>()</span>
<span id="cb25-26">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xgboost"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">objective =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary:logistic"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span>)</span>
<span id="cb25-29"></span>
<span id="cb25-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an XGBoost workflow</span></span>
<span id="cb25-31">xgb_workflow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span>(credit_recipe) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span>(xgb_spec)</span>
<span id="cb25-34"></span>
<span id="cb25-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the tuning grid for XGBoost</span></span>
<span id="cb25-36">xgb_grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_latin_hypercube</span>(</span>
<span id="cb25-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trees</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)),</span>
<span id="cb25-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tree_depth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)),</span>
<span id="cb25-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min_n</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)),</span>
<span id="cb25-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss_reduction</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)),</span>
<span id="cb25-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mtry</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)),</span>
<span id="cb25-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">learn_rate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trans =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log10_trans</span>()),</span>
<span id="cb25-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb25-44">)</span>
<span id="cb25-45"></span>
<span id="cb25-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create cross-validation folds with stratification</span></span>
<span id="cb25-47"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">234</span>)</span>
<span id="cb25-48">cv_folds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> default)</span>
<span id="cb25-49"></span>
<span id="cb25-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the metrics to evaluate</span></span>
<span id="cb25-51">classification_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span>(</span>
<span id="cb25-52">  roc_auc,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Area under the ROC curve</span></span>
<span id="cb25-53">  pr_auc,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Area under the precision-recall curve</span></span>
<span id="cb25-54">)</span>
<span id="cb25-55"></span>
<span id="cb25-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tune the logistic regression model</span></span>
<span id="cb25-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">345</span>)</span>
<span id="cb25-58">log_reg_tuned <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune_grid</span>(</span>
<span id="cb25-59">  log_reg_workflow,</span>
<span id="cb25-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resamples =</span> cv_folds,</span>
<span id="cb25-61">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid =</span> log_reg_grid,</span>
<span id="cb25-62">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> classification_metrics,</span>
<span id="cb25-63">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">control_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">save_pred =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb25-64">)</span>
<span id="cb25-65"></span>
<span id="cb25-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tune the XGBoost model</span></span>
<span id="cb25-67"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">456</span>)</span>
<span id="cb25-68">xgb_tuned <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune_grid</span>(</span>
<span id="cb25-69">  xgb_workflow,</span>
<span id="cb25-70">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resamples =</span> cv_folds,</span>
<span id="cb25-71">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid =</span> xgb_grid,</span>
<span id="cb25-72">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> classification_metrics,</span>
<span id="cb25-73">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">control_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">save_pred =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb25-74">)</span>
<span id="cb25-75"></span>
<span id="cb25-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collect and visualize logistic regression tuning results</span></span>
<span id="cb25-77">log_reg_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log_reg_tuned <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>()</span>
<span id="cb25-78">log_reg_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(.metric <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
   penalty mixture .metric .estimator  mean     n std_err .config              
     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1 0.00167     1    roc_auc binary     0.853     3 0.00841 Preprocessor1_Model45
2 0.00167     0.75 roc_auc binary     0.853     3 0.00841 Preprocessor1_Model35
3 0.00599     0.25 roc_auc binary     0.853     3 0.00869 Preprocessor1_Model16
4 0.00167     0.5  roc_auc binary     0.853     3 0.00836 Preprocessor1_Model25
5 0.000464    1    roc_auc binary     0.852     3 0.00817 Preprocessor1_Model44
6 0.00167     0.25 roc_auc binary     0.852     3 0.00837 Preprocessor1_Model15</code></pre>
</div>
</div>
</section>
<section id="model-finalization-and-performance-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-finalization-and-performance-evaluation">Model Finalization and Performance Evaluation</h2>
<p>This section focuses on finalizing both models using their optimal hyperparameters and evaluating model performance on the validation dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select best hyperparameters based on ROC AUC</span></span>
<span id="cb27-2">best_log_reg_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(log_reg_tuned, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span>
<span id="cb27-3">best_xgb_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(xgb_tuned, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"roc_auc"</span>)</span>
<span id="cb27-4"></span>
<span id="cb27-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Finalize workflows with best parameters</span></span>
<span id="cb27-6">final_log_reg_workflow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log_reg_workflow <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_workflow</span>(best_log_reg_params)</span>
<span id="cb27-8"></span>
<span id="cb27-9">final_xgb_workflow <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xgb_workflow <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_workflow</span>(best_xgb_params)</span>
<span id="cb27-11"></span>
<span id="cb27-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit the final models on the full training data</span></span>
<span id="cb27-13">final_log_reg_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_log_reg_workflow <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split))</span>
<span id="cb27-15"></span>
<span id="cb27-16">final_xgb_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_xgb_workflow <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(validation_split))</span>
<span id="cb27-18"></span>
<span id="cb27-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make predictions on the validation set with both models</span></span>
<span id="cb27-20">log_reg_val_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_log_reg_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(final_log_reg_model, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prob"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(default, customer_id))</span>
<span id="cb27-24"></span>
<span id="cb27-25">xgb_val_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_xgb_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(final_xgb_model, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prob"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(validation_split) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(default, customer_id))</span>
<span id="cb27-29"></span>
<span id="cb27-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate model performance on validation set</span></span>
<span id="cb27-31">log_reg_val_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log_reg_val_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb27-33"></span>
<span id="cb27-34">xgb_val_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xgb_val_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb27-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb27-36"></span>
<span id="cb27-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression Validation Metrics:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Logistic Regression Validation Metrics:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(log_reg_val_metrics)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.950
2 kap         binary         0.145
3 mn_log_loss binary         3.64 
4 roc_auc     binary         0.157</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">XGBoost Validation Metrics:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
XGBoost Validation Metrics:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(xgb_val_metrics)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.948
2 kap         binary         0.111
3 mn_log_loss binary         3.24 
4 roc_auc     binary         0.172</code></pre>
</div>
</div>
</section>
<section id="interpretability-and-feature-importance" class="level2">
<h2 class="anchored" data-anchor-id="interpretability-and-feature-importance">Interpretability and Feature Importance</h2>
<p>Understanding feature contributions to prediction outcomes represents a critical requirement for credit scoring models, particularly for regulatory compliance and business decision-making.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract feature importance from XGBoost model</span></span>
<span id="cb35-2">xgb_importance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_xgb_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_fit_parsnip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb35-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vip</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_features =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb35-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XGBoost Feature Importance"</span>)</span>
<span id="cb35-6"></span>
<span id="cb35-7">xgb_importance</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/feature-importance-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract coefficients from logistic regression model</span></span>
<span id="cb36-2">log_reg_importance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_log_reg_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_fit_parsnip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vip</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_features =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb36-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression Coefficient Importance"</span>)</span>
<span id="cb36-6"></span>
<span id="cb36-7">log_reg_importance</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/feature-importance-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create calibration plots for both models</span></span>
<span id="cb37-2">log_reg_cal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> log_reg_val_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_plot_breaks</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_yes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"second"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Logistic Regression Probability Calibration"</span>)</span>
<span id="cb37-5"></span>
<span id="cb37-6">xgb_cal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xgb_val_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb37-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_plot_breaks</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_yes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"second"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb37-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XGBoost Probability Calibration"</span>)</span>
<span id="cb37-9"></span>
<span id="cb37-10">log_reg_cal</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/feature-importance-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">xgb_cal</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/feature-importance-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="test-set-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="test-set-evaluation">Test Set Evaluation</h2>
<p>The final evaluation employs the optimal model (XGBoost) on the held-out test dataset to provide an unbiased assessment of generalization performance and operational effectiveness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make predictions on the test set with the XGBoost model</span></span>
<span id="cb39-2">test_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> final_xgb_model <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(test_data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb39-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(final_xgb_model, test_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prob"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb39-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(test_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(default, customer_id, credit_score))</span>
<span id="cb39-6"></span>
<span id="cb39-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate performance metrics</span></span>
<span id="cb39-8">test_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb39-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metrics</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb39-10"></span>
<span id="cb39-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Test Set Performance Metrics:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final Test Set Performance Metrics:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(test_metrics)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary        0.932 
2 kap         binary        0.0316
3 mn_log_loss binary        3.21  
4 roc_auc     binary        0.172 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate AUC on test set</span></span>
<span id="cb43-2">test_auc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb43-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">roc_auc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> default, .pred_yes)</span>
<span id="cb43-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Test Set ROC AUC: "</span>, test_auc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>.estimate, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Test Set ROC AUC:  0.1723324 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a gains table (commonly used in credit scoring)</span></span>
<span id="cb45-2">gains_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb45-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_decile =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ntile</span>(.pred_yes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb45-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(risk_decile) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb45-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb45-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_accounts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb45-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">defaults =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(default <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>),</span>
<span id="cb45-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">non_defaults =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(default <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no"</span>),</span>
<span id="cb45-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(default <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yes"</span>),</span>
<span id="cb45-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_score =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(credit_score)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(default_rate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb45-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb45-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cumulative_defaults =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(defaults),</span>
<span id="cb45-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pct_defaults_captured =</span> cumulative_defaults <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(defaults),</span>
<span id="cb45-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cumulative_accounts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(total_accounts),</span>
<span id="cb45-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pct_accounts =</span> cumulative_accounts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(total_accounts),</span>
<span id="cb45-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lift =</span> default_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(defaults) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(total_accounts))</span>
<span id="cb45-18">  )</span>
<span id="cb45-19"></span>
<span id="cb45-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the gains table</span></span>
<span id="cb45-21">gains_table</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 11
   risk_decile total_accounts defaults non_defaults default_rate avg_score
         &lt;int&gt;          &lt;int&gt;    &lt;int&gt;        &lt;int&gt;        &lt;dbl&gt;     &lt;dbl&gt;
 1          10            200       58          142        0.29       577.
 2           9            200       26          174        0.13       628.
 3           8            200       19          181        0.095      640.
 4           7            200        8          192        0.04       665.
 5           6            200        7          193        0.035      682.
 6           4            200        6          194        0.03       727.
 7           2            200        2          198        0.01       776.
 8           5            200        2          198        0.01       716.
 9           1            200        1          199        0.005      790.
10           3            200        1          199        0.005      757.
# ℹ 5 more variables: cumulative_defaults &lt;int&gt;, pct_defaults_captured &lt;dbl&gt;,
#   cumulative_accounts &lt;int&gt;, pct_accounts &lt;dbl&gt;, lift &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a lift chart</span></span>
<span id="cb47-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(gains_table, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> pct_accounts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lift)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb47-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lift Chart"</span>,</span>
<span id="cb47-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage of Accounts"</span>,</span>
<span id="cb47-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lift"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/modeling-with-tidymodels_files/figure-html/final-evaluation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>The tidymodels ecosystem provides a unified approach</strong> to machine learning workflows, ensuring consistency and reproducibility across model development phases</li>
<li><strong>Domain knowledge integration is critical</strong> for effective feature engineering</li>
<li><strong>Comparative modeling approaches enhance decision-making</strong> by balancing interpretability requirements with predictive performance needs</li>
<li><strong>Systematic hyperparameter optimization improves model performance</strong> while preventing overfitting through cross-validation techniques</li>
<li><strong>Comprehensive evaluation frameworks ensure robust assessment</strong> of model generalization and operational effectiveness</li>
<li><strong>Model interpretability analysis supports regulatory compliance</strong> and business decision-making in financial applications</li>
</ul>


</section>

 ]]></description>
  <category>R</category>
  <category>Machine Learning</category>
  <category>tidymodels</category>
  <guid>https://rtichoke.netlify.app/posts/modeling-with-tidymodels.html</guid>
  <pubDate>Fri, 11 Oct 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/tidymodels.png" medium="image" type="image/png" height="166" width="144"/>
</item>
<item>
  <title>Optimizing XGBoost Hyperparameters Using Bayesian Optimization in R</title>
  <link>https://rtichoke.netlify.app/posts/bayesian-optimization-xgboost.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Hyperparameter tuning for machine learning models represents a computationally intensive and time-consuming process. This tutorial demonstrates the implementation of Bayesian optimization techniques to efficiently identify optimal XGBoost hyperparameters, thereby reducing computational overhead while enhancing model performance. The methodology presented provides a systematic approach to hyperparameter optimization that significantly outperforms traditional grid search methods.</p>
</section>
<section id="package-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="package-dependencies">Package Dependencies</h2>
<p>This tutorial requires several specialized R packages for machine learning, optimization, and data preprocessing. The following packages must be installed and loaded before proceeding with the implementation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xgboost)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ParBayesianOptimization)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mlbench)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recipes)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rsample)</span></code></pre></div>
</div>
</section>
<section id="data-acquisition-and-initial-processing" class="level2">
<h2 class="anchored" data-anchor-id="data-acquisition-and-initial-processing">Data Acquisition and Initial Processing</h2>
<p>This tutorial utilizes the Boston Housing dataset, a canonical regression problem that incorporates both numerical and categorical variables. This dataset provides an appropriate foundation for demonstrating Bayesian optimization techniques in a supervised learning context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the Boston Housing dataset</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BostonHousing2"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick look at the data structure</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(BostonHousing2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   506 obs. of  19 variables:
 $ town   : Factor w/ 92 levels "Arlington","Ashland",..: 54 77 77 46 46 46 69 69 69 69 ...
 $ tract  : int  2011 2021 2022 2031 2032 2033 2041 2042 2043 2044 ...
 $ lon    : num  -71 -71 -70.9 -70.9 -70.9 ...
 $ lat    : num  42.3 42.3 42.3 42.3 42.3 ...
 $ medv   : num  24 21.6 34.7 33.4 36.2 28.7 22.9 27.1 16.5 18.9 ...
 $ cmedv  : num  24 21.6 34.7 33.4 36.2 28.7 22.9 22.1 16.5 18.9 ...
 $ crim   : num  0.00632 0.02731 0.02729 0.03237 0.06905 ...
 $ zn     : num  18 0 0 0 0 0 12.5 12.5 12.5 12.5 ...
 $ indus  : num  2.31 7.07 7.07 2.18 2.18 2.18 7.87 7.87 7.87 7.87 ...
 $ chas   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...
 $ nox    : num  0.538 0.469 0.469 0.458 0.458 0.458 0.524 0.524 0.524 0.524 ...
 $ rm     : num  6.58 6.42 7.18 7 7.15 ...
 $ age    : num  65.2 78.9 61.1 45.8 54.2 58.7 66.6 96.1 100 85.9 ...
 $ dis    : num  4.09 4.97 4.97 6.06 6.06 ...
 $ rad    : int  1 2 2 3 3 3 5 5 5 5 ...
 $ tax    : int  296 242 242 222 222 222 311 311 311 311 ...
 $ ptratio: num  15.3 17.8 17.8 18.7 18.7 18.7 15.2 15.2 15.2 15.2 ...
 $ b      : num  397 397 393 395 397 ...
 $ lstat  : num  4.98 9.14 4.03 2.94 5.33 ...</code></pre>
</div>
</div>
<p>XGBoost algorithms require numerical input features exclusively. Therefore, we employ the <code>recipes</code> package to systematically transform categorical variables through appropriate preprocessing techniques:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a recipe for preprocessing</span></span>
<span id="cb4-2">rec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(cmedv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> BostonHousing2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Collapse categories where population is &lt; 3%</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_other</span>(town, chas, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threshold =</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">03</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">other =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create dummy variables for all factor variables </span></span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_dummy</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal_predictors</span>())</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train the recipe on the dataset</span></span>
<span id="cb4-9">prep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span>(rec, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">training =</span> BostonHousing2)</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the final model matrix</span></span>
<span id="cb4-12">model_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span>(prep, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new_data =</span> BostonHousing2)</span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the column names after one-hot encoding</span></span>
<span id="cb4-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(model_df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "tract"                  "lon"                    "lat"                   
 [4] "medv"                   "crim"                   "zn"                    
 [7] "indus"                  "nox"                    "rm"                    
[10] "age"                    "dis"                    "rad"                   
[13] "tax"                    "ptratio"                "b"                     
[16] "lstat"                  "cmedv"                  "town_Boston.Savin.Hill"
[19] "town_Cambridge"         "town_Lynn"              "town_Newton"           
[22] "town_Other"             "chas_X1"               </code></pre>
</div>
</div>
<p>Subsequently, we partition the dataset into training and testing subsets to enable proper model evaluation and prevent data leakage:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a 70/30 train-test split</span></span>
<span id="cb6-2">splits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span>(model_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span>
<span id="cb6-3">train_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(splits)</span>
<span id="cb6-4">test_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(splits)</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare the training data for XGBoost</span></span>
<span id="cb6-7">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> train_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>medv, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>cmedv) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>()</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the target variable</span></span>
<span id="cb6-12">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> train_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(cmedv)</span>
<span id="cb6-13"></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create cross-validation folds</span></span>
<span id="cb6-15">folds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fold1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)),</span>
<span id="cb6-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fold2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb6-18">)</span></code></pre></div>
</div>
</section>
<section id="bayesian-optimization-framework-implementation" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-optimization-framework-implementation">Bayesian Optimization Framework Implementation</h2>
<p>The implementation of Bayesian optimization requires the development of two fundamental components:</p>
<ol type="1">
<li><strong>Objective Function</strong>: A function that evaluates model performance for given hyperparameter configurations</li>
<li><strong>Parameter Space Definition</strong>: The bounds and constraints that define the search space for optimization</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Our objective function takes hyperparameters as inputs</span></span>
<span id="cb7-2">obj_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(eta, max_depth, min_child_weight, subsample, lambda, alpha) {</span>
<span id="cb7-3">  </span>
<span id="cb7-4">  param <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning parameters</span></span>
<span id="cb7-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eta =</span> eta,                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning rate</span></span>
<span id="cb7-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> max_depth,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tree depth</span></span>
<span id="cb7-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_child_weight =</span> min_child_weight, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Min observations per node</span></span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subsample =</span> subsample,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data subsampling</span></span>
<span id="cb7-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> lambda,                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># L2 regularization</span></span>
<span id="cb7-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> alpha,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># L1 regularization</span></span>
<span id="cb7-12">    </span>
<span id="cb7-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">booster =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gbtree"</span>,             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use tree model</span></span>
<span id="cb7-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">objective =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reg:squarederror"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regression task</span></span>
<span id="cb7-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eval_metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mape"</span>            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean Absolute Percentage Error</span></span>
<span id="cb7-16">  )</span>
<span id="cb7-17">  </span>
<span id="cb7-18">  xgbcv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgb.cv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> param,</span>
<span id="cb7-19">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X,</span>
<span id="cb7-20">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> y,</span>
<span id="cb7-21">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nround =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb7-22">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">folds =</span> folds,</span>
<span id="cb7-23">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prediction =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb7-24">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">early_stopping_rounds =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb7-25">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-26">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maximize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb7-27">  </span>
<span id="cb7-28">  lst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First argument must be named as "Score"</span></span>
<span id="cb7-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function finds maxima so inverting the output</span></span>
<span id="cb7-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Score =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(xgbcv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>evaluation_log<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>test_mape_mean),</span>
<span id="cb7-32">    </span>
<span id="cb7-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get number of trees for the best performing model</span></span>
<span id="cb7-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrounds =</span> xgbcv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>best_iteration</span>
<span id="cb7-35">  )</span>
<span id="cb7-36">  </span>
<span id="cb7-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(lst)</span>
<span id="cb7-38">}</span>
<span id="cb7-39"></span>
<span id="cb7-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the search space for each parameter</span></span>
<span id="cb7-41">bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>),             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Learning rate range</span></span>
<span id="cb7-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>L, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>L),           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tree depth range</span></span>
<span id="cb7-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_child_weight =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>),      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Min observations range</span></span>
<span id="cb7-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subsample =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Subsampling range</span></span>
<span id="cb7-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># L2 regularization range</span></span>
<span id="cb7-47">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># L1 regularization range</span></span>
<span id="cb7-48">)</span></code></pre></div>
</div>
</section>
<section id="executing-the-optimization-process" class="level2">
<h2 class="anchored" data-anchor-id="executing-the-optimization-process">Executing the Optimization Process</h2>
<p>The optimization procedure employs intelligent search strategies to systematically explore the hyperparameter space, utilizing Gaussian process modeling to predict promising parameter combinations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>)</span>
<span id="cb8-2">bayes_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bayesOpt</span>(</span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> obj_func,                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Our objective function</span></span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bounds =</span> bounds,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter bounds</span></span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initPoints =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bounds) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial random points</span></span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iters.n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of iterations</span></span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Suppress output</span></span>
<span id="cb8-8">)</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># View top results</span></span>
<span id="cb8-11">bayes_out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>scoreSummary[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>)]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          eta max_depth min_child_weight subsample   lambda    alpha      Score
        &lt;num&gt;     &lt;num&gt;            &lt;num&gt;     &lt;num&gt;    &lt;num&gt;    &lt;num&gt;      &lt;num&gt;
1: 0.13392137         8         4.913332 0.2105925 4.721124 3.887629 -0.1292920
2: 0.19400811         2        25.454160 0.9594105 9.329695 3.173695 -0.1790158
3: 0.16079775         2        14.035652 0.5118349 1.229953 5.093530 -0.1662595
4: 0.08957707         4        12.534842 0.3844404 4.358837 1.788342 -0.1672395
5: 0.02876388         4        36.586761 0.8107181 6.137100 6.039125 -0.3320015</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the best parameters</span></span>
<span id="cb10-2">best_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBestPars</span>(bayes_out)</span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(best_params)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        eta max_depth min_child_weight subsample lambda    alpha
1 0.1251447        10                1         1      1 5.905011</code></pre>
</div>
</div>
</section>
<section id="final-model-development-and-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="final-model-development-and-evaluation">Final Model Development and Evaluation</h2>
<p>Upon identification of optimal hyperparameter configurations, we proceed to train the final XGBoost model and evaluate its performance on the held-out test dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine best params with base params</span></span>
<span id="cb12-2">opt_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(</span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">booster =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gbtree"</span>, </span>
<span id="cb12-4">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">objective =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reg:squarederror"</span>, </span>
<span id="cb12-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eval_metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mae"</span>), </span>
<span id="cb12-6">  best_params</span>
<span id="cb12-7">)</span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run cross-validation to determine optimal number of rounds</span></span>
<span id="cb12-10">xgbcv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgb.cv</span>(</span>
<span id="cb12-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> opt_params,</span>
<span id="cb12-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X,</span>
<span id="cb12-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> y,</span>
<span id="cb12-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nround =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb12-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">folds =</span> folds,</span>
<span id="cb12-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prediction =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb12-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">early_stopping_rounds =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb12-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maximize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb12-20">)</span>
<span id="cb12-21"></span>
<span id="cb12-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get optimal number of rounds</span></span>
<span id="cb12-23">nrounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> xgbcv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>best_iteration</span>
<span id="cb12-24"></span>
<span id="cb12-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit the final XGBoost model</span></span>
<span id="cb12-26">mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgboost</span>(</span>
<span id="cb12-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X, </span>
<span id="cb12-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> y, </span>
<span id="cb12-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> opt_params, </span>
<span id="cb12-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maximize =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb12-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">early_stopping_rounds =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, </span>
<span id="cb12-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrounds =</span> nrounds, </span>
<span id="cb12-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb12-34">)</span>
<span id="cb12-35"></span>
<span id="cb12-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make predictions on the test set</span></span>
<span id="cb12-37">actuals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cmedv</span>
<span id="cb12-38">predicted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_at</span>(mdl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>feature_names) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> .)</span>
<span id="cb12-42"></span>
<span id="cb12-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate performance using Mean Absolute Percentage Error (MAPE)</span></span>
<span id="cb12-44">mape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(actuals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> predicted)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>actuals)</span>
<span id="cb12-45"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MAPE on test set:"</span>, mape)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAPE on test set: 0.006424492</code></pre>
</div>
</div>
</section>
<section id="key-advantages-of-bayesian-optimization" class="level2">
<h2 class="anchored" data-anchor-id="key-advantages-of-bayesian-optimization">Key Advantages of Bayesian Optimization</h2>
<p>Bayesian optimization demonstrates significant superiority over conventional hyperparameter tuning methodologies, particularly grid search approaches:</p>
<ol type="1">
<li><strong>Computational Efficiency</strong>: Achieves optimal parameter identification through substantially fewer iterations</li>
<li><strong>Adaptive Learning</strong>: Incorporates knowledge from previous evaluations to concentrate search efforts on promising parameter regions</li>
<li><strong>Scalability</strong>: Maintains computational efficiency regardless of hyperparameter dimensionality</li>
<li><strong>Time Optimization</strong>: Completes optimization procedures in significantly reduced timeframes while achieving equivalent or superior performance outcomes</li>
</ol>
<section id="practical-considerations" class="level3">
<h3 class="anchored" data-anchor-id="practical-considerations">Practical Considerations</h3>
<p>This methodology becomes increasingly critical as model complexity and hyperparameter spaces expand. For production environments, increasing the iteration count (<code>iters.n</code>) could help ensure comprehensive exploration of the parameter landscape.</p>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>Gaussian process modeling enables intelligent parameter space exploration</strong> by learning from previous evaluations</li>
<li><strong>Proper data preprocessing is critical</strong> for XGBoost implementation, particularly categorical variable encoding</li>
<li><strong>Cross-validation integration ensures robust hyperparameter evaluation</strong> and prevents overfitting to specific data partitions</li>
<li><strong>The methodology scales effectively</strong> to high-dimensional hyperparameter spaces without proportional computational increases</li>
<li><strong>Production implementations benefit from increased iteration counts</strong> to ensure thorough parameter space exploration</li>
</ul>
<p>This technique can extend beyond XGBoost to any machine learning algorithm requiring hyperparameter optimization, providing a foundation for efficient model development across diverse analytical contexts.</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Analytics</category>
  <category>Machine Learning</category>
  <guid>https://rtichoke.netlify.app/posts/bayesian-optimization-xgboost.html</guid>
  <pubDate>Tue, 17 Sep 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/bayesian_opt.png" medium="image" type="image/png" height="167" width="144"/>
</item>
<item>
  <title>Implementing Particle Swarm Optimization from Scratch in R</title>
  <link>https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Nature-inspired optimization algorithms demonstrate remarkable efficiency in solving complex optimization problems. This post provides a implementation of Particle Swarm Optimization (PSO) from fundamental principles in R. The methodology presented enables efficient exploration of complex solution spaces through coordinated swarm intelligence.</p>
</section>
<section id="package-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="package-dependencies">Package Dependencies</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For data manipulation</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For visualization</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gganimate) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For animations</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(metR)      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For geom_arrow</span></span></code></pre></div>
</div>
</section>
<section id="optimization-test-function-ackleys-function" class="level2">
<h2 class="anchored" data-anchor-id="optimization-test-function-ackleys-function">Optimization Test Function: Ackley’s Function</h2>
<p>This tutorial employs Ackley’s function as the optimization benchmark—a challenging multimodal function characterized by numerous local minima that frequently entrap conventional optimization algorithms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">obj_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x, y){</span>
<span id="cb2-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Modified Ackley function with global minimum at (1,1)</span></span>
<span id="cb2-3">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>((x<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (y<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> </span>
<span id="cb2-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>y))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb2-5">}</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a visualization grid</span></span>
<span id="cb2-8">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb2-9">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb2-10">grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stringsAsFactors =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb2-11">grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obj_func</span>(grid[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], grid[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a contour plot</span></span>
<span id="cb2-14">contour_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(grid, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Var1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Var2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_contour_filled</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> z), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spectral"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ackley's Function"</span>)</span>
<span id="cb2-19"></span>
<span id="cb2-20">contour_plot</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="theoretical-foundation-of-particle-swarm-optimization" class="level2">
<h2 class="anchored" data-anchor-id="theoretical-foundation-of-particle-swarm-optimization">Theoretical Foundation of Particle Swarm Optimization</h2>
<p>PSO emulates the collective foraging behavior of biological swarms through the integration of individual memory with social information sharing:</p>
<ol type="1">
<li><strong>Initialization</strong>: Random distribution of particles across the search space</li>
<li><strong>Memory Mechanism</strong>: Each particle maintains a record of its personal best position</li>
<li><strong>Information Sharing</strong>: The swarm collectively maintains knowledge of the global best position</li>
<li><strong>Movement Dynamics</strong>: Particles adjust their trajectories based on both personal experience and collective knowledge</li>
</ol>
<p>The velocity update equation represents a balance of three fundamental forces:</p>
<p><img src="https://latex.codecogs.com/png.latex?v_%7Bnew%7D%20=%20w%20%5Ccdot%20v_%7Bcurrent%7D%20+%20c_1%20%5Ccdot%20r_1%20%5Ccdot%20(p_%7Bbest%7D%20-%20p_%7Bcurrent%7D)%20+%20c_2%20%5Ccdot%20r_2%20%5Ccdot%20(g_%7Bbest%7D%20-%20p_%7Bcurrent%7D)"></p>
<p>Where:</p>
<ul>
<li><code>w</code>: Inertia (momentum preservation)</li>
<li><code>c1</code>: Personal influence (individual memory)</li>
<li><code>c2</code>: Social influence (collective cooperation)</li>
<li><code>r1,r2</code>: Stochastic components</li>
</ul>
</section>
<section id="sample-implementation" class="level2">
<h2 class="anchored" data-anchor-id="sample-implementation">Sample Implementation</h2>
<section id="swarm-initialization" class="level3">
<h3 class="anchored" data-anchor-id="swarm-initialization">Swarm Initialization</h3>
<p>The initial phase involves creating a randomized swarm of particles and distributing them across the defined search space:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set parameters</span></span>
<span id="cb3-2">n_particles <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb3-3">w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inertia weight</span></span>
<span id="cb3-4">c1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Personal learning rate</span></span>
<span id="cb3-5">c2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Social learning rate</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create random particle positions</span></span>
<span id="cb3-8">x_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb3-9">y_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb3-10">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(x_range, n_particles, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>),</span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(y_range, n_particles, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-13">)</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize initial positions</span></span>
<span id="cb3-16">contour_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(x, y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Initial Particle Positions"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="global-best-position-and-velocity-initialization" class="level3">
<h3 class="anchored" data-anchor-id="global-best-position-and-velocity-initialization">Global Best Position and Velocity Initialization</h3>
<p>Next, we need to track each particle’s personal best position and the swarm’s global best position, while initializing velocity vectors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize random velocities</span></span>
<span id="cb4-2">dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n_particles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set initial personal best positions</span></span>
<span id="cb4-5">pbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X</span>
<span id="cb4-6">pbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obj_func</span>(X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find global best position</span></span>
<span id="cb4-9">gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj),]</span>
<span id="cb4-10">gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize with arrows showing pull toward global best</span></span>
<span id="cb4-13">X_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_x =</span> gbest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb4-15">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_y =</span> gbest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb4-16">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">atan</span>((g_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(g_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>pi,</span>
<span id="cb4-17">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(g_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> angle, angle))</span>
<span id="cb4-18"></span>
<span id="cb4-19">contour_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(x, y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X_dir, </span>
<span id="cb4-22">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, </span>
<span id="cb4-23">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(angle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>), </span>
<span id="cb4-24">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(angle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>)), </span>
<span id="cb4-25">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)), </span>
<span id="cb4-26">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Forces Acting on Particles"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="position-update-mechanism" class="level3">
<h3 class="anchored" data-anchor-id="position-update-mechanism">Position Update Mechanism</h3>
<p>The position update process implements the core PSO algorithm, calculating new velocities based on the fundamental equation and updating particle positions accordingly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate new velocities using PSO equation</span></span>
<span id="cb5-2">dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-3">      c1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(pbest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-4">      c2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(gbest) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update positions</span></span>
<span id="cb5-7">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dX</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate function at new positions</span></span>
<span id="cb5-10">obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obj_func</span>(X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update personal best positions if improved</span></span>
<span id="cb5-13">idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> pbest_obj)</span>
<span id="cb5-14">pbest[idx,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[idx,]</span>
<span id="cb5-15">pbest_obj[idx] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj[idx]</span>
<span id="cb5-16"></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update global best position</span></span>
<span id="cb5-18">idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj)</span>
<span id="cb5-19">gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[idx,]</span>
<span id="cb5-20">gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)</span>
<span id="cb5-21"></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize updated positions</span></span>
<span id="cb5-23">X_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_x =</span> gbest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb5-25">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_y =</span> gbest[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], </span>
<span id="cb5-26">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">atan</span>((g_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(g_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>pi,</span>
<span id="cb5-27">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(g_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> angle, angle))</span>
<span id="cb5-28"></span>
<span id="cb5-29">contour_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(x, y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> X_dir, </span>
<span id="cb5-32">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, </span>
<span id="cb5-33">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(angle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>), </span>
<span id="cb5-34">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(angle<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span>)), </span>
<span id="cb5-35">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)), </span>
<span id="cb5-36">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Particles After First Update"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="full-implementation" class="level2">
<h2 class="anchored" data-anchor-id="full-implementation">Full Implementation</h2>
<p>The following implementation encapsulates the complete PSO algorithm within a reusable function framework:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">pso_optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(obj_func,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to minimize</span></span>
<span id="cb6-2">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Personal learning rate</span></span>
<span id="cb6-3">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Social learning rate</span></span>
<span id="cb6-4">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inertia weight</span></span>
<span id="cb6-5">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_particles =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Swarm size</span></span>
<span id="cb6-6">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init_fact =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial velocity factor</span></span>
<span id="cb6-7">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum iterations</span></span>
<span id="cb6-8">){</span>
<span id="cb6-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define search domain</span></span>
<span id="cb6-10">  x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb6-11">  y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb6-12">  </span>
<span id="cb6-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize particles</span></span>
<span id="cb6-14">  X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(x, n_particles, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>),</span>
<span id="cb6-15">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(y, n_particles, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span>
<span id="cb6-16">  dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n_particles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> init_fact, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-17">  </span>
<span id="cb6-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize best positions</span></span>
<span id="cb6-19">  pbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X</span>
<span id="cb6-20">  pbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obj_func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb6-21">  gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj),]</span>
<span id="cb6-22">  gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)</span>
<span id="cb6-23">  </span>
<span id="cb6-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store positions for visualization</span></span>
<span id="cb6-25">  loc_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-26">  iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-27">  </span>
<span id="cb6-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Main optimization loop</span></span>
<span id="cb6-29">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span>(iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n_iter){</span>
<span id="cb6-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update velocities</span></span>
<span id="cb6-31">    dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-32">          c1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(pbest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-33">          c2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(gbest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(X))</span>
<span id="cb6-34">    </span>
<span id="cb6-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update positions</span></span>
<span id="cb6-36">    X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dX</span>
<span id="cb6-37">    </span>
<span id="cb6-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate and update best positions</span></span>
<span id="cb6-39">    obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obj_func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> X[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb6-40">    idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> pbest_obj)</span>
<span id="cb6-41">    pbest[idx,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[idx,]</span>
<span id="cb6-42">    pbest_obj[idx] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj[idx]</span>
<span id="cb6-43">    </span>
<span id="cb6-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update global best</span></span>
<span id="cb6-45">    idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj)</span>
<span id="cb6-46">    gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[idx,]</span>
<span id="cb6-47">    gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)</span>
<span id="cb6-48">    </span>
<span id="cb6-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store for visualization</span></span>
<span id="cb6-50">    iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-51">    loc_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(loc_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> iter))</span>
<span id="cb6-52">  }</span>
<span id="cb6-53">  </span>
<span id="cb6-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> loc_df, </span>
<span id="cb6-55">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> gbest_obj, </span>
<span id="cb6-56">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj_loc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(gbest, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>)))</span>
<span id="cb6-57">}</span></code></pre></div>
</div>
<p>The following code snippet applies the PSO algorithm to the Ackley function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the PSO algorithm</span></span>
<span id="cb7-2">out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pso_optim</span>(obj_func,</span>
<span id="cb7-3">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Low personal influence</span></span>
<span id="cb7-4">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Moderate social influence</span></span>
<span id="cb7-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Medium inertia</span></span>
<span id="cb7-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_particles =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb7-7">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init_fact =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb7-8">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the result (global minimum should be at (1,1))</span></span>
<span id="cb7-11">out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obj_loc</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1.00000238859683,0.999992817623097"</code></pre>
</div>
</div>
</section>
<section id="visualising-swarm-behavior" class="level2">
<h2 class="anchored" data-anchor-id="visualising-swarm-behavior">Visualising Swarm Behavior</h2>
<p>The optimization process can be effectively visualized through animation, demonstrating the collective convergence behavior of the particle swarm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create animation of the optimization process</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_contour</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> grid, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Var1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Var2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> z), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(X1, X2)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transition_time</span>(iter) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ease_aes</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linear"</span>)</span></code></pre></div>
</div>
<p><img src="https://rtichoke.netlify.app/images/pso_anim.gif" class="img-fluid"></p>
</section>
<section id="parameter-optimization-and-algorithm-tuning" class="level2">
<h2 class="anchored" data-anchor-id="parameter-optimization-and-algorithm-tuning">Parameter Optimization and Algorithm Tuning</h2>
<p>The PSO algorithm’s performance characteristics can be substantially modified through systematic adjustment of three parameters:</p>
<ol type="1">
<li><strong>Inertia Weight (w)</strong>
<ul>
<li>High values (&gt;0.8): Particles maintain substantial momentum, aiding extensive exploration</li>
<li>Low values (&lt;0.4): Particles exhibit reduced momentum, facilitating solution refinement</li>
</ul></li>
<li><strong>Personal Learning Rate (c1)</strong>
<ul>
<li>High values: Particles prioritize individual discoveries and historical performance</li>
<li>Low values: Particles demonstrate reduced reliance on personal experience</li>
</ul></li>
<li><strong>Social Learning Rate (c2)</strong>
<ul>
<li>High values: Particles demonstrate strong attraction toward the global optimum</li>
<li>Low values: Particles maintain greater independence in exploration</li>
</ul></li>
</ol>
</section>
<section id="implementation-considerations" class="level2">
<h2 class="anchored" data-anchor-id="implementation-considerations">Implementation Considerations</h2>
<ul>
<li><strong>Boundary Constraint Implementation</strong>: Enforce particle confinement within valid solution regions</li>
<li><strong>Adaptive Parameter Strategies</strong>: Implement dynamic parameter adjustment during optimization execution</li>
<li><strong>Convergence-Based Termination</strong>: Establish sophisticated stopping criteria based on solution convergence</li>
<li><strong>High-Dimensional Extension</strong>: Adapt the algorithm for complex, multi-dimensional optimization problems</li>
</ul>
<blockquote class="blockquote">
<p>The R package <a href="https://cran.r-project.org/web/packages/pso/index.html"><code>pso</code></a> provides a comprehensive, production-ready implementation suitable for industrial applications.</p>
</blockquote>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>PSO successfully emulates biological swarm intelligence</strong> through mathematical modeling of collective behavior patterns</li>
<li><strong>The velocity update equation balances three critical forces</strong>: inertia, personal experience, and social influence</li>
<li><strong>Parameter tuning significantly affects algorithm performance</strong>, with distinct configurations optimizing exploration versus exploitation</li>
<li><strong>The algorithm scales effectively to high-dimensional problems</strong> while maintaining computational efficiency</li>
<li><strong>Production implementations require boundary constraints and adaptive parameters</strong> for robust performance</li>
</ul>


</section>

 ]]></description>
  <category>R</category>
  <category>Optimization</category>
  <category>Visualization</category>
  <guid>https://rtichoke.netlify.app/posts/building-particle-swarm-optimizer.html</guid>
  <pubDate>Sun, 21 Jul 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/pso_anim.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Developing Custom Charting Functions with ggplot2</title>
  <link>https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>While R provides numerous options for two-dimensional graphics and data visualization, <code>ggplot2</code> offers great functionality, features, and visual quality. This tutorial shows how to develop customized charting functions for specific visualization types, utilizing <code>ggplot2</code> as the foundational visualization engine. The approach enables the creation of reusable, standardized visualization components suitable for production environments and analytical workflows.</p>
</section>
<section id="package-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="package-dependencies">Package Dependencies</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(stringr)</span></code></pre></div>
</div>
</section>
<section id="dataset-acquisition-and-preparation" class="level2">
<h2 class="anchored" data-anchor-id="dataset-acquisition-and-preparation">Dataset Acquisition and Preparation</h2>
<p>This tutorial utilizes a summarized version of the COVID-19 Data Repository maintained by <a href="https://github.com/CSSEGISandData/COVID-19">Johns Hopkins University</a> to demonstrate custom charting function development.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load COVID-19 data</span></span>
<span id="cb2-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://bit.ly/3G8G63u"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get top 5 countries by death count</span></span>
<span id="cb2-5">top_countries <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(deaths_daily)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">top_n</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-9">  .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(top_countries)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Brazil" "India"  "Mexico" "Russia" "US"    </code></pre>
</div>
</div>
<p>Subsequently, we prepare the dataset for visualization by calculating a 7-day centered moving average of daily confirmed cases for the identified top five countries:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a data frame with the required information</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note that a centered 7-day moving average is used</span></span>
<span id="cb4-3">plotdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%m/%d/%Y"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> top_countries) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(confirmed_daily)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(country, date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MA =</span> zoo<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rollapply</span>(count, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">align =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>))</span></code></pre></div>
</div>
</section>
<section id="fundamental-line-chart-function-development" class="level2">
<h2 class="anchored" data-anchor-id="fundamental-line-chart-function-development">Fundamental Line Chart Function Development</h2>
<p>The initial implementation demonstrates the creation of a basic line chart function. Note the utilization of <code>aes_string()</code> instead of <code>aes()</code>, which enables the provision of arguments to <code>ggplot2</code> as string parameters, thereby enhancing function flexibility and programmability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function definition</span></span>
<span id="cb5-2">line_chart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df, </span>
<span id="cb5-3">                       x, </span>
<span id="cb5-4">                       y, </span>
<span id="cb5-5">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group_color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb5-6">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb5-7">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_type =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb5-8">  </span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(x), </span>
<span id="cb5-10">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(y), </span>
<span id="cb5-11">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(group_color))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> line_width, </span>
<span id="cb5-13">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> line_type)</span>
<span id="cb5-14">}</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test run</span></span>
<span id="cb5-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">line_chart</span>(plotdf,</span>
<span id="cb5-18">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>,</span>
<span id="cb5-19">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MA"</span>,</span>
<span id="cb5-20">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>, </span>
<span id="cb5-21">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_type =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb5-22">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2_files/figure-html/line-chart-basic-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="custom-theme-development" class="level2">
<h2 class="anchored" data-anchor-id="custom-theme-development">Custom Theme Development</h2>
<p>Having established the methodology for encapsulating <code>ggplot2</code> calls within intuitive function wrappers, we proceed to develop a customized theme framework for our visualizations. This approach ensures consistent styling across all chart types and can be universally applied to any <code>ggplot2</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">custom_theme <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(plt, </span>
<span id="cb6-2">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, </span>
<span id="cb6-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_line_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb6-4">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>){</span>
<span id="cb6-5">  </span>
<span id="cb6-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note the use of "+" and not "%&gt;%"</span></span>
<span id="cb6-7">  plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust overall font size</span></span>
<span id="cb6-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> base_size, </span>
<span id="cb6-10">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_line_size =</span> base_line_size) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-11">    </span>
<span id="cb6-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put legend at the bottom</span></span>
<span id="cb6-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-14">    </span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Different colour scale</span></span>
<span id="cb6-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> palette)</span>
<span id="cb6-17">}</span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test run</span></span>
<span id="cb6-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">line_chart</span>(plotdf, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MA"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">custom_theme</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2_files/figure-html/custom-theme-basic-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="advanced-function-enhancement" class="level2">
<h2 class="anchored" data-anchor-id="advanced-function-enhancement">Advanced Function Enhancement</h2>
<p>The following section demonstrates the expansion of the <code>line_chart()</code> function to incorporate additional features and parameters, thereby increasing its versatility and applicability across diverse visualization requirements:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">line_chart <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df, </span>
<span id="cb7-2">                       x, y, </span>
<span id="cb7-3">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group_color =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb7-4">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb7-5">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_type =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb7-6">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb7-7">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb7-8">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb7-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb7-10">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>){</span>
<span id="cb7-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Base plot</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(x), </span>
<span id="cb7-13">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(y), </span>
<span id="cb7-14">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sym</span>(group_color))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-15">    </span>
<span id="cb7-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Line chart </span></span>
<span id="cb7-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> line_width, </span>
<span id="cb7-18">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> line_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-19">    </span>
<span id="cb7-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Titles and subtitles</span></span>
<span id="cb7-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> xlab, </span>
<span id="cb7-22">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> ylab, </span>
<span id="cb7-23">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> title, </span>
<span id="cb7-24">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> subtitle, </span>
<span id="cb7-25">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> caption)</span>
<span id="cb7-26">}</span></code></pre></div>
</div>
<p>Correspondingly, we enhance the <code>custom_theme()</code> function to accommodate diverse axis formatting options and advanced styling parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">custom_theme <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(plt, </span>
<span id="cb8-2">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>, </span>
<span id="cb8-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format_x_axis_as =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb8-4">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format_y_axis_as =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb8-5">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_axis_scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb8-6">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_axis_scale =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb8-7">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_axis_text_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, </span>
<span id="cb8-8">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_axis_text_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, </span>
<span id="cb8-9">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, </span>
<span id="cb8-10">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_line_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb8-11">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>){</span>
<span id="cb8-12">  </span>
<span id="cb8-13">  mappings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(plt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mapping))</span>
<span id="cb8-14">  </span>
<span id="cb8-15">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-16">    </span>
<span id="cb8-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust overall font size</span></span>
<span id="cb8-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> base_size, </span>
<span id="cb8-19">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_line_size =</span> base_line_size) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-20">    </span>
<span id="cb8-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Put legend at the bottom</span></span>
<span id="cb8-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb8-23">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> x_angle)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-24">    </span>
<span id="cb8-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Different colour palette</span></span>
<span id="cb8-26">    {<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"colour"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> mappings) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> palette)}<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-27">    </span>
<span id="cb8-28">    {<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> mappings) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> palette)}<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-29">    </span>
<span id="cb8-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change some theme options</span></span>
<span id="cb8-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#f7f7f7"</span>), </span>
<span id="cb8-32">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"italic"</span>), </span>
<span id="cb8-33">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, </span>
<span id="cb8-34">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> x_axis_text_size), </span>
<span id="cb8-35">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>, </span>
<span id="cb8-36">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> y_axis_text_size)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-37">    </span>
<span id="cb8-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change x-axis formatting</span></span>
<span id="cb8-39">    {<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(format_x_axis_as))</span>
<span id="cb8-40">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">switch</span>(format_x_axis_as, </span>
<span id="cb8-41">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_date</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty_breaks</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)), </span>
<span id="cb8-42">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number_format</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb8-43">                                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimal.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, </span>
<span id="cb8-44">                                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> x_axis_scale)), </span>
<span id="cb8-45">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> percent))} <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-46">    </span>
<span id="cb8-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change y-axis formatting</span></span>
<span id="cb8-48">    {<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(format_y_axis_as))</span>
<span id="cb8-49">      </span>
<span id="cb8-50">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">switch</span>(format_y_axis_as, </span>
<span id="cb8-51">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_date</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pretty_breaks</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)), </span>
<span id="cb8-52">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number_format</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb8-53">                                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decimal.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, </span>
<span id="cb8-54">                                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> y_axis_scale)), </span>
<span id="cb8-55">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"percent"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> percent))}</span>
<span id="cb8-56">  </span>
<span id="cb8-57">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Capitalise all names</span></span>
<span id="cb8-58">  vec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>labels, str_to_title)</span>
<span id="cb8-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(vec) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>labels)</span>
<span id="cb8-60">  p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>labels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vec</span>
<span id="cb8-61">  </span>
<span id="cb8-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(p)</span>
<span id="cb8-63">}</span></code></pre></div>
</div>
</section>
<section id="integrated-function-implementation" class="level2">
<h2 class="anchored" data-anchor-id="integrated-function-implementation">Integrated Function Implementation</h2>
<p>The following demonstration illustrates the coordinated application of our enhanced functions to generate a polished, publication-ready visualization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">line_chart</span>(plotdf,</span>
<span id="cb9-2">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>, </span>
<span id="cb9-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MA"</span>, </span>
<span id="cb9-4">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group_color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>, </span>
<span id="cb9-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Date"</span>, </span>
<span id="cb9-6">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Moving Avg. (in '000)"</span>, </span>
<span id="cb9-7">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Daily COVID19 Case Load"</span>, </span>
<span id="cb9-8">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 5 countries by volume"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-9">  </span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">custom_theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format_x_axis_as =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>, </span>
<span id="cb9-11">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format_y_axis_as =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number"</span>, </span>
<span id="cb9-12">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_axis_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2_files/figure-html/final-line-chart-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cross-chart-type-theme-application" class="level2">
<h2 class="anchored" data-anchor-id="cross-chart-type-theme-application">Cross-Chart Type Theme Application</h2>
<p>The architectural design of our <code>custom_theme()</code> function enables its universal application to any <code>ggplot2</code> object, regardless of visualization type. The following example demonstrates this flexibility through bar chart implementation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plotdf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  </span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(date, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%m-%b"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> MA, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> country)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dodge"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monthly COVID19 Case load trend"</span>, </span>
<span id="cb10-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 5 countries"</span>, </span>
<span id="cb10-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Month"</span>, </span>
<span id="cb10-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Moving Average ('000)"</span>)</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">custom_theme</span>(p, </span>
<span id="cb10-11">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>, </span>
<span id="cb10-12">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">format_y_axis_as =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"number"</span>, </span>
<span id="cb10-13">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_axis_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2_files/figure-html/bar-chart-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="strategic-advantages-of-custom-charting-functions" class="level2">
<h2 class="anchored" data-anchor-id="strategic-advantages-of-custom-charting-functions">Strategic Advantages of Custom Charting Functions</h2>
<p>The development of custom charting functions utilizing ggplot2 provides substantial advantages for analytical workflows:</p>
<ol type="1">
<li><p><strong>Visual Consistency</strong>: Ensures uniform appearance and styling across all visualizations within reports or analytical dashboards.</p></li>
<li><p><strong>Development Efficiency</strong>: Significantly reduces code volume required for frequently utilized chart types and configurations.</p></li>
<li><p><strong>Maintenance Optimization</strong>: Facilitates centralized style updates through single function modifications, propagating changes across all implementations.</p></li>
<li><p><strong>Accessibility Enhancement</strong>: Abstracts ggplot2 complexity for team members with varying levels of package familiarity, democratizing visualization capabilities.</p></li>
</ol>
</section>
<section id="implementation-strategy-custom-functions-vs.-direct-ggplot2" class="level2">
<h2 class="anchored" data-anchor-id="implementation-strategy-custom-functions-vs.-direct-ggplot2">Implementation Strategy: Custom Functions vs.&nbsp;Direct ggplot2</h2>
<p>The development of customized charting functions utilizing <code>ggplot2</code> demonstrates optimal value when creating repetitive visualization types within structured analytical workflows. For exploratory data analysis activities, direct <code>ggplot2</code> implementation often provides superior flexibility, enabling rapid prototyping and layered chart construction within integrated analytical pipelines.</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Data Visualization</category>
  <category>ggplot2</category>
  <guid>https://rtichoke.netlify.app/posts/custom-charting-functions-ggplot2.html</guid>
  <pubDate>Mon, 13 May 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/custom_charts.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>Generating Correlated Random Numbers in R Using Matrix Methods</title>
  <link>https://rtichoke.netlify.app/posts/generating-correlated-random-numbers.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The generation of random data with specified correlation patterns can be useful in statistical simulation and this tutorial provides a methodology for creating correlated random numbers in R. The techniques presented enable the development of realistic synthetic datasets with precisely controlled correlation structures, essential for robust statistical analysis and model validation.</p>
</section>
<section id="the-cholesky-decomposition-method" class="level2">
<h2 class="anchored" data-anchor-id="the-cholesky-decomposition-method">The Cholesky Decomposition Method</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Define your target correlation matrix</span></span>
<span id="cb1-6">cor_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, </span>
<span id="cb1-7">                   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Apply Cholesky decomposition</span></span>
<span id="cb1-10">chol_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(cor_mat)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. Generate uncorrelated random numbers</span></span>
<span id="cb1-13">old_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. Transform to create correlation</span></span>
<span id="cb1-16">new_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> old_random <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> chol_mat</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the correlation</span></span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(new_random)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]
[1,] 1.0000000 0.2679134
[2,] 0.2679134 1.0000000</code></pre>
</div>
</div>
<p>The resulting <code>new_random</code> matrix contains values exhibiting approximately the target correlation structure.</p>
</section>
<section id="implementation-considerations" class="level2">
<h2 class="anchored" data-anchor-id="implementation-considerations">Implementation Considerations</h2>
<section id="independence" class="level3">
<h3 class="anchored" data-anchor-id="independence">Independence</h3>
<p>The input data must demonstrate statistical independence for the Cholesky method to function correctly. Pre-existing correlations in the input data compromise the method’s ability to achieve target correlation structures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># What happens with already correlated input?</span></span>
<span id="cb3-2">simulate_correlation <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(input_correlation, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>) {</span>
<span id="cb3-3">  results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, {</span>
<span id="cb3-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create input with specified correlation</span></span>
<span id="cb3-5">    x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb3-6">    y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> input_correlation <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> input_correlation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-7">    </span>
<span id="cb3-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply our method</span></span>
<span id="cb3-9">    old_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(x, y)</span>
<span id="cb3-10">    chol_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, target, target, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-11">    new_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> old_random <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> chol_mat</span>
<span id="cb3-12">    </span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return resulting correlation</span></span>
<span id="cb3-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(new_random)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-15">  })</span>
<span id="cb3-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(results)</span>
<span id="cb3-17">}</span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare results with different input correlations</span></span>
<span id="cb3-20">correlated_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_correlation</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-21">uncorrelated_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_correlation</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create data frame for ggplot2</span></span>
<span id="cb3-24">plot_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb3-25">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">correlation =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(correlated_results, uncorrelated_results),</span>
<span id="cb3-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">input_type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Correlated Input (0.8)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Uncorrelated Input (0.001)"</span>), </span>
<span id="cb3-27">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(correlated_results)))</span>
<span id="cb3-28">)</span>
<span id="cb3-29"></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create density plot with ggplot2</span></span>
<span id="cb3-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> correlation, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> input_type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> input_type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Effect of Input Correlation on Target Correlation Achievement"</span>,</span>
<span id="cb3-34">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Target correlation = 0.3"</span>,</span>
<span id="cb3-35">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Achieved Correlation"</span>,</span>
<span id="cb3-36">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>,</span>
<span id="cb3-37">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input Data Type"</span>,</span>
<span id="cb3-38">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input Data Type"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slateblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightblue"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/generating-correlated-random-numbers_files/figure-html/correlation-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When input data contains pre-existing correlation patterns, the Cholesky method cannot effectively override these relationships to establish the desired target correlation structure.</p>
</section>
<section id="distribution-consistency" class="level3">
<h3 class="anchored" data-anchor-id="distribution-consistency">Distribution Consistency</h3>
<p>Optimal results require consistent probability distributions across all variables in the transformation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Different distributions cause problems</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb4-3">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chi-squared (skewed)</span></span>
<span id="cb4-4">y1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normal (symmetric)</span></span>
<span id="cb4-5">old_mixed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(x1, y1)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Same distribution works better</span></span>
<span id="cb4-8">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb4-9">y2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb4-10">old_same <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(x2, y2)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the same transformation to both</span></span>
<span id="cb4-13">chol_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb4-14">new_mixed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> old_mixed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> chol_mat</span>
<span id="cb4-15">new_same <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> old_same <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> chol_mat</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare results</span></span>
<span id="cb4-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Target correlation: 0.7</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Target correlation: 0.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mixed distributions result:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(new_mixed)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mixed distributions result: 0.915 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Same distribution result:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(new_same)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Same distribution result: 0.699</code></pre>
</div>
</div>
<p>The combination of different probability distributions (such as normal and chi-squared) can result in unexpected correlation patterns following the Cholesky transformation.</p>
</section>
<section id="distribution-properties" class="level3">
<h3 class="anchored" data-anchor-id="distribution-properties">Distribution Properties</h3>
<p>The Cholesky transformation may fundamentally alter the statistical properties of the original data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Original positive-only distribution</span></span>
<span id="cb10-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Always positive</span></span>
<span id="cb10-3">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rchisq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Always positive</span></span>
<span id="cb10-4">old_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(x, y)</span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply negative correlation</span></span>
<span id="cb10-7">chol_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb10-8">new_random <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> old_random <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> chol_mat</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check what happened</span></span>
<span id="cb10-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original data range:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(old_random), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original data range: 0.02 19.93 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transformed data range:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(new_random), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transformed data range: -12.81 19.93 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Negative values in result:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(new_random <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out of"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_random))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Negative values in result: 488 out of 2000</code></pre>
</div>
</div>
<p>The Cholesky transformation can fundamentally modify data characteristics, such as introducing negative values into previously positive-only distributions, thereby altering the fundamental nature of the data.</p>
</section>
</section>
<section id="alternate-implementation-mvtnorm" class="level2">
<h2 class="anchored" data-anchor-id="alternate-implementation-mvtnorm">Alternate Implementation: <code>mvtnorm</code></h2>
<p>For practical applications requiring efficient implementation, the <code>mvtnorm</code> package provides a streamlined solution for generating multivariate normal distributions with specified correlation structures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the package</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mvtnorm)</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define means and covariance matrix</span></span>
<span id="cb16-5">means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean for each variable</span></span>
<span id="cb16-6">sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Covariance matrix</span></span>
<span id="cb16-7">                  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb16-8"></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># See the implied correlation</span></span>
<span id="cb16-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov2cor</span>(sigma)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]
[1,] 1.0000000 0.5773503
[2,] 0.5773503 1.0000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate correlated normal data in one step</span></span>
<span id="cb18-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmvnorm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> means, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> sigma)</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the result</span></span>
<span id="cb18-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]
[1,] 1.000 0.613
[2,] 0.613 1.000</code></pre>
</div>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<ul>
<li><strong>Cholesky decomposition provides a mathematical foundation</strong> for transforming uncorrelated data into correlated structures through matrix operations</li>
<li><strong>Input data independence is critical</strong> for successful correlation induction; pre-existing correlations compromise the transformation effectiveness</li>
<li><strong>Distribution consistency across variables ensures optimal results</strong> and prevents unexpected correlation artifacts</li>
<li><strong>The transformation process can alter fundamental data properties</strong>, requiring careful consideration of distributional characteristics</li>
<li><strong>The mvtnorm package offers production-ready solutions</strong> for multivariate normal data generation with specified correlation structures</li>
<li><strong>Method selection depends on specific requirements</strong>: Cholesky for educational and custom applications, mvtnorm for operational efficiency</li>
</ul>


</section>

 ]]></description>
  <category>R</category>
  <category>Statistics</category>
  <category>Simulation</category>
  <guid>https://rtichoke.netlify.app/posts/generating-correlated-random-numbers.html</guid>
  <pubDate>Mon, 18 Mar 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/correlated.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>Evaluating Binary Classification Models Using Gains Tables</title>
  <link>https://rtichoke.netlify.app/posts/measuring-model-performance-gains-table.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In credit risk modeling and binary classification applications, analysts employ gains tables (also known as KS tables) as a fundamental tool for measuring and quantifying model performance. This tutorial dives into the construction and interpretion of gains tables using R. ## Theoretical Foundation: Understanding Gains Tables</p>
<p>A gains table systematically discretizes the population (typically a validation or test dataset) into groups based on the model’s output predictions (probability scores, log odds, or risk scores). Each group conventionally represents 10% of the total population (deciles), though alternative binning strategies may be employed. The output presents summary statistics for each group and analyzes the cumulative distributions of events (defaults) and non-events to quantify the model’s discriminatory performance.</p>
</section>
<section id="package-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="package-dependencies">Package Dependencies</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magrittr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(knitr)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span></code></pre></div>
</div>
</section>
<section id="dataset-preparation" class="level2">
<h2 class="anchored" data-anchor-id="dataset-preparation">Dataset Preparation</h2>
<p>This tutorial utilizes a sample from the Lending Club dataset, which contains comprehensive loan information and associated outcomes suitable for credit risk modeling applications.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the sample data</span></span>
<span id="cb2-2">sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://bit.ly/42ypcnJ"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check dimensions</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sample)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000   153</code></pre>
</div>
</div>
</section>
<section id="target-definition" class="level2">
<h2 class="anchored" data-anchor-id="target-definition">Target Definition</h2>
<p>The initial step requires the creation of a binary target variable for modeling purposes. In this credit risk application, we identify borrowers who defaulted on their loan obligations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check unique loan statuses</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(sample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loan_status)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Fully Paid"                                         
[2] "Current"                                            
[3] "Charged Off"                                        
[4] "Late (31-120 days)"                                 
[5] "Late (16-30 days)"                                  
[6] "In Grace Period"                                    
[7] "Does not meet the credit policy. Status:Fully Paid" 
[8] "Does not meet the credit policy. Status:Charged Off"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define "bad" loans as those that are charged off</span></span>
<span id="cb6-2">codes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charged Off"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Does not meet the credit policy. Status:Charged Off"</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary flag for defaults</span></span>
<span id="cb6-5">sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bad_flag =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> codes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check overall event rates</span></span>
<span id="cb6-8">sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb6-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">non_events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_rate =</span> events<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> non_events))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  events non_events event_rate
1   1162       8838     0.1162</code></pre>
</div>
</div>
</section>
<section id="model-development" class="level2">
<h2 class="anchored" data-anchor-id="model-development">Model Development</h2>
<p>Subsequently, we develop a logistic regression model to generate predictions that will serve as the foundation for gains table construction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace NA values with a default value</span></span>
<span id="cb8-2">sample[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(sample)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean the data</span></span>
<span id="cb8-5">sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span> </span>
<span id="cb8-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove cases where home ownership and payment plan are not reported</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>home_ownership <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NONE"</span>),</span>
<span id="cb8-8">         pymnt_plan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert categorical variables to factors</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_ownership =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(home_ownership), </span>
<span id="cb8-11">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pymnt_plan =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(pymnt_plan))</span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train-test split (70-30)</span></span>
<span id="cb8-14">idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sample), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sample), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-15">train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sample[idx,]</span>
<span id="cb8-16">test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sample[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>idx,]</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a logistic regression model</span></span>
<span id="cb9-2">mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb9-4">    loan_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_last_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> total_pymnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-5">    home_ownership <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> acc_now_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-6">    inq_last_6mths <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delinq_amnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-7">    mths_since_last_record <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_recent_revol_delinq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-8">    mths_since_last_major_derog <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mths_since_recent_inq <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-9">    mths_since_recent_bc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> num_accts_ever_120_pd,</span>
<span id="cb9-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binomial"</span>, </span>
<span id="cb9-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train</span>
<span id="cb9-12">)</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictions on the test set</span></span>
<span id="cb9-15">test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mdl, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> test)</span></code></pre></div>
</div>
</section>
<section id="gains-table-construction" class="level2">
<h2 class="anchored" data-anchor-id="gains-table-construction">Gains Table Construction</h2>
<p>The following section demonstrates the step-by-step construction of a comprehensive gains table through systematic binning and statistical analysis.</p>
<section id="population-discretization-into-bins" class="level3">
<h3 class="anchored" data-anchor-id="population-discretization-into-bins">Population Discretization into Bins</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create deciles based on model predictions</span></span>
<span id="cb10-2">q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>))</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add bins to test dataset</span></span>
<span id="cb10-5">test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> q, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.lowest =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb10-6">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered_result =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the bin levels (note they're in increasing order)</span></span>
<span id="cb10-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bins)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "[-5.11,-3.34]" "(-3.34,-2.89]" "(-2.89,-2.64]" "(-2.64,-2.41]"
 [5] "(-2.41,-2.23]" "(-2.23,-2.03]" "(-2.03,-1.83]" "(-1.83,-1.6]" 
 [9] "(-1.6,-1.26]"  "(-1.26,2.51]" </code></pre>
</div>
</div>
</section>
<section id="basic-statistical-measures-by-segment" class="level3">
<h3 class="anchored" data-anchor-id="basic-statistical-measures-by-segment">Basic Statistical Measures by Segment</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create initial gains table with counts</span></span>
<span id="cb12-2">gains_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(bins) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), </span>
<span id="cb12-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb12-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">non_events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add event rate column</span></span>
<span id="cb12-9">gains_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span></span>
<span id="cb12-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the table</span></span>
<span id="cb12-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(gains_table)</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">bins</th>
<th style="text-align: right;">total</th>
<th style="text-align: right;">events</th>
<th style="text-align: right;">non_events</th>
<th style="text-align: left;">event_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">[-5.11,-3.34]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">297</td>
<td style="text-align: left;">1.0%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-3.34,-2.89]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">292</td>
<td style="text-align: left;">2.7%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.89,-2.64]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">290</td>
<td style="text-align: left;">3.3%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.64,-2.41]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">286</td>
<td style="text-align: left;">4.7%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.41,-2.23]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">274</td>
<td style="text-align: left;">8.7%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.23,-2.03]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">262</td>
<td style="text-align: left;">12.7%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.03,-1.83]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">254</td>
<td style="text-align: left;">15.3%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.83,-1.6]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">251</td>
<td style="text-align: left;">16.3%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-1.6,-1.26]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">242</td>
<td style="text-align: left;">19.3%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.26,2.51]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">226</td>
<td style="text-align: left;">24.7%</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="cumulative-distribution" class="level3">
<h3 class="anchored" data-anchor-id="cumulative-distribution">Cumulative Distribution</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add population percentage and cumulative distributions</span></span>
<span id="cb13-2">gains_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span></span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(total<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(total), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb13-4">         </span>
<span id="cb13-5">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate cumulative percentages</span></span>
<span id="cb13-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(events),</span>
<span id="cb13-7">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.non_events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(non_events) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(non_events))</span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the updated table</span></span>
<span id="cb13-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(gains_table)</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 14%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">bins</th>
<th style="text-align: right;">total</th>
<th style="text-align: right;">events</th>
<th style="text-align: right;">non_events</th>
<th style="text-align: left;">event_rate</th>
<th style="text-align: left;">pop_pct</th>
<th style="text-align: right;">c.events_pct</th>
<th style="text-align: right;">c.non_events_pct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">[-5.11,-3.34]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">297</td>
<td style="text-align: left;">1.0%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.0092025</td>
<td style="text-align: right;">0.1110696</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-3.34,-2.89]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">292</td>
<td style="text-align: left;">2.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.0337423</td>
<td style="text-align: right;">0.2202693</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.89,-2.64]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">290</td>
<td style="text-align: left;">3.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.0644172</td>
<td style="text-align: right;">0.3287210</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.64,-2.41]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">286</td>
<td style="text-align: left;">4.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.1073620</td>
<td style="text-align: right;">0.4356769</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.41,-2.23]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">274</td>
<td style="text-align: left;">8.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.1871166</td>
<td style="text-align: right;">0.5381451</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.23,-2.03]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">262</td>
<td style="text-align: left;">12.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.3036810</td>
<td style="text-align: right;">0.6361257</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.03,-1.83]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">254</td>
<td style="text-align: left;">15.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.4447853</td>
<td style="text-align: right;">0.7311144</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.83,-1.6]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">251</td>
<td style="text-align: left;">16.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.5950920</td>
<td style="text-align: right;">0.8249813</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-1.6,-1.26]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">242</td>
<td style="text-align: left;">19.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">0.7730061</td>
<td style="text-align: right;">0.9154824</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.26,2.51]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">226</td>
<td style="text-align: left;">24.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: right;">1.0000000</td>
<td style="text-align: right;">1.0000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="performance-metrics" class="level3">
<h3 class="anchored" data-anchor-id="performance-metrics">Performance Metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add KS statistic, capture rate, and cumulative event rate</span></span>
<span id="cb14-2">gains_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&lt;&gt;%</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb14-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># KS statistic (difference between cumulative distributions)</span></span>
<span id="cb14-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(c.events_pct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> c.non_events_pct), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb14-6">    </span>
<span id="cb14-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Capture rate (percentage of total events captured)</span></span>
<span id="cb14-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cap_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(events), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb14-9">    </span>
<span id="cb14-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cumulative event rate</span></span>
<span id="cb14-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c_event_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(total), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb14-12">    </span>
<span id="cb14-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format percentage columns</span></span>
<span id="cb14-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(c.events_pct, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb14-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.non_events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(c.non_events_pct, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb14-16"></span>
<span id="cb14-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the final table</span></span>
<span id="cb14-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(gains_table)</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">bins</th>
<th style="text-align: right;">total</th>
<th style="text-align: right;">events</th>
<th style="text-align: right;">non_events</th>
<th style="text-align: left;">event_rate</th>
<th style="text-align: left;">pop_pct</th>
<th style="text-align: left;">c.events_pct</th>
<th style="text-align: left;">c.non_events_pct</th>
<th style="text-align: right;">ks</th>
<th style="text-align: left;">cap_rate</th>
<th style="text-align: left;">c_event_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">[-5.11,-3.34]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">297</td>
<td style="text-align: left;">1.0%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">0.9%</td>
<td style="text-align: left;">11.1%</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: left;">1%</td>
<td style="text-align: left;">1.0%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-3.34,-2.89]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">292</td>
<td style="text-align: left;">2.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">3.4%</td>
<td style="text-align: left;">22.0%</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: left;">3%</td>
<td style="text-align: left;">1.8%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.89,-2.64]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">290</td>
<td style="text-align: left;">3.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">6.4%</td>
<td style="text-align: left;">32.9%</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: left;">6%</td>
<td style="text-align: left;">2.3%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.64,-2.41]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">286</td>
<td style="text-align: left;">4.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">10.7%</td>
<td style="text-align: left;">43.6%</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: left;">11%</td>
<td style="text-align: left;">2.9%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.41,-2.23]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">274</td>
<td style="text-align: left;">8.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">18.7%</td>
<td style="text-align: left;">53.8%</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: left;">19%</td>
<td style="text-align: left;">4.1%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.23,-2.03]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">262</td>
<td style="text-align: left;">12.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">30.4%</td>
<td style="text-align: left;">63.6%</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: left;">30%</td>
<td style="text-align: left;">5.5%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.03,-1.83]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">254</td>
<td style="text-align: left;">15.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">44.5%</td>
<td style="text-align: left;">73.1%</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: left;">44%</td>
<td style="text-align: left;">6.9%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.83,-1.6]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">251</td>
<td style="text-align: left;">16.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">59.5%</td>
<td style="text-align: left;">82.5%</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: left;">60%</td>
<td style="text-align: left;">8.1%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-1.6,-1.26]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">242</td>
<td style="text-align: left;">19.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">77.3%</td>
<td style="text-align: left;">91.5%</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: left;">77%</td>
<td style="text-align: left;">9.3%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.26,2.51]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">226</td>
<td style="text-align: left;">24.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">100.0%</td>
<td style="text-align: left;">100.0%</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">100%</td>
<td style="text-align: left;">10.9%</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="reusable-function" class="level2">
<h2 class="anchored" data-anchor-id="reusable-function">Reusable Function</h2>
<p>The following implementation encapsulates the gains table construction process within a comprehensive, reusable function suitable for any binary classification model evaluation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">gains_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(act, pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">increasing =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nBins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) {</span>
<span id="cb15-2">  </span>
<span id="cb15-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create bins based on predictions</span></span>
<span id="cb15-4">  q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> nBins <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb15-5">  bins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> q, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.lowest =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered_result =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb15-6">  </span>
<span id="cb15-7">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(act, pred, bins)</span>
<span id="cb15-8">  </span>
<span id="cb15-9">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Group by bins and calculate statistics</span></span>
<span id="cb15-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(bins) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), </span>
<span id="cb15-13">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(act <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb15-14">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">non_events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(act <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-16">    </span>
<span id="cb15-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sort the table based on the 'increasing' parameter</span></span>
<span id="cb15-18">    {<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(increasing <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb15-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(., bins)</span>
<span id="cb15-20">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb15-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(., <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(bins))</span>
<span id="cb15-22">    }} <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb15-23">    </span>
<span id="cb15-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add all performance metrics</span></span>
<span id="cb15-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(total<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(total), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb15-26">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(events),</span>
<span id="cb15-27">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.non_events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(non_events) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(non_events), </span>
<span id="cb15-28">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(c.events_pct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> c.non_events_pct), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb15-29">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cap_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(events), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb15-30">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c_event_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(events)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(total), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb15-31">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(c.events_pct, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb15-32">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c.non_events_pct =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent</span>(c.non_events_pct, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb15-33">}</span></code></pre></div>
</div>
<section id="function-implementation" class="level3">
<h3 class="anchored" data-anchor-id="function-implementation">Function Implementation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate a gains table with bins in descending order</span></span>
<span id="cb16-2">tab <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gains_table</span>(test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bad_flag, test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb16-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(tab)</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">bins</th>
<th style="text-align: right;">total</th>
<th style="text-align: right;">events</th>
<th style="text-align: right;">non_events</th>
<th style="text-align: left;">event_rate</th>
<th style="text-align: left;">pop_pct</th>
<th style="text-align: left;">c.events_pct</th>
<th style="text-align: left;">c.non_events_pct</th>
<th style="text-align: right;">ks</th>
<th style="text-align: left;">cap_rate</th>
<th style="text-align: left;">c_event_rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(-1.26,2.51]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">74</td>
<td style="text-align: right;">226</td>
<td style="text-align: left;">24.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">22.7%</td>
<td style="text-align: left;">8.5%</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: left;">23%</td>
<td style="text-align: left;">24.7%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-1.6,-1.26]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">242</td>
<td style="text-align: left;">19.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">40.5%</td>
<td style="text-align: left;">17.5%</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: left;">40%</td>
<td style="text-align: left;">22.0%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-1.83,-1.6]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">251</td>
<td style="text-align: left;">16.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">55.5%</td>
<td style="text-align: left;">26.9%</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: left;">56%</td>
<td style="text-align: left;">20.1%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.03,-1.83]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">254</td>
<td style="text-align: left;">15.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">69.6%</td>
<td style="text-align: left;">36.4%</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: left;">70%</td>
<td style="text-align: left;">18.9%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.23,-2.03]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">262</td>
<td style="text-align: left;">12.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">81.3%</td>
<td style="text-align: left;">46.2%</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: left;">81%</td>
<td style="text-align: left;">17.7%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.41,-2.23]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">274</td>
<td style="text-align: left;">8.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">89.3%</td>
<td style="text-align: left;">56.4%</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: left;">89%</td>
<td style="text-align: left;">16.2%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-2.64,-2.41]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">286</td>
<td style="text-align: left;">4.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">93.6%</td>
<td style="text-align: left;">67.1%</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: left;">94%</td>
<td style="text-align: left;">14.5%</td>
</tr>
<tr class="even">
<td style="text-align: left;">(-2.89,-2.64]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">290</td>
<td style="text-align: left;">3.3%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">96.6%</td>
<td style="text-align: left;">78.0%</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: left;">97%</td>
<td style="text-align: left;">13.1%</td>
</tr>
<tr class="odd">
<td style="text-align: left;">(-3.34,-2.89]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">292</td>
<td style="text-align: left;">2.7%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">99.1%</td>
<td style="text-align: left;">88.9%</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: left;">99%</td>
<td style="text-align: left;">12.0%</td>
</tr>
<tr class="even">
<td style="text-align: left;">[-5.11,-3.34]</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">297</td>
<td style="text-align: left;">1.0%</td>
<td style="text-align: left;">10.0%</td>
<td style="text-align: left;">100.0%</td>
<td style="text-align: left;">100.0%</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: left;">100%</td>
<td style="text-align: left;">10.9%</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="interpretation" class="level2">
<h2 class="anchored" data-anchor-id="interpretation">Interpretation</h2>
<p>A properly constructed gains table provides multiple critical insights into model performance characteristics:</p>
<ol type="1">
<li><p><strong>Monotonicity Assessment</strong>: Event rates should demonstrate consistent increases (or decreases) across bins, confirming the model’s effectiveness in rank-ordering risk levels.</p></li>
<li><p><strong>Population Distribution</strong>: Consistent bin sizes (ideally ~10% each) indicate appropriate score distribution. Inconsistent sizes suggest score clustering, which may complicate threshold determination.</p></li>
<li><p><strong>Kolmogorov-Smirnov (KS) Statistic</strong>: The maximum KS value represents the model’s discriminatory power. Higher values (approaching 1.0) indicate superior separation between positive and negative cases.</p></li>
<li><p><strong>Capture Rate</strong>: Demonstrates the percentage of total events captured at each threshold, essential for operational decision-making.</p></li>
<li><p><strong>Cumulative Event Rate</strong>: Indicates the event rate among all cases up to each bin, facilitating approval threshold establishment.</p></li>
</ol>
</section>
<section id="applications-in-credit-risk-analytics" class="level2">
<h2 class="anchored" data-anchor-id="applications-in-credit-risk-analytics">Applications in Credit Risk Analytics</h2>
<p>Gains tables serve multiple critical functions in credit risk management environments:</p>
<ol type="1">
<li><p><strong>Threshold Optimization</strong>: Identification of appropriate score thresholds for automated approval or rejection decisions.</p></li>
<li><p><strong>Tiered Strategy Development</strong>: Construction of multi-tier decision strategies (approve, manual review, decline) based on quantified risk levels.</p></li>
<li><p><strong>Model Performance Monitoring</strong>: Longitudinal tracking of model performance through comparison of actual versus expected distributions.</p></li>
<li><p><strong>Comparative Model Evaluation</strong>: Systematic comparison of alternative models through KS statistics and capture rate analysis.</p></li>
</ol>


</section>

 ]]></description>
  <category>R</category>
  <category>Credit Risk Analytics</category>
  <category>Model Evaluation</category>
  <guid>https://rtichoke.netlify.app/posts/measuring-model-performance-gains-table.html</guid>
  <pubDate>Sat, 27 Jan 2024 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/gains.png" medium="image" type="image/png" height="64" width="144"/>
</item>
<item>
  <title>Portfolio Optimization Using PSO</title>
  <link>https://rtichoke.netlify.app/posts/portfolio_optimisation_pso.html</link>
  <description><![CDATA[ 




<p>Portfolio optimization represents a critical task in investment management, where the goal involves allocating capital across different assets to maximize returns while controlling risk. This post explores how to use Particle Swarm Optimization (PSO) to perform mean-variance portfolio optimization with various constraints.</p>
<ol type="1">
<li><p>For additional information on mean-variance optimization and the CAPM model, refer to this <a href="http://www.columbia.edu/~mh2078/FoundationsFE/MeanVariance-CAPM.pdf">paper</a>.</p></li>
<li><p>For additional information on particle swarm optimisation, refer to <a href="../posts/building-particle-swarm-optimizer.html">this post</a> on</p></li>
</ol>
<section id="libraries" class="level2">
<h2 class="anchored" data-anchor-id="libraries">Libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pso)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For PSO implementation (provides psoptim function)</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For data visualization</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For data manipulation and transformation</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(quantmod)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For downloading financial data</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For reshaping data (pivot_wider, gather functions)</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plotly)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For creating interactive 3D visualizations</span></span></code></pre></div>
</div>
</section>
<section id="data-collection" class="level2">
<h2 class="anchored" data-anchor-id="data-collection">Data Collection</h2>
<p>The first step is to gather historical price data to calculate returns and risk metrics.</p>
<section id="getting-stock-tickers" class="level3">
<h3 class="anchored" data-anchor-id="getting-stock-tickers">Getting Stock Tickers</h3>
<p>This post uses stocks from the NIFTY50 index, which includes the 50 largest Indian companies by market capitalisation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read ticker list from NSE (National Stock Exchange of India) website</span></span>
<span id="cb2-2">ticker_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/royr2/datasets/refs/heads/main/ind_nifty50list.csv"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># View the first few rows </span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(ticker_list[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                Company.Name           Industry     Symbol
1                     Adani Enterprises Ltd.    Metals &amp; Mining   ADANIENT
2 Adani Ports and Special Economic Zone Ltd.           Services ADANIPORTS
3           Apollo Hospitals Enterprise Ltd.         Healthcare APOLLOHOSP
4                          Asian Paints Ltd.  Consumer Durables ASIANPAINT
5                             Axis Bank Ltd. Financial Services   AXISBANK</code></pre>
</div>
</div>
</section>
<section id="downloading-historical-price-data" class="level3">
<h3 class="anchored" data-anchor-id="downloading-historical-price-data">Downloading Historical Price Data</h3>
<p>The next step involves downloading historical price data for these stocks using the <code>quantmod</code> package, which provides an interface to Yahoo Finance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append ".NS" to tickers for Yahoo Finance format (NS = National Stock Exchange)</span></span>
<span id="cb4-2">tickers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(ticker_list<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Symbol, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".NS"</span>)</span>
<span id="cb4-3">tickers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tickers[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tickers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ETERNAL.NS"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"JIOFIN.NS"</span>)]</span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize empty dataframe to store all ticker data</span></span>
<span id="cb4-6">ticker_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a progress bar to monitor the download process</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pb &lt;- txtProgressBar(min = 1, max = length(tickers), style = 3)</span></span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop through each ticker and download its historical data</span></span>
<span id="cb4-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(nms <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tickers){</span>
<span id="cb4-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Yahoo Finance</span></span>
<span id="cb4-14">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getSymbols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Symbols =</span> nms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto.assign =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb4-15">  </span>
<span id="cb4-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rename columns for clarity</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(df) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"open"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"low"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"close"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"volume"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"adjusted"</span>)</span>
<span id="cb4-18">  df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(df)</span>
<span id="cb4-19">  </span>
<span id="cb4-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to dataframe and add ticker and date information</span></span>
<span id="cb4-21">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(df)</span>
<span id="cb4-22">  df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticker <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nms</span>
<span id="cb4-23">  df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>date <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(df)</span>
<span id="cb4-24">  </span>
<span id="cb4-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append to the main dataframe</span></span>
<span id="cb4-26">  ticker_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(ticker_df, df)</span>
<span id="cb4-27">  </span>
<span id="cb4-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb4-29">  </span>
<span id="cb4-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update progress bar</span></span>
<span id="cb4-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># setTxtProgressBar(pb, which(tickers == nms))</span></span>
<span id="cb4-32">}</span>
<span id="cb4-33"></span>
<span id="cb4-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape data to wide format with dates as rows and tickers as columns</span></span>
<span id="cb4-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This format facilitates the calculation of returns across all stocks</span></span>
<span id="cb4-36">prices_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> ticker_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id_cols =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticker"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"close"</span>)</span>
<span id="cb4-37"></span>
<span id="cb4-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove rows with missing values to ensure complete data</span></span>
<span id="cb4-39">prices_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(prices_df)</span>
<span id="cb4-40"></span>
<span id="cb4-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the date range of our data</span></span>
<span id="cb4-42"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(prices_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>date)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2017-11-17" "2025-06-20"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check dimensions (number of trading days × number of stocks + date column)</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(prices_df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1874   49</code></pre>
</div>
</div>
</section>
<section id="visualizing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-data">Visualizing the Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot closing prices for metal stocks</span></span>
<span id="cb8-2">prices_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert from wide to long format for easier plotting with ggplot2</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticker"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-5">  </span>
<span id="cb8-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attach industry information from our original ticker list</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(ticker_list <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-8">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticker =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(Symbol, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".NS"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-9">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(ticker, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">industry =</span> Industry),</span>
<span id="cb8-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticker"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-11">  </span>
<span id="cb8-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert date strings to Date objects</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(date)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-14">  </span>
<span id="cb8-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter to show only metal industry stocks for clarity</span></span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(stringr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tolower</span>(industry), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metal"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-17">  </span>
<span id="cb8-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the line plot</span></span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> ticker)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RdBu"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a color-blind friendly palette</span></span>
<span id="cb8-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Closing Prices"</span>, </span>
<span id="cb8-24">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nifty 50 metal stocks"</span>,</span>
<span id="cb8-25">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Date"</span>, </span>
<span id="cb8-26">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Closing Price"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, </span>
<span id="cb8-28">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transparent"</span>), </span>
<span id="cb8-29">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>), </span>
<span id="cb8-30">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bold"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/portfolio_optimisation_pso_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The visualization demonstrates the price movements of metal stocks over time. The data reveals periods of both correlation and divergence between different stocks, highlighting the importance of diversification in portfolio construction.</p>
</section>
<section id="calculating-returns" class="level3">
<h3 class="anchored" data-anchor-id="calculating-returns">Calculating Returns</h3>
<p>For portfolio optimization, we need to work with returns rather than prices. Returns better represent the investment performance and have more desirable statistical properties (like stationarity):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate daily returns for all stocks</span></span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Formula: (Price_today / Price_yesterday) - 1</span></span>
<span id="cb9-3">returns_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(prices_df[,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(vec){</span>
<span id="cb9-4">  ret <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(vec) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple returns calculation</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(ret)</span>
<span id="cb9-6">})</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to dataframe for easier manipulation</span></span>
<span id="cb9-9">returns_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(returns_df)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove first row which contains NA values (no previous day to calculate return)</span></span>
<span id="cb9-12">returns_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> returns_df[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]  </span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-compute average returns and covariance matrix for optimization</span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># These constitute key inputs to the mean-variance optimization</span></span>
<span id="cb9-16">mean_returns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(returns_df, mean)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expected returns</span></span>
<span id="cb9-17">cov_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov</span>(returns_df)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Risk (covariance) matrix</span></span></code></pre></div>
</div>
<p>The mean returns represent expectations for each asset’s performance, while the covariance matrix captures both the individual volatilities and the relationships between assets. These serve as inputs to the optimization process.</p>
</section>
</section>
<section id="portfolio-optimization-framework" class="level2">
<h2 class="anchored" data-anchor-id="portfolio-optimization-framework">Portfolio Optimization Framework</h2>
<section id="objective-function" class="level3">
<h3 class="anchored" data-anchor-id="objective-function">Objective Function</h3>
<p>In mean-variance optimisation the objective function, which defines the optimization target balances three key components:</p>
<ol type="1">
<li><strong>Expected returns (reward)</strong>: The weighted average of expected returns for each asset</li>
<li><strong>Portfolio variance (risk)</strong>: A measure of the portfolio’s volatility, calculated using the covariance matrix</li>
<li><strong>Risk aversion parameter</strong>: Controls the trade-off between risk and return (higher values prioritize risk reduction)</li>
</ol>
<p>The implementation also incorporates constraints through penalty terms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">obj_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(wts, </span>
<span id="cb10-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Risk aversion parameter</span></span>
<span id="cb10-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Penalty weight for full investment constraint</span></span>
<span id="cb10-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reserved for additional constraints</span></span>
<span id="cb10-5">                     ret_vec, cov_mat){</span>
<span id="cb10-6">  </span>
<span id="cb10-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate expected portfolio return (weighted average of asset returns)</span></span>
<span id="cb10-8">  port_returns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ret_vec <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> wts</span>
<span id="cb10-9">  </span>
<span id="cb10-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate portfolio risk (quadratic form using covariance matrix)</span></span>
<span id="cb10-11">  port_risk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(wts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> cov_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> wts</span>
<span id="cb10-12">  </span>
<span id="cb10-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean-variance utility function: return - risk_aversion * risk</span></span>
<span id="cb10-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is the core Markowitz portfolio optimization formula</span></span>
<span id="cb10-15">  obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> port_returns <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> risk_av <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> port_risk</span>
<span id="cb10-16">  </span>
<span id="cb10-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add penalty for violating the full investment constraint (sum of weights = 1)</span></span>
<span id="cb10-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The squared term ensures the penalty increases quadratically with violation size</span></span>
<span id="cb10-19">  obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lambda1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(wts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return negative value since PSO minimizes by default, but the goal is to maximize</span></span>
<span id="cb10-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the objective (higher returns, lower risk)</span></span>
<span id="cb10-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>obj)</span>
<span id="cb10-23">}</span></code></pre></div>
</div>
<p>This objective function implements the classic mean-variance utility with a quadratic penalty for the full investment constraint. The risk aversion parameter allows us to move along the efficient frontier to find portfolios with different risk-return profiles.</p>
</section>
</section>
<section id="two-asset-example" class="level2">
<h2 class="anchored" data-anchor-id="two-asset-example">Two-Asset Example</h2>
<p>Before tackling the full portfolio optimization problem, this section begins with a simple two-asset example. This approach helps visualize how PSO works and validates the methodology:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use only the first two assets for this example</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate their average returns and covariance matrix</span></span>
<span id="cb11-3">mean_returns_small <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(returns_df[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean)</span>
<span id="cb11-4">cov_mat_small <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov</span>(returns_df[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a custom PSO optimizer function to track the optimization process</span></span>
<span id="cb11-7">pso_optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(obj_func,</span>
<span id="cb11-8">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cognitive parameter (personal best influence)</span></span>
<span id="cb11-9">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Social parameter (global best influence)</span></span>
<span id="cb11-10">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inertia weight (controls momentum)</span></span>
<span id="cb11-11">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init_fact =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial velocity factor</span></span>
<span id="cb11-12">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_particles =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of particles in the swarm</span></span>
<span id="cb11-13">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_dim =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dimensionality (number of assets)</span></span>
<span id="cb11-14">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum iterations</span></span>
<span id="cb11-15">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Upper bound for weights</span></span>
<span id="cb11-16">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lower bound for weights (no short selling)</span></span>
<span id="cb11-17">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_avg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of iterations for averaging</span></span>
<span id="cb11-18">                      ...){</span>
<span id="cb11-19">  </span>
<span id="cb11-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize particle positions randomly within bounds</span></span>
<span id="cb11-21">  X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n_particles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_dim), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> n_particles)</span>
<span id="cb11-22">  X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (upper <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lower) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> lower  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scale to fit within bounds</span></span>
<span id="cb11-23">  </span>
<span id="cb11-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize particle velocities (movement speeds)</span></span>
<span id="cb11-25">  dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(n_particles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_dim) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> init_fact, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> n_dim)</span>
<span id="cb11-26">  dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (upper <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lower) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> lower</span>
<span id="cb11-27">  </span>
<span id="cb11-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize personal best positions and objective values</span></span>
<span id="cb11-29">  pbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each particle's best position so far</span></span>
<span id="cb11-30">  pbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(X, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, obj_func, ...)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Objective value at personal best</span></span>
<span id="cb11-31">  </span>
<span id="cb11-32">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize global best position and objective value</span></span>
<span id="cb11-33">  gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj),]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Best position across all particles</span></span>
<span id="cb11-34">  gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Best objective value found</span></span>
<span id="cb11-35">  </span>
<span id="cb11-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store initial positions for visualization</span></span>
<span id="cb11-37">  loc_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> pbest_obj)</span>
<span id="cb11-38">  iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-39">  </span>
<span id="cb11-40">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Main PSO loop</span></span>
<span id="cb11-41">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span>(iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n_iter){</span>
<span id="cb11-42">    </span>
<span id="cb11-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update velocities using PSO formula:</span></span>
<span id="cb11-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># New velocity = inertia + cognitive component + social component</span></span>
<span id="cb11-45">    dX <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inertia (continue in same direction)</span></span>
<span id="cb11-46">          c1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(pbest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull toward personal best</span></span>
<span id="cb11-47">          c2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(gbest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(X))      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pull toward global best</span></span>
<span id="cb11-48">    </span>
<span id="cb11-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update positions based on velocities</span></span>
<span id="cb11-50">    X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dX</span>
<span id="cb11-51">    </span>
<span id="cb11-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate objective function at new positions</span></span>
<span id="cb11-53">    obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(X, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, obj_func, ...)</span>
<span id="cb11-54">    </span>
<span id="cb11-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update personal bests if new positions are better</span></span>
<span id="cb11-56">    idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> pbest_obj)</span>
<span id="cb11-57">    pbest[idx,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[idx,]</span>
<span id="cb11-58">    pbest_obj[idx] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj[idx]</span>
<span id="cb11-59">    </span>
<span id="cb11-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update global best if a better solution is found</span></span>
<span id="cb11-61">    idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(pbest_obj)</span>
<span id="cb11-62">    gbest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pbest[idx,]</span>
<span id="cb11-63">    gbest_obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(pbest_obj)</span>
<span id="cb11-64">    </span>
<span id="cb11-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store current state for visualization</span></span>
<span id="cb11-66">    iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-67">    loc_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(loc_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> pbest_obj))</span>
<span id="cb11-68">  }</span>
<span id="cb11-69">  </span>
<span id="cb11-70">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return optimization results</span></span>
<span id="cb11-71">  lst <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> loc_df,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All particle positions throughout optimization</span></span>
<span id="cb11-72">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj =</span> gbest_obj,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Best objective value found</span></span>
<span id="cb11-73">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obj_loc =</span> gbest)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weights that achieved the best objective</span></span>
<span id="cb11-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(lst)</span>
<span id="cb11-75">}</span>
<span id="cb11-76"></span>
<span id="cb11-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the optimization for our two-asset portfolio</span></span>
<span id="cb11-78">out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pso_optim</span>(obj_func,</span>
<span id="cb11-79">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ret_vec =</span> mean_returns_small,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expected returns</span></span>
<span id="cb11-80">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cov_mat =</span> cov_mat_small,       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Covariance matrix</span></span>
<span id="cb11-81">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constraint and risk parameters</span></span>
<span id="cb11-82">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_particles =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use 100 particles for better coverage</span></span>
<span id="cb11-83">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_dim =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Two-asset portfolio</span></span>
<span id="cb11-84">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run for 200 iterations</span></span>
<span id="cb11-85">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bounds for weights</span></span>
<span id="cb11-86">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c1 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c2 =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lower influence parameters for stability</span></span>
<span id="cb11-87">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init_fact =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Low inertia for better convergence</span></span>
<span id="cb11-88"></span>
<span id="cb11-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify that the weights sum to approximately 1 (full investment constraint)</span></span>
<span id="cb11-90"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obj_loc)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9990315</code></pre>
</div>
</div>
<p>In this implementation, the tracking of all particle movements throughout the optimization process occurs. This enables visualization of how the swarm converges toward the optimal solution.</p>
<section id="visualizing-the-optimization-process" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-optimization-process">Visualizing the Optimization Process</h3>
<p>One advantage of starting with a two-asset example is the ability to visualize the entire search space and observe how the PSO algorithm explores it. The following creates a 3D visualization of the objective function landscape and the path each particle took during optimization:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a fine grid of points covering the feasible region (all possible weight combinations)</span></span>
<span id="cb13-2">grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First asset weight from 0 to 1</span></span>
<span id="cb13-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>))   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Second asset weight from 0 to 1</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate the objective function at each grid point to create the landscape</span></span>
<span id="cb13-6">grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(grid, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, obj_func, </span>
<span id="cb13-7">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ret_vec =</span> mean_returns_small, </span>
<span id="cb13-8">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cov_mat =</span> cov_mat_small, </span>
<span id="cb13-9">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb13-10"></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an interactive 3D plot showing both the objective function surface</span></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and the particle trajectories throughout the optimization</span></span>
<span id="cb13-13">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_ly</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the objective function surface as a mesh</span></span>
<span id="cb13-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_mesh</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> grid, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>obj, </span>
<span id="cb13-16">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-17">  </span>
<span id="cb13-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add particles as markers, colored by iteration to show progression</span></span>
<span id="cb13-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_markers</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>X1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>X2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>obj, </span>
<span id="cb13-20">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> iter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, </span>
<span id="cb13-21">              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">marker =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</div>
<p>This visualization demonstrates:</p>
<ol type="1">
<li>The objective function landscape as a 3D surface</li>
<li>The particles (small dots) exploring the search space</li>
<li>How the swarm converges toward the optimal solution over iterations (color gradient)</li>
</ol>
<p>The concentration of particles in certain regions indicates where the algorithm found promising solutions. The global best solution represents where the particles ultimately converge.</p>
</section>
</section>
<section id="multi-asset-portfolio-optimization" class="level2">
<h2 class="anchored" data-anchor-id="multi-asset-portfolio-optimization">Multi-Asset Portfolio Optimization</h2>
<p>To scale the problem to multiple assets, instead of using the custom PSO implementation, this section leverages the <code>psoptim</code> function from the <code>pso</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the number of stocks in the dataset</span></span>
<span id="cb14-2">n_stocks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(returns_df)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the PSO optimization for the full portfolio</span></span>
<span id="cb14-5">opt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">psoptim</span>(</span>
<span id="cb14-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial particle positions (starting with equal weights)</span></span>
<span id="cb14-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n_stocks),</span>
<span id="cb14-8">  </span>
<span id="cb14-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Objective function to minimize</span></span>
<span id="cb14-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> obj_func,</span>
<span id="cb14-11">  </span>
<span id="cb14-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pass the expected returns and covariance matrix</span></span>
<span id="cb14-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ret_vec =</span> mean_returns, </span>
<span id="cb14-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cov_mat =</span> cov_mat,</span>
<span id="cb14-15">  </span>
<span id="cb14-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set constraint parameters</span></span>
<span id="cb14-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weight for full investment constraint</span></span>
<span id="cb14-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Higher risk aversion for a more conservative portfolio</span></span>
<span id="cb14-19">  </span>
<span id="cb14-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set bounds for weights (no short selling allowed)</span></span>
<span id="cb14-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n_stocks),</span>
<span id="cb14-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_stocks),</span>
<span id="cb14-23">  </span>
<span id="cb14-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure the PSO algorithm</span></span>
<span id="cb14-25">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb14-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum iterations</span></span>
<span id="cb14-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Swarm size (number of particles)</span></span>
<span id="cb14-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit.stagnate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stop if no improvement after this many iterations</span></span>
<span id="cb14-29">  )</span>
<span id="cb14-30">)</span>
<span id="cb14-31"></span>
<span id="cb14-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and display the expected return of the optimized portfolio</span></span>
<span id="cb14-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Portfolio returns:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> mean_returns, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Portfolio returns: 0.00062"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and display the standard deviation (risk) of the optimized portfolio</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Portfolio Std dev:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> cov_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Portfolio Std dev: 0.00882"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify that the weights sum to approximately 1 (full investment constraint)</span></span>
<span id="cb18-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9946492</code></pre>
</div>
</div>
</section>
<section id="adding-tracking-error-constraint" class="level2">
<h2 class="anchored" data-anchor-id="adding-tracking-error-constraint">Adding Tracking Error Constraint</h2>
<p>Tracking error measures how closely a portfolio follows a benchmark.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define benchmark portfolio (equally weighted across all stocks)</span></span>
<span id="cb20-2">bench_wts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n_stocks, n_stocks)</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the time series of benchmark returns</span></span>
<span id="cb20-5">bench_returns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(returns_df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(bench_wts))</span>
<span id="cb20-6"></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a new objective function that includes tracking error</span></span>
<span id="cb20-8">obj_func_TE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(wts,  </span>
<span id="cb20-9">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Risk aversion parameter</span></span>
<span id="cb20-10">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Full investment constraint weight</span></span>
<span id="cb20-11">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda2 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tracking error constraint weight</span></span>
<span id="cb20-12">                        ret_vec, cov_mat){</span>
<span id="cb20-13">  </span>
<span id="cb20-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate portfolio metrics</span></span>
<span id="cb20-15">  port_returns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ret_vec <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> wts                      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expected portfolio return</span></span>
<span id="cb20-16">  port_risk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(wts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> cov_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> wts             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Portfolio variance</span></span>
<span id="cb20-17">  port_returns_ts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(returns_df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(wts))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time series of portfolio returns</span></span>
<span id="cb20-18">  </span>
<span id="cb20-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Original mean-variance objective</span></span>
<span id="cb20-20">  obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> port_returns <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> risk_av <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> port_risk</span>
<span id="cb20-21">  </span>
<span id="cb20-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Full investment constraint (weights sum to 1)</span></span>
<span id="cb20-23">  obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lambda1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(wts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb20-24">  </span>
<span id="cb20-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tracking error constraint (penalize deviation from benchmark)</span></span>
<span id="cb20-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tracking error is measured as the standard deviation of the difference</span></span>
<span id="cb20-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># between portfolio returns and benchmark returns</span></span>
<span id="cb20-28">  obj <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> obj <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lambda2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(port_returns_ts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bench_returns)</span>
<span id="cb20-29">  </span>
<span id="cb20-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>obj)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return negative for minimization</span></span>
<span id="cb20-31">}</span>
<span id="cb20-32"></span>
<span id="cb20-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run optimization with the tracking error constraint</span></span>
<span id="cb20-34">opt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">psoptim</span>(</span>
<span id="cb20-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial particle positions</span></span>
<span id="cb20-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n_stocks),</span>
<span id="cb20-37">  </span>
<span id="cb20-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use our new objective function with tracking error</span></span>
<span id="cb20-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> obj_func_TE,</span>
<span id="cb20-40">  </span>
<span id="cb20-41">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pass the expected returns and covariance matrix</span></span>
<span id="cb20-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ret_vec =</span> mean_returns, </span>
<span id="cb20-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cov_mat =</span> cov_mat,</span>
<span id="cb20-44">  </span>
<span id="cb20-45">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set constraint parameters</span></span>
<span id="cb20-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda1 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weight for full investment constraint</span></span>
<span id="cb20-47">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">risk_av =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Risk aversion parameter</span></span>
<span id="cb20-48">  </span>
<span id="cb20-49">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set bounds for weights</span></span>
<span id="cb20-50">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n_stocks),</span>
<span id="cb20-51">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_stocks),</span>
<span id="cb20-52">  </span>
<span id="cb20-53">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure the PSO algorithm</span></span>
<span id="cb20-54">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb20-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum iterations</span></span>
<span id="cb20-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Swarm size</span></span>
<span id="cb20-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit.stagnate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stop if no improvement after this many iterations</span></span>
<span id="cb20-58">  )</span>
<span id="cb20-59">)</span>
<span id="cb20-60"></span>
<span id="cb20-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and display the expected return of the optimized portfolio</span></span>
<span id="cb20-62"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Portfolio returns:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> mean_returns, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Portfolio returns: 0.00075"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and display the standard deviation (risk) of the optimized portfolio</span></span>
<span id="cb22-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Portfolio Std dev:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> cov_mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Portfolio Std dev: 0.01113"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify that the weights sum to approximately 1</span></span>
<span id="cb24-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9935669</code></pre>
</div>
</div>
<p>Adding the tracking error constraint, not only balances risk and return but also tracks the performance of an equally-weighted benchmark. The <code>lambda2</code> parameter controls the closeness of benchmark tracking - higher values result in portfolios that more closely resemble the benchmark.</p>
</section>
<section id="advantages-and-limitations-of-pso" class="level2">
<h2 class="anchored" data-anchor-id="advantages-and-limitations-of-pso">Advantages and Limitations of PSO</h2>
<section id="advantages" class="level3">
<h3 class="anchored" data-anchor-id="advantages">Advantages:</h3>
<ol type="1">
<li><p><strong>Flexibility</strong>: PSO can handle non-convex, non-differentiable objective functions, making it suitable for complex portfolio constraints that traditional optimizers struggle with</p></li>
<li><p><strong>Simplicity</strong>: The algorithm is intuitive and relatively easy to implement compared to other global optimization techniques</p></li>
<li><p><strong>Constraints</strong>: Various constraints can be easily incorporated through penalty functions without reformulating the entire problem</p></li>
<li><p><strong>Global Search</strong>: PSO explores the search space more thoroughly and is less likely to get stuck in local optima compared to gradient-based methods</p></li>
<li><p><strong>Parallelization</strong>: The algorithm is naturally parallelizable, as particles can be evaluated independently</p></li>
</ol>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations:</h3>
<ol type="1">
<li><p><strong>Variability</strong>: Results can vary between runs due to the stochastic nature of the algorithm, potentially leading to inconsistent portfolio recommendations</p></li>
<li><p><strong>Parameter Tuning</strong>: Performance significantly depends on parameters like inertia weight and acceleration coefficients, which may require careful tuning</p></li>
<li><p><strong>Convergence</strong>: There’s no mathematical guarantee of convergence to the global optimum, unlike some convex optimization methods</p></li>
<li><p><strong>Computational Cost</strong>: Can be computationally intensive for high-dimensional problems with many assets</p></li>
<li><p><strong>Constraint Handling</strong>: While flexible, the penalty function approach may not always satisfy constraints exactly</p></li>
</ol>
</section>
</section>
<section id="practical-applications" class="level2">
<h2 class="anchored" data-anchor-id="practical-applications">Practical Applications</h2>
<p>PSO-based portfolio optimization proves particularly valuable in scenarios where:</p>
<ul>
<li>Traditional quadratic programming approaches fail due to complex constraints</li>
<li>The objective function includes non-linear terms like higher moments (skewness, kurtosis)</li>
<li>Multiple competing objectives need to be balanced</li>
<li>The portfolio needs to satisfy regulatory or client-specific constraints</li>
</ul>
<p>The approach demonstrated in this post can be extended to include additional constraints such as:</p>
<ul>
<li>Sector or industry exposure limits</li>
<li>Maximum position sizes</li>
<li>Turnover or transaction cost constraints</li>
<li>Risk factor exposures and limits</li>
<li>Cardinality constraints (limiting the number of assets)</li>
</ul>


</section>

 ]]></description>
  <category>R</category>
  <category>Finance</category>
  <category>Optimization</category>
  <guid>https://rtichoke.netlify.app/posts/portfolio_optimisation_pso.html</guid>
  <pubDate>Tue, 16 May 2023 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/portfolio_optimisation.png" medium="image" type="image/png" height="127" width="144"/>
</item>
<item>
  <title>Introduction to R for Analytics</title>
  <link>https://rtichoke.netlify.app/posts/intro-to-r-analytics.html</link>
  <description><![CDATA[ 




<p>R is a powerful language specifically designed for data analysis and visualization. This guide demonstrates practical examples of using R for real-world analytics tasks.</p>
<section id="exploring-a-dataset" class="level2">
<h2 class="anchored" data-anchor-id="exploring-a-dataset">Exploring a Dataset</h2>
<p>R comes with several built-in datasets perfect for practice. This example examines the <code>mtcars</code> dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># View the first few rows</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(mtcars)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick summary of the dataset structure</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(mtcars)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   32 obs. of  11 variables:
 $ mpg : num  21 21 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 ...
 $ cyl : num  6 6 4 6 8 6 8 4 4 6 ...
 $ disp: num  160 160 108 258 360 ...
 $ hp  : num  110 110 93 110 175 105 245 62 95 123 ...
 $ drat: num  3.9 3.9 3.85 3.08 3.15 2.76 3.21 3.69 3.92 3.92 ...
 $ wt  : num  2.62 2.88 2.32 3.21 3.44 ...
 $ qsec: num  16.5 17 18.6 19.4 17 ...
 $ vs  : num  0 0 1 1 0 1 0 1 1 1 ...
 $ am  : num  1 1 1 0 0 0 0 0 0 0 ...
 $ gear: num  4 4 4 3 3 3 3 4 4 4 ...
 $ carb: num  4 4 1 1 2 1 4 2 2 4 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Statistical summary of key variables</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(mtcars[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>)])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      mpg              wt              hp       
 Min.   :10.40   Min.   :1.513   Min.   : 52.0  
 1st Qu.:15.43   1st Qu.:2.581   1st Qu.: 96.5  
 Median :19.20   Median :3.325   Median :123.0  
 Mean   :20.09   Mean   :3.217   Mean   :146.7  
 3rd Qu.:22.80   3rd Qu.:3.610   3rd Qu.:180.0  
 Max.   :33.90   Max.   :5.424   Max.   :335.0  </code></pre>
</div>
</div>
<p>The <code>mtcars</code> dataset contains information about 32 cars from Motor Trend magazine, including fuel efficiency (mpg), weight (wt), and horsepower (hp).</p>
</section>
<section id="data-visualization" class="level2">
<h2 class="anchored" data-anchor-id="data-visualization">Data Visualization</h2>
<p>Visualization is essential for understanding patterns in data. The following examples create informative plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. A scatter plot with regression line</span></span>
<span id="cb7-4">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> wt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mpg)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> hp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(cyl)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#2c3e50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Car Weight vs. Fuel Efficiency"</span>,</span>
<span id="cb7-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size represents horsepower, color represents cylinders"</span>,</span>
<span id="cb7-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Weight (1000 lbs)"</span>,</span>
<span id="cb7-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles Per Gallon"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cylinders"</span>)</span>
<span id="cb7-13"></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Distribution of fuel efficiency</span></span>
<span id="cb7-15">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mpg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(cyl))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distribution of Fuel Efficiency"</span>,</span>
<span id="cb7-18">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles Per Gallon"</span>,</span>
<span id="cb7-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Count"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cylinders"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb7-22"></span>
<span id="cb7-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display plots (if using patchwork)</span></span>
<span id="cb7-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb7-25">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p2</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/basic-visualizations-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>These visualizations reveal:</p>
<ul>
<li>A clear negative correlation between car weight and fuel efficiency</li>
<li>Higher cylinder cars tend to be heavier with lower MPG</li>
<li>The MPG distribution varies significantly by cylinder count</li>
</ul>
</section>
<section id="data-transformation" class="level2">
<h2 class="anchored" data-anchor-id="data-transformation">Data Transformation</h2>
<p>Data rarely comes in the exact format needed. The <code>dplyr</code> package makes transformations straightforward:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For rownames_to_column function</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an enhanced version of the dataset</span></span>
<span id="cb8-6">mtcars_enhanced <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mtcars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add car names as a column (they're currently row names)</span></span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames_to_column</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"car_name"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create useful derived metrics</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Efficiency ratio (higher is better)</span></span>
<span id="cb8-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">efficiency_ratio =</span> mpg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> wt,</span>
<span id="cb8-13">    </span>
<span id="cb8-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Power-to-weight ratio (higher is better)</span></span>
<span id="cb8-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">power_to_weight =</span> hp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> wt,</span>
<span id="cb8-16">    </span>
<span id="cb8-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Categorize cars by efficiency</span></span>
<span id="cb8-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">efficiency_category =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb8-19">      mpg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"High Efficiency"</span>,</span>
<span id="cb8-20">      mpg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Medium Efficiency"</span>,</span>
<span id="cb8-21">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low Efficiency"</span></span>
<span id="cb8-22">    )</span>
<span id="cb8-23">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arrange from most to least efficient</span></span>
<span id="cb8-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(efficiency_ratio))</span>
<span id="cb8-26"></span>
<span id="cb8-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the top 5 most efficient cars</span></span>
<span id="cb8-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(mtcars_enhanced[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"car_name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"efficiency_ratio"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"efficiency_category"</span>)], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        car_name  mpg    wt  hp efficiency_ratio efficiency_category
1   Lotus Europa 30.4 1.513 113         20.09253     High Efficiency
2    Honda Civic 30.4 1.615  52         18.82353     High Efficiency
3 Toyota Corolla 33.9 1.835  65         18.47411     High Efficiency
4       Fiat 128 32.4 2.200  66         14.72727     High Efficiency
5      Fiat X1-9 27.3 1.935  66         14.10853     High Efficiency</code></pre>
</div>
</div>
</section>
<section id="answering-business-questions-with-data" class="level2">
<h2 class="anchored" data-anchor-id="answering-business-questions-with-data">Answering Business Questions with Data</h2>
<p>The enhanced dataset can be used to answer practical questions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Question 1: What are the average characteristics by cylinder count?</span></span>
<span id="cb10-2">cylinder_analysis <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mtcars_enhanced <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(cyl) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb10-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb10-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_mpg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(mpg),</span>
<span id="cb10-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_weight =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(wt),</span>
<span id="cb10-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_horsepower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(hp),</span>
<span id="cb10-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_efficiency_ratio =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(efficiency_ratio),</span>
<span id="cb10-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_power_to_weight =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(power_to_weight)</span>
<span id="cb10-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(cyl)</span>
<span id="cb10-13"></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the results</span></span>
<span id="cb10-15">cylinder_analysis</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
    cyl count avg_mpg avg_weight avg_horsepower avg_efficiency_ratio
  &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;                &lt;dbl&gt;
1     4    11    26.7       2.29           82.6                12.7 
2     6     7    19.7       3.12          122.                  6.44
3     8    14    15.1       4.00          209.                  3.95
# ℹ 1 more variable: avg_power_to_weight &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Question 2: Which transmission type is more fuel efficient?</span></span>
<span id="cb12-2">transmission_efficiency <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mtcars_enhanced <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># am: 0 = automatic, 1 = manual</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">transmission =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(am <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Manual"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Automatic"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(transmission) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb12-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb12-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_mpg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(mpg),</span>
<span id="cb12-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median_mpg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(mpg),</span>
<span id="cb12-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mpg_std_dev =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(mpg)</span>
<span id="cb12-11">  )</span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the results</span></span>
<span id="cb12-14">transmission_efficiency</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  transmission count avg_mpg median_mpg mpg_std_dev
  &lt;chr&gt;        &lt;int&gt;   &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;
1 Automatic       19    17.1       17.3        3.83
2 Manual          13    24.4       22.8        6.17</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize the difference</span></span>
<span id="cb14-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mtcars, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(am, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Automatic"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Manual"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mpg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(am))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fuel Efficiency by Transmission Type"</span>,</span>
<span id="cb14-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transmission Type"</span>,</span>
<span id="cb14-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miles Per Gallon"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/business-analysis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="correlation-analysis-for-decision-making" class="level2">
<h2 class="anchored" data-anchor-id="correlation-analysis-for-decision-making">Correlation Analysis for Decision Making</h2>
<p>Understanding relationships between variables is crucial for business decisions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate correlations</span></span>
<span id="cb15-2">cor_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(mtcars[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"disp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qsec"</span>)])</span>
<span id="cb15-3">cor_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(cor_matrix, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display correlation matrix</span></span>
<span id="cb15-6">cor_df</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       mpg    wt    hp  disp  qsec
mpg   1.00 -0.87 -0.78 -0.85  0.42
wt   -0.87  1.00  0.66  0.89 -0.17
hp   -0.78  0.66  1.00  0.79 -0.71
disp -0.85  0.89  0.79  1.00 -0.43
qsec  0.42 -0.17 -0.71 -0.43  1.00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize correlations (requires the corrplot package)</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(corrplot)</span>
<span id="cb17-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">corrplot</span>(cor_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"circle"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"upper"</span>, </span>
<span id="cb17-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tl.col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tl.srt =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">addCoef.col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/correlation-analysis-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scatter plot matrix of key variables</span></span>
<span id="cb18-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(mtcars[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"disp"</span>)], </span>
<span id="cb18-3">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scatter Plot Matrix of Key Variables"</span>,</span>
<span id="cb18-4">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bg =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/correlation-analysis-2.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="working-with-real-world-datasets" class="level2">
<h2 class="anchored" data-anchor-id="working-with-real-world-datasets">Working with Real-World Datasets</h2>
<p>The famous Iris dataset demonstrates a complete workflow:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load packages</span></span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb19-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb19-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Examine the dataset</span></span>
<span id="cb19-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(iris)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Sepal.Length Sepal.Width Petal.Length Petal.Width Species
1          5.1         3.5          1.4         0.2  setosa
2          4.9         3.0          1.4         0.2  setosa
3          4.7         3.2          1.3         0.2  setosa
4          4.6         3.1          1.5         0.2  setosa
5          5.0         3.6          1.4         0.2  setosa
6          5.4         3.9          1.7         0.4  setosa</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(iris)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   150 obs. of  5 variables:
 $ Sepal.Length: num  5.1 4.9 4.7 4.6 5 5.4 4.6 5 4.4 4.9 ...
 $ Sepal.Width : num  3.5 3 3.2 3.1 3.6 3.9 3.4 3.4 2.9 3.1 ...
 $ Petal.Length: num  1.4 1.4 1.3 1.5 1.4 1.7 1.4 1.5 1.4 1.5 ...
 $ Petal.Width : num  0.2 0.2 0.2 0.2 0.2 0.4 0.3 0.2 0.2 0.1 ...
 $ Species     : Factor w/ 3 levels "setosa","versicolor",..: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate summary statistics by species</span></span>
<span id="cb23-2">iris_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iris <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(Species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric), </span>
<span id="cb23-5">                   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> mean, </span>
<span id="cb23-6">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">median =</span> median,</span>
<span id="cb23-7">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> sd,</span>
<span id="cb23-8">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> min,</span>
<span id="cb23-9">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> max)))</span>
<span id="cb23-10"></span>
<span id="cb23-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># View summary for Sepal.Length</span></span>
<span id="cb23-12">iris_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(Species, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sepal.Length"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  Species Sepal.Length_mean Sepal.Length_median Sepal.Length_sd Sepal.Length_min
  &lt;fct&gt;               &lt;dbl&gt;               &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;
1 setosa               5.01                 5             0.352              4.3
2 versic…              5.94                 5.9           0.516              4.9
3 virgin…              6.59                 6.5           0.636              4.9
# ℹ 1 more variable: Sepal.Length_max &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a visualization comparing all measurements across species</span></span>
<span id="cb25-2">iris_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iris <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb25-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb25-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Species,</span>
<span id="cb25-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Measurement"</span>,</span>
<span id="cb25-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span></span>
<span id="cb25-7">  )</span>
<span id="cb25-8"></span>
<span id="cb25-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Box plots with data points</span></span>
<span id="cb25-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(iris_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> Species)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgrey"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Measurement, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Iris Measurements Across Species"</span>,</span>
<span id="cb25-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Box plots with individual observations"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/iris-analysis-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the most distinguishing features between species</span></span>
<span id="cb26-2">iris_wide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iris <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Measurement"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(Measurement, Species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean_value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(Value), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> Species, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> mean_value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">versicolor_vs_setosa =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(versicolor <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> setosa),</span>
<span id="cb26-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">virginica_vs_setosa =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(virginica <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> setosa),</span>
<span id="cb26-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">virginica_vs_versicolor =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(virginica <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> versicolor),</span>
<span id="cb26-10">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_difference =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(versicolor_vs_setosa, virginica_vs_setosa, virginica_vs_versicolor))</span>
<span id="cb26-11"></span>
<span id="cb26-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the results ordered by maximum difference</span></span>
<span id="cb26-13">iris_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(max_difference))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
  Measurement  setosa versicolor virginica versicolor_vs_setosa
  &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;                &lt;dbl&gt;
1 Petal.Length  1.46        4.26      5.55                2.80 
2 Petal.Width   0.246       1.33      2.03                1.08 
3 Sepal.Length  5.01        5.94      6.59                0.93 
4 Sepal.Width   3.43        2.77      2.97                0.658
# ℹ 3 more variables: virginica_vs_setosa &lt;dbl&gt;, virginica_vs_versicolor &lt;dbl&gt;,
#   max_difference &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="handling-missing-data" class="level2">
<h2 class="anchored" data-anchor-id="handling-missing-data">Handling Missing Data</h2>
<p>Missing data is a common challenge. This practical example demonstrates handling techniques:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simulated customer dataset with missing values</span></span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For reproducibility</span></span>
<span id="cb28-3"></span>
<span id="cb28-4">customers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb28-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">customer_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb28-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb28-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">income =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15000</span>)),</span>
<span id="cb28-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">years_as_customer =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb28-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">purchase_frequency =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb28-10">)</span>
<span id="cb28-11"></span>
<span id="cb28-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Introduce missing values randomly</span></span>
<span id="cb28-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">456</span>)</span>
<span id="cb28-14">customers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb28-15">customers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>income[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb28-16">customers<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>purchase_frequency[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb28-17"></span>
<span id="cb28-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Identify missing data</span></span>
<span id="cb28-19">missing_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(customers, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x)))</span>
<span id="cb28-20">missing_summary</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       customer_id                age             income  years_as_customer 
                 0                 10                 15                  0 
purchase_frequency 
                 5 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Visualize the pattern of missing data</span></span>
<span id="cb30-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(naniar) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># May need to install this package</span></span>
<span id="cb30-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vis_miss</span>(customers)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/missing-data-analysis-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. Handle missing data with multiple approaches</span></span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Option A: Remove rows with any missing values</span></span>
<span id="cb31-4">clean_customers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(customers)</span>
<span id="cb31-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(customers) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(clean_customers) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of rows removed</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Option B: Impute with mean/median (numeric variables only)</span></span>
<span id="cb33-2">imputed_customers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> customers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb33-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(age), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(age, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), age),</span>
<span id="cb33-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">income =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(income), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(income, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), income),</span>
<span id="cb33-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">purchase_frequency =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(purchase_frequency), </span>
<span id="cb33-7">                               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(purchase_frequency, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), </span>
<span id="cb33-8">                               purchase_frequency)</span>
<span id="cb33-9">  )</span>
<span id="cb33-10"></span>
<span id="cb33-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Option C: Predictive imputation (using age to predict income)</span></span>
<span id="cb33-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mice) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For more sophisticated imputation</span></span>
<span id="cb33-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quick imputation model - in practice more parameters would be used</span></span>
<span id="cb33-14">imputed_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mice</span>(customers, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pmm"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">printFlag =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb33-15">customers_complete <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">complete</span>(imputed_data)</span>
<span id="cb33-16"></span>
<span id="cb33-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare results by calculating customer value score</span></span>
<span id="cb33-18">calculate_value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df) {</span>
<span id="cb33-19">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">customer_value =</span> (income<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (purchase_frequency<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(years_as_customer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(customer_value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb33-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(customer_id, customer_value, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>())</span>
<span id="cb33-23">}</span>
<span id="cb33-24"></span>
<span id="cb33-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Top 5 customers by value (original with NAs removed)</span></span>
<span id="cb33-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_value</span>(clean_customers), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  customer_id customer_value age income years_as_customer purchase_frequency
1           7       24.63960  67  82249                19                 10
2          54       15.73965  22  70961                15                  8
3          59       15.67045  50  70649                15                  8
4          84       15.09251  21  55732                14                 10
5          72       14.27848  23  61853                12                  9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Top 5 customers by value (with imputed values)</span></span>
<span id="cb35-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_value</span>(customers_complete), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  customer_id customer_value age income years_as_customer purchase_frequency
1           7       24.63960  67  82249                19                 10
2          54       15.73965  22  70961                15                  8
3          59       15.67045  50  70649                15                  8
4          84       15.09251  21  55732                14                 10
5          72       14.27848  23  61853                12                  9</code></pre>
</div>
</div>
</section>
<section id="time-series-analysis-for-business-trends" class="level2">
<h2 class="anchored" data-anchor-id="time-series-analysis-for-business-trends">Time Series Analysis for Business Trends</h2>
<p>Time series analysis is essential for understanding business trends and forecasting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load packages</span></span>
<span id="cb37-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(forecast)</span>
<span id="cb37-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tseries)</span>
<span id="cb37-4"></span>
<span id="cb37-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Examine the built-in AirPassengers dataset (monthly air passengers from 1949 to 1960)</span></span>
<span id="cb37-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(AirPassengers)</span>
<span id="cb37-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(AirPassengers)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ts"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the time series</span></span>
<span id="cb39-2">autoplots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">autoplot</span>(AirPassengers) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monthly Air Passengers (1949-1960)"</span>,</span>
<span id="cb39-4">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passenger Count"</span>,</span>
<span id="cb39-5">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Year"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb39-7"></span>
<span id="cb39-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Decompose the time series into seasonal components</span></span>
<span id="cb39-9">decomposed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decompose</span>(AirPassengers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"multiplicative"</span>)</span>
<span id="cb39-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">autoplot</span>(decomposed) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Decomposition of Air Passengers Time Series"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/time-series-analysis-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forecasting future values using auto.arima</span></span>
<span id="cb40-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">auto.arima</span>(AirPassengers)</span>
<span id="cb40-3">forecasts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">forecast</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Forecast 2 years ahead</span></span>
<span id="cb40-4"></span>
<span id="cb40-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the forecasts</span></span>
<span id="cb40-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(forecasts, </span>
<span id="cb40-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Air Passengers Forecast (24 months)"</span>,</span>
<span id="cb40-8">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Year"</span>, </span>
<span id="cb40-9">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Passenger Count"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/intro-to-r-analytics_files/figure-html/time-series-analysis-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summary of the forecast model</span></span>
<span id="cb41-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: AirPassengers 
ARIMA(2,1,1)(0,1,0)[12] 

Coefficients:
         ar1     ar2      ma1
      0.5960  0.2143  -0.9819
s.e.  0.0888  0.0880   0.0292

sigma^2 = 132.3:  log likelihood = -504.92
AIC=1017.85   AICc=1018.17   BIC=1029.35

Training set error measures:
                 ME     RMSE     MAE      MPE     MAPE     MASE        ACF1
Training set 1.3423 10.84619 7.86754 0.420698 2.800458 0.245628 -0.00124847</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>Analytics</category>
  <category>Introduction</category>
  <guid>https://rtichoke.netlify.app/posts/intro-to-r-analytics.html</guid>
  <pubDate>Tue, 21 Mar 2023 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/r-logo.png" medium="image" type="image/png" height="112" width="144"/>
</item>
<item>
  <title>Monotonic Binning Using XGBoost</title>
  <link>https://rtichoke.netlify.app/posts/monotonic-binning-using-xgboost.html</link>
  <description><![CDATA[ 




<p>This post focuses on how to implement monotonic binning, a method that groups variable values into bins where event rates demonstrate consistent monotonic behavior. This methodology is essential in credit risk modeling, providing significant advantages in two critical areas:</p>
<ol type="1">
<li><strong>Enhanced Model Stability</strong>: Monotonic relationships strengthen model robustness by reducing overfitting and ensuring reliable performance in production environments</li>
<li><strong>Improved Interpretability</strong>: Monotonic constraints facilitate clear explanations by maintaining logical, consistent relationships between predictors and outcomes</li>
</ol>
<section id="prerequisites-and-required-libraries" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites-and-required-libraries">Prerequisites and Required Libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recipes)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For data preprocessing</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For data manipulation</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(xgboost)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For creating monotonic bins</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For visualization</span></span></code></pre></div>
</div>
</section>
<section id="dataset-overview-and-loading" class="level2">
<h2 class="anchored" data-anchor-id="dataset-overview-and-loading">Dataset Overview and Loading</h2>
<p>This tutorial demonstrates the methodology using a sample from the Lending Club dataset, which provides comprehensive loan information including default indicators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load sample data from Lending Club dataset</span></span>
<span id="cb2-2">sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://bit.ly/42ypcnJ"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check dimensions of the dataset</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sample)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000   153</code></pre>
</div>
</div>
</section>
<section id="creating-a-binary-target-variable" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-binary-target-variable">Creating a Binary Target Variable</h2>
<p>The first step involves constructing a binary target variable that clearly identifies loan defaults. This variable will serve as our outcome throughout the binning process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define loan statuses that represent defaults</span></span>
<span id="cb4-2">codes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charged Off"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Does not meet the credit policy. Status:Charged Off"</span>)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create binary target variable</span></span>
<span id="cb4-5">model_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sample <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bad_flag =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(loan_status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> codes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span></code></pre></div>
</div>
</section>
<section id="data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing">Data Preprocessing</h2>
<p>Before proceeding, the dataset must be prepared through systematic preprocessing. This step ensures data quality and compatibility with the XGBoost implementation. The process utilizes the <code>recipes</code> package to:</p>
<ol type="1">
<li>Filter and retain only numeric variables for analysis</li>
<li>Apply median imputation to handle missing values appropriately</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a recipe for preprocessing</span></span>
<span id="cb5-2">rec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(bad_flag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> model_data) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Keep only numeric variables</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_impute_median</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_predictors</span>())  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fill missing values with medians</span></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the preprocessing steps</span></span>
<span id="cb5-7">rec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span>(rec, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">training =</span> model_data)</span>
<span id="cb5-8">train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span>(rec, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new_data =</span> model_data)</span></code></pre></div>
</div>
</section>
<section id="step-3-exploratory-analysis-of-variable-relationships" class="level2">
<h2 class="anchored" data-anchor-id="step-3-exploratory-analysis-of-variable-relationships">Step 3: Exploratory Analysis of Variable Relationships</h2>
<p>It is crucial to examine the raw relationship between predictor variables and the target outcome. This analysis provides insights into underlying data patterns and validates the need for monotonic transformation.</p>
<p>This example analyzes the relationship between credit inquiries in the past 6 months and default rates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create dataframe with inquiries and default flag</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> model_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>inq_last_6mths,</span>
<span id="cb6-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> model_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bad_flag) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Focus on 0-5 inquiries for clarity</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count observations in each group</span></span>
<span id="cb6-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(y)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count defaults in each group</span></span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pct =</span> events<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>count) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate default rate</span></span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> pct)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of inquiries in past 6 months"</span>, </span>
<span id="cb6-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default rate"</span>,</span>
<span id="cb6-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default rate vs number of inquiries"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/monotonic-binning-using-xgboost_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While the data exhibits a general upward trend (indicating that increased inquiries correlate with higher default rates), the relationship lacks perfect monotonicity. This validates the necessity of the monotonic binning approach to establish consistent patterns.</p>
</section>
<section id="implementing-monotonic-binning-with-xgboost" class="level2">
<h2 class="anchored" data-anchor-id="implementing-monotonic-binning-with-xgboost">Implementing Monotonic Binning with XGBoost</h2>
<p>The implementation uses XGBoost’s monotonicity constraints which enforces the model to generate splits that preserve a monotonic relationship with the target variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train XGBoost model with monotonicity constraint</span></span>
<span id="cb7-2">mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgboost</span>(</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(inq_last_6mths) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use only the inquiries variable</span></span>
<span id="cb7-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(),  </span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> train[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bad_flag"</span>]],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Target variable</span></span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrounds =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of boosting rounds</span></span>
<span id="cb7-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">booster =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gbtree"</span>,</span>
<span id="cb7-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">objective =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary:logistic"</span>,</span>
<span id="cb7-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">monotone_constraints =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Force positive relationship</span></span>
<span id="cb7-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple trees with single splits</span></span>
<span id="cb7-13">  ),</span>
<span id="cb7-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Suppress output</span></span>
<span id="cb7-15">)</span></code></pre></div>
</div>
</section>
<section id="extracting-split-points-and-constructing-final-bins" class="level2">
<h2 class="anchored" data-anchor-id="extracting-split-points-and-constructing-final-bins">Extracting Split Points and Constructing Final Bins</h2>
<p>Following model training, the process extracts the optimal split points identified by XGBoost and utilizes them to construct the final bin structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract split points from the model</span></span>
<span id="cb8-2">splits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgb.model.dt.tree</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> mdl)  </span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create bin boundaries including -Inf and Inf for complete coverage</span></span>
<span id="cb8-5">cuts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(splits<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Split)), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create and visualize the monotonic bins</span></span>
<span id="cb8-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> train<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bad_flag,</span>
<span id="cb8-9">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">buckets =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(train<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>inq_last_6mths, </span>
<span id="cb8-10">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> cuts, </span>
<span id="cb8-11">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.lowest =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb8-12">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(buckets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count observations in each bin</span></span>
<span id="cb8-15">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count defaults in each bin</span></span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pct =</span> events<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate default rate</span></span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> buckets, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> pct)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bins"</span>, </span>
<span id="cb8-21">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default rate"</span>,</span>
<span id="cb8-22">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monotonic Bins for Inquiries"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rtichoke.netlify.app/posts/monotonic-binning-using-xgboost_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The default rates now demonstrate perfect monotonic behavior across all bins, creating a clearer and more interpretable relationship compared to the raw data.</p>
</section>
<section id="generalised-function" class="level2">
<h2 class="anchored" data-anchor-id="generalised-function">Generalised Function</h2>
<p>To enable implementation across multiple variables, a reusable function that encapsulates the entire monotonic binning workflow would be very useful here. <strong>Note</strong> the use of ranked correlation to identify the appropriate direction to be used inside the Xgboost call.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">create_bins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(var, outcome, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>){</span>
<span id="cb9-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Determine relationship direction automatically</span></span>
<span id="cb9-3">  corr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(var, outcome, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spearman"</span>)</span>
<span id="cb9-4">  direction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(corr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 for positive, -1 for negative correlation</span></span>
<span id="cb9-5">  </span>
<span id="cb9-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build XGBoost model with appropriate monotonicity constraint</span></span>
<span id="cb9-7">  mdl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgboost</span>(</span>
<span id="cb9-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb9-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(var),</span>
<span id="cb9-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> outcome,</span>
<span id="cb9-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrounds =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Single round is sufficient for binning</span></span>
<span id="cb9-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">objective =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary:logistic"</span>,</span>
<span id="cb9-13">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">monotone_constraints =</span> direction,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply constraint based on correlation</span></span>
<span id="cb9-14">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> max_depth))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Control tree complexity</span></span>
<span id="cb9-15">  </span>
<span id="cb9-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract and return split points</span></span>
<span id="cb9-17">  splits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xgb.model.dt.tree</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> mdl)</span>
<span id="cb9-18">  cuts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(splits<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Split)), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Include boundaries for complete coverage</span></span>
<span id="cb9-19">  </span>
<span id="cb9-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally visualize the bins</span></span>
<span id="cb9-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(plot) {</span>
<span id="cb9-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> outcome,</span>
<span id="cb9-23">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">buckets =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(var, </span>
<span id="cb9-24">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> cuts, </span>
<span id="cb9-25">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.lowest =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb9-26">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-27">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(buckets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-28">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb9-29">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">events =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-30">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pct =</span> events<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-31">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> buckets, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> pct)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-32">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-33">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-34">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bins"</span>, </span>
<span id="cb9-35">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Default rate"</span>,</span>
<span id="cb9-36">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monotonic Bins"</span>)</span>
<span id="cb9-37">  }</span>
<span id="cb9-38">  </span>
<span id="cb9-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(cuts)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the bin boundaries</span></span>
<span id="cb9-40">}</span>
<span id="cb9-41"></span>
<span id="cb9-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example: Create monotonic bins for annual income</span></span>
<span id="cb9-43">income_bins <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_bins</span>(</span>
<span id="cb9-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> train<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>annual_inc,</span>
<span id="cb9-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">outcome =</span> train<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bad_flag,</span>
<span id="cb9-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_depth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb9-47">)</span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>Credit Risk Analytics</category>
  <category>XGBoost</category>
  <guid>https://rtichoke.netlify.app/posts/monotonic-binning-using-xgboost.html</guid>
  <pubDate>Wed, 18 Jan 2023 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/monotonic.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>Getting Started with Python using R and Reticulate</title>
  <link>https://rtichoke.netlify.app/posts/getting-started-with-reticulate.html</link>
  <description><![CDATA[ 




<p>Want to use Python’s powerful libraries without leaving R? The reticulate package gives you the best of both worlds - R’s elegant data handling and visualization with Python’s machine learning and scientific computing tools. This post dives into how to set up a python environment using RStudio and the <code>reticulate</code> package and use this powerful bridge between languages. Here’s a quick 4-step process to get started.</p>
<section id="install-reticulate" class="level2">
<h2 class="anchored" data-anchor-id="install-reticulate">Install reticulate</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reticulate"</span>)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(reticulate)</span></code></pre></div>
</div>
</section>
<section id="install-python-via-miniconda" class="level2">
<h2 class="anchored" data-anchor-id="install-python-via-miniconda">Install Python via Miniconda</h2>
<p>The easiest approach is to let reticulate handle Python installation for you:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_miniconda</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c:/miniconda"</span>)</span></code></pre></div>
</div>
</section>
<section id="connect-to-python" class="level2">
<h2 class="anchored" data-anchor-id="connect-to-python">Connect to Python</h2>
<p>Reticulate creates a default environment called <code>r-reticulate</code>. Let’s connect to it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check available environments</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conda_list</span>()</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Connect to the default environment</span></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">use_condaenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r-reticulate"</span>)</span></code></pre></div>
</div>
</section>
<section id="install-python-packages" class="level2">
<h2 class="anchored" data-anchor-id="install-python-packages">Install Python Packages</h2>
<p>Now you can install any Python packages you need:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">py_install</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pandas"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scikit-learn"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matplotlib"</span>))</span></code></pre></div>
</div>
</section>
<section id="different-ways-to-use-python-in-r" class="level2">
<h2 class="anchored" data-anchor-id="different-ways-to-use-python-in-r">Different Ways to Use Python in R</h2>
<section id="import-python-modules-directly" class="level3">
<h3 class="anchored" data-anchor-id="import-python-modules-directly">1. Import Python Modules Directly</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import pandas and use it like any R package</span></span>
<span id="cb5-2">pd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pandas"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a pandas Series</span></span>
<span id="cb5-5">pd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Series</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import numpy for numerical operations</span></span>
<span id="cb5-8">np <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpy"</span>)</span>
<span id="cb5-9">np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate mean using numpy</span></span></code></pre></div>
</div>
</section>
<section id="write-python-code-in-r-markdown" class="level3">
<h3 class="anchored" data-anchor-id="write-python-code-in-r-markdown">2. Write Python Code in R Markdown</h3>
<p>You can mix R and Python code in the same document by using Python code chunks:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is Python code!</span></span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a simple DataFrame</span></span>
<span id="cb6-6">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb6-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>: np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb6-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B'</span>: np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb6-9">})</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(df.describe())</span></code></pre></div>
</div>
</section>
<section id="use-python-libraries-in-r-workflows" class="level3">
<h3 class="anchored" data-anchor-id="use-python-libraries-in-r-workflows">3. Use Python Libraries in R Workflows</h3>
<p>The most powerful approach is using Python’s machine learning libraries within R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import scikit-learn</span></span>
<span id="cb7-2">sk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sklearn.linear_model"</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create and fit a linear regression model</span></span>
<span id="cb7-5">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sk<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinearRegression</span>()</span>
<span id="cb7-6">model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(mtcars[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"disp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>)]), </span>
<span id="cb7-7">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mtcars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mpg)</span>
<span id="cb7-8"></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get predictions and coefficients</span></span>
<span id="cb7-10">predictions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(mtcars[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"disp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>)]))</span>
<span id="cb7-11">coefficients <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb7-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Feature =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"disp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>),</span>
<span id="cb7-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Coefficient =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>intercept_, model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coef_)</span>
<span id="cb7-14">)</span>
<span id="cb7-15"></span>
<span id="cb7-16">coefficients</span></code></pre></div>
</div>
</section>
</section>
<section id="real-world-applications" class="level2">
<h2 class="anchored" data-anchor-id="real-world-applications">Real-World Applications</h2>
<p>Here are some ways to combine R and Python in your data science workflow:</p>
<section id="data-science-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="data-science-pipeline">Data Science Pipeline</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Data cleaning with R's tidyverse</span></span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)</span>
<span id="cb8-3">clean_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.csv"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(important_column)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">new_feature =</span> feature1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> feature2)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Machine learning with Python's scikit-learn</span></span>
<span id="cb8-8">sk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sklearn.ensemble"</span>)</span>
<span id="cb8-9">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sk<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RandomForestClassifier</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_estimators=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb8-10">model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(clean_data[, features]), </span>
<span id="cb8-11">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> clean_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target)</span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. Visualization with R's ggplot2</span></span>
<span id="cb8-14">predictions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict_proba</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(clean_data[, features]))[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb8-15">clean_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prediction =</span> predictions) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>feature1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>feature2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>prediction)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_viridis_c</span>()</span></code></pre></div>
</div>
</section>
<section id="the-choice-between-r-and-python" class="level3">
<h3 class="anchored" data-anchor-id="the-choice-between-r-and-python">The Choice Between <code>R</code> and <code>Python</code></h3>
<p><strong>Use R for:</strong></p>
<ul>
<li>Data manipulation with dplyr/data.table</li>
<li>Statistical modeling and hypothesis testing</li>
<li>Publication-quality visualization</li>
<li>Interactive reports and dashboards</li>
</ul>
<p><strong>Use Python for:</strong></p>
<ul>
<li>Deep learning with TensorFlow/PyTorch</li>
<li>Natural language processing</li>
<li>Computer vision</li>
<li>Advanced machine learning algorithms</li>
</ul>
<p>However, with reticulate, you don’t have to choose! Use the best tool for each part of your analysis!</p>


</section>
</section>

 ]]></description>
  <category>R</category>
  <category>Python</category>
  <category>reticulate</category>
  <guid>https://rtichoke.netlify.app/posts/getting-started-with-reticulate.html</guid>
  <pubDate>Sat, 14 Jan 2023 18:30:00 GMT</pubDate>
  <media:content url="https://rtichoke.netlify.app/images/reticulate.png" medium="image" type="image/png" height="168" width="144"/>
</item>
</channel>
</rss>
